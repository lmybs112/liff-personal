<!doctype html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Personalized Page</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@100;300;400;500;700;900&family=Figtree:wght@300;400;500;600;700;800;900&display=swap"
      rel="stylesheet"
    />
    <!-- LIFF SDK -->
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
      * {
        font-family: 'Noto Sans TC', 'sans-serif';
        padding: 0;
        margin: 0;
        box-sizing: border-box;
      }

      a {
        text-decoration: none !important;
      }

      body {
        opacity: 0;
        /* 初始透明度為 0 */
        animation: pageFadeIn 1s ease-in forwards;
        /* 應用淡入動畫 */
      }

      @keyframes pageFadeIn {
        from {
          opacity: 0;
        }

        to {
          opacity: 1;
        }
      }

      #personalized-page {
        background-color: #fff;
        position: relative;
        width: 100vw;
        min-height: 100vh;
      }

      #inf_iframe_personalized_page {
        background-color: #f6f6f6;
      }

      .mobile-cta-section {
        padding: 48px 24px 64px 24px;
      }

      .mobile-cta-section .cta-section-container {
        height: 100%;
        width: 100%;
        margin: 0 auto;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 0px;
        gap: 14px;
        align-self: stretch;
      }

      .mobile-cta-section .cta-section-container .cta-text p {
        color: #000;
        text-align: center;

        /* Medium&SmallSubtitle/CH/Bold */
        font-family: 'Noto Sans TC', 'Figtree';
        font-size: 32px;
        font-style: normal;
        font-weight: 700;
        line-height: 39px;
        /* 121.875% */
        letter-spacing: 0.64px;
      }

      .mobile-cta-section .cta-section-container .cta-text p br {
        display: none;
      }

      .mobile-cta-section .cta-section-container .cta-coupon p {
        color: #000;
        text-align: center;

        /* Medium&SmallSubtitle/CH/Bold */
        font-family: 'Noto Sans TC', 'Figtree';
        font-size: 32px;
        font-style: normal;
        font-weight: 700;
        line-height: 39px;
        /* 121.875% */
        letter-spacing: 0.64px;
      }

      .mobile-cta-section .cta-section-container .cta-coupon span {
        color: rgba(0, 0, 0, 0.95);
        font-family: Figtree;
        font-size: 24px;
        font-style: normal;
        font-weight: 400;
        line-height: 26px;
        /* 108.333% */
        letter-spacing: -0.48px;
      }

      .mobile-cta-section .cta-section-container .coupon-copy {
        display: none;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }

      .mobile-cta-section .cta-section-container .copy-btn {
        width: 24px;
        height: 24px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0;
        border: none;
        background: none;
        cursor: pointer;
      }

      @media screen and (min-width: 768px) {
        .mobile-cta-section {
          display: none;
        }
      }
      .tryon_section {
        display: flex;
        padding: 48px 0px;
        gap: 64px;
        flex-direction: column;
        align-items: center;
        width: 100%;
      }
      .tryon_section .text-section {
        display: none;
      }
      @media screen and (min-width: 768px) {
        .tryon_section {
          padding: 100px 80px;
          gap: 64px;
        }
        .tryon_section .text-section {
          display: flex;
          flex-direction: column;
          justify-content: center;
          align-items: center;
          width: 100%;
          gap: 24px;
        }
        .tryon_section .text-section h2 {
          color: #1e1e19;
          text-align: center;
          font-size: 51px;
          line-height: 56px;
          letter-spacing: 1.02px;
        }
        .tryon_section .text-section p {
          color: #787974;
          text-align: center;
          font-size: 28px;
          font-weight: 400;
          line-height: 33px;
          letter-spacing: -0.56px;
        }
      }

      .tryon-showcase {
        width: 100%;
        display: flex;
        flex-direction: column;
        gap: 32px;
        padding: 0 24px;
      }

      .tryon-showcase__body {
        display: flex;
        flex-direction: column;
        gap: 32px;
        width: 100%;
      }

      .tryon-showcase__iframe {
        width: 100%;
        display: flex;
        justify-content: center;
      }

      .tryon-showcase__side-panel {
        width: 100%;
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .tryon-qr {
        border-radius: 28px;
        border: 1px solid #efefef;
        background: #fdfcf7;
        padding: 24px;
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .tryon-qr__header {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .tryon-qr__badge {
        align-self: flex-start;
        border-radius: 999px;
        border: 1px solid rgba(0, 0, 0, 0.08);
        background: #f1e9dd;
        padding: 6px 14px;
        color: #4a341f;
        font-size: 14px;
        letter-spacing: 0.02em;
      }

      .tryon-qr__hint {
        color: #787974;
        font-size: 14px;
        line-height: 20px;
        letter-spacing: 0.05em;
      }

      .tryon-qr__body {
        display: flex;
        gap: 16px;
        align-items: center;
      }

      .tryon-qr__image {
        width: 144px;
        height: 144px;
        border-radius: 20px;
        background: #fff;
        padding: 8px;
        border: 1px solid rgba(0, 0, 0, 0.04);
        object-fit: contain;
      }

      .tryon-qr__meta {
        display: flex;
        flex-direction: column;
        gap: 8px;
        flex: 1;
      }

      .tryon-qr__name {
        color: #1e1e19;
        font-size: 18px;
        line-height: 24px;
        font-weight: 600;
      }

      .tryon-qr__sku {
        color: #787974;
        font-size: 14px;
      }

      .tryon-qr__cta {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 10px 18px;
        border-radius: 999px;
        border: 1px solid #1e1e19;
        color: #1e1e19;
        font-size: 14px;
        font-weight: 600;
        transition: background 0.3s ease, color 0.3s ease;
      }

      .tryon-qr__cta:hover {
        background: #1e1e19;
        color: #fff;
      }

      .tryon-qr__cta--disabled {
        opacity: 0.5;
        pointer-events: none;
      }

      .tryon-carousel {
        border-radius: 24px !important;
        overflow: hidden;
        background: #fff;
        display: flex;
        flex-direction: column;
      }

      .tryon-carousel__header {
        display: none;
      }

      .tryon-carousel__title {
        display: none;
      }

      .tryon-carousel__status {
        display: none;
      }

      .tryon-carousel__viewport {
        position: relative;
        width: 100%;
        padding-top: 100%;
        overflow: hidden;
        background: #f5f5f5;
        touch-action: pan-x;
        cursor: grab;
        user-select: none;
      }

      .tryon-carousel__viewport:active {
        cursor: grabbing;
      }

      .tryon-carousel__track {
        list-style: none;
        padding: 0;
        margin: 0;
        position: absolute;
        inset: 0;
      }

      .tryon-carousel__slide {
        position: absolute;
        inset: 0;
        opacity: 0;
        transition: opacity 0.35s cubic-bezier(0.33, 1, 0.68, 1), transform 0.35s cubic-bezier(0.33, 1, 0.68, 1);
        overflow: hidden;
        will-change: transform, opacity;
        backface-visibility: hidden;
        -webkit-backface-visibility: hidden;
      }

      .tryon-carousel__viewport--dragging .tryon-carousel__slide {
        transition: none;
      }

      .tryon-carousel__slide img {
        width: 100%;
        height: 100%;
        object-fit: contain;
        display: block;
      }

      .tryon-carousel__slide--active {
        opacity: 1;
      }

      .tryon-carousel__controls {
        display: none;
      }

      .tryon-carousel__btn {
        display: none;
      }

      .tryon-carousel__loading,
      .tryon-carousel__empty {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #787974;
        font-size: 14px;
        padding: 12px;
        text-align: center;
      }

      .tryon-scroll-gallery {
        border-radius: 24px;
        background: #fff;
        padding: 24px;
        display: flex;
        flex-direction: column;
        gap: 12px;
        width: 100%;
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.08);
        align-items: stretch;
      }

      .tryon-scroll-gallery__cta {
        width: 100%;
        border-radius: 999px;
        border: none;
        background: linear-gradient(140deg, #1b1b1b, #040404 60%, #1b1b1b);
        color: #fff;
        font-size: 16px;
        font-weight: 600;
        padding: 14px 64px 14px 24px;
        cursor: pointer;
        transition: transform 0.35s cubic-bezier(0.22, 1, 0.36, 1), box-shadow 0.35s ease, background 0.35s ease;
        display: inline-flex;
        align-items: center;
        justify-content: flex-start;
        position: relative;
        overflow: hidden;
        isolation: isolate;
        box-shadow: 0 18px 36px rgba(0, 0, 0, 0.4);
      }

      .tryon-scroll-gallery__cta::before {
        content: '';
        position: absolute;
        inset: 3px;
        border-radius: inherit;
        background: radial-gradient(circle at 20% 20%, rgba(255, 255, 255, 0.22), transparent 55%);
        opacity: 0;
        transition: opacity 0.3s ease;
        z-index: 0;
      }

      .tryon-scroll-gallery__cta::after {
        content: '→';
        font-size: 18px;
        width: 38px;
        height: 38px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.15);
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        z-index: 1;
        position: absolute;
        right: 16px;
        top: 50%;
        transform: translateY(-50%);
        transition: transform 0.35s cubic-bezier(0.22, 1, 0.36, 1), background 0.35s ease, color 0.35s ease;
      }

      .tryon-scroll-gallery__cta-label {
        position: relative;
        z-index: 1;
        display: inline-flex;
        align-items: center;
        letter-spacing: 0.02em;
      }

      .tryon-scroll-gallery__cta:hover,
      .tryon-scroll-gallery__cta:focus-visible {
        transform: translateY(-2px) scale(1.005);
        box-shadow: 0 24px 44px rgba(0, 0, 0, 0.5);
        background: linear-gradient(140deg, #101010, #000);
      }

      .tryon-scroll-gallery__cta:hover::before,
      .tryon-scroll-gallery__cta:focus-visible::before {
        opacity: 1;
      }

      .tryon-scroll-gallery__cta:hover::after,
      .tryon-scroll-gallery__cta:focus-visible::after {
        background: rgba(255, 255, 255, 0.2);
        color: #fff;
        transform: translateY(-50%) translateX(4px);
      }

      .tryon-scroll-gallery__cta--pulse::before {
        animation: tryonScrollCtaPulse 2.4s ease-in-out infinite;
      }

      .tryon-scroll-gallery__cta--pulse::after {
        animation: tryonScrollCtaArrow 1.8s ease-in-out infinite;
      }

      .tryon-scroll-gallery__cta:disabled {
        background: #b8b8b3;
        box-shadow: none;
        cursor: not-allowed;
      }

      .tryon-scroll-gallery__cta:disabled::before,
      .tryon-scroll-gallery__cta:disabled::after {
        display: none;
      }

      @keyframes tryonScrollCtaPulse {
        0% {
          opacity: 0.08;
          transform: scale(0.95);
        }
        50% {
          opacity: 0.24;
          transform: scale(1.04);
        }
        100% {
          opacity: 0.08;
          transform: scale(0.95);
        }
      }

      @keyframes tryonScrollCtaArrow {
        0% {
          transform: translateY(-50%) translateX(0);
        }
        50% {
          transform: translateY(-50%) translateX(4px);
        }
        100% {
          transform: translateY(-50%) translateX(0);
        }
      }

      .tryon-scroll-gallery__count {
        font-size: 13px;
        color: #787974;
        margin: 0;
        text-align: center;
      }

      .tryon-gallery-inline {
        display: none;
        flex-direction: column;
        gap: 16px;
        border-radius: 32px;
        background: #fff;
        padding: 24px;
        box-shadow: 0 30px 80px rgba(0, 0, 0, 0.08);
        max-height: 698px;
        height: 698px;
        width: 440px;
        max-width: 100%;
        overflow: hidden;
      }

      .tryon-gallery-inline--visible {
        display: flex;
      }

      .tryon-gallery-inline__header {
        display: flex;
        flex-direction: column;
        gap: 8px;
        position: sticky;
        top: 0;
        z-index: 2;
        background: #fff;
        padding-bottom: 8px;
        border-bottom: 1px solid rgba(30, 30, 25, 0.08);
      }

      .tryon-gallery-inline__title {
        margin: 0;
        font-size: 22px;
        font-weight: 700;
        color: #1e1e19;
      }

      .tryon-gallery-inline__summary {
        margin: 0;
        font-size: 15px;
        color: #787974;
      }

      .tryon-gallery-inline__content {
        display: flex;
        flex-direction: column;
        flex: 1;
        overflow-y: auto;
        padding-right: 6px;
        scrollbar-width: thin;
        scrollbar-color: rgba(120, 121, 116, 0.35) transparent;
      }

      .tryon-gallery-inline__content::-webkit-scrollbar {
        width: 8px;
      }

      .tryon-gallery-inline__content::-webkit-scrollbar-track {
        background: transparent;
        border-radius: 999px;
      }

      .tryon-gallery-inline__content::-webkit-scrollbar-thumb {
        background: rgba(120, 121, 116, 0.35);
        border-radius: 999px;
        border: 2px solid rgba(255, 255, 255, 0.6);
      }

      .tryon-gallery-inline__content::-webkit-scrollbar-thumb:hover {
        background: rgba(120, 121, 116, 0.55);
      }

      .tryon-gallery-inline__item {
        border-radius: 24px;
        background: #f7f6f1;
      }

      .tryon-gallery-inline__item img {
        width: 100%;
        display: block;
        height: auto;
      }

      .tryon-gallery-inline__empty {
        font-size: 16px;
        color: #5c5c58;
        text-align: center;
      }

      .tryon-gallery-modal {
        --tryon-modal-enter-duration: 420ms;
        --tryon-modal-exit-duration: 320ms;
        --tryon-modal-ease-in: cubic-bezier(0.16, 1, 0.3, 1);
        --tryon-modal-ease-out: cubic-bezier(0.7, 0, 0.84, 0);
        position: fixed;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        padding: 24px;
        z-index: 9999;
        opacity: 0;
        pointer-events: none;
        will-change: opacity;
        backface-visibility: hidden;
        -webkit-font-smoothing: antialiased;
      }

      .tryon-gallery-modal--open {
        display: flex;
      }

      .tryon-gallery-modal--visible {
        opacity: 1;
        pointer-events: auto;
      }

      .tryon-gallery-modal--closing {
        pointer-events: none;
      }

      .tryon-gallery-modal__overlay {
        position: absolute;
        inset: 0;
        background: rgba(0, 0, 0, 0.6);
        opacity: 0;
        will-change: opacity;
        transition:
          opacity var(--tryon-modal-enter-duration, 420ms) var(--tryon-modal-ease-in, cubic-bezier(0.16, 1, 0.3, 1));
      }

      .tryon-gallery-modal__dialog {
        position: relative;
        max-width: 960px;
        width: 100%;
        max-height: 90vh;
        overflow-y: auto;
        background: #fff;
        border-radius: 32px;
        padding: 0 32px 32px;
        display: flex;
        flex-direction: column;
        gap: 24px;
        box-shadow: 
          0 0 0 1px rgba(0, 0, 0, 0.04),
          0 8px 16px rgba(0, 0, 0, 0.08),
          0 24px 64px rgba(0, 0, 0, 0.16);
        scrollbar-width: thin;
        scrollbar-color: rgba(120, 121, 116, 0.4) transparent;
        opacity: 0;
        transform: translateY(32px) scale(0.94);
        will-change: opacity, transform;
        backface-visibility: hidden;
        transition:
          opacity var(--tryon-modal-enter-duration, 420ms) var(--tryon-modal-ease-in, cubic-bezier(0.16, 1, 0.3, 1)),
          transform var(--tryon-modal-enter-duration, 420ms) var(--tryon-modal-ease-in, cubic-bezier(0.16, 1, 0.3, 1));
      }

      .tryon-gallery-modal--visible .tryon-gallery-modal__overlay {
        opacity: 1;
      }

      .tryon-gallery-modal--visible .tryon-gallery-modal__dialog {
        opacity: 1;
        transform: translateY(0) scale(1);
      }

      .tryon-gallery-modal--closing .tryon-gallery-modal__overlay {
        transition-duration: var(--tryon-modal-exit-duration, 320ms);
        transition-timing-function: var(--tryon-modal-ease-out, cubic-bezier(0.7, 0, 0.84, 0));
      }

      .tryon-gallery-modal--closing .tryon-gallery-modal__dialog {
        transition-duration: var(--tryon-modal-exit-duration, 320ms);
        transition-timing-function: var(--tryon-modal-ease-out, cubic-bezier(0.7, 0, 0.84, 0));
        transform: translateY(16px) scale(0.97);
      }

      .tryon-gallery-modal__dialog::-webkit-scrollbar {
        width: 10px;
      }

      .tryon-gallery-modal__dialog::-webkit-scrollbar-track {
        background: transparent;
        border-radius: 999px;
        margin: 16px 0;
      }

      .tryon-gallery-modal__dialog::-webkit-scrollbar-thumb {
        background: rgba(120, 121, 116, 0.35);
        border-radius: 999px;
        border: 2px solid rgba(255, 255, 255, 0.9);
      }

      .tryon-gallery-modal__dialog::-webkit-scrollbar-thumb:hover {
        background: rgba(120, 121, 116, 0.55);
      }

      .tryon-gallery-modal__header {
        position: sticky;
        top: 0;
        z-index: 2;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 16px;
        padding: 24px 0 16px;
        background: #fff;
        border-bottom: 1px solid rgba(30, 30, 25, 0.08);
      }

      .tryon-gallery-modal__title {
        font-size: 24px;
        font-weight: 700;
        color: #1e1e19;
        margin: 0;
      }

      .tryon-gallery-modal__close {
        border: none;
        background: transparent;
        font-size: 24px;
        cursor: pointer;
        color: #1e1e19;
      }

      .tryon-gallery-modal__content {
        display: flex;
        flex-direction: column;
        /* gap: 24px; */
      }

      .tryon-gallery-modal__item {
        width: 100%;
        border-radius: 24px;
        overflow: hidden;
        background: #f7f6f1;
        position: relative;
        min-height: 400px;
      }

      .tryon-gallery-modal__item img {
        width: 100%;
        display: block;
        height: auto;
        opacity: 0;
        transition: opacity 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      }

      .tryon-gallery-modal__item img.tryon-img-loaded {
        opacity: 1;
      }

      /* 圖片加載骨架屏 */
      .tryon-gallery-modal__item::before {
        content: '';
        position: absolute;
        inset: 0;
        background: linear-gradient(
          90deg,
          #f7f6f1 0%,
          #eeede8 20%,
          #f7f6f1 40%,
          #f7f6f1 100%
        );
        background-size: 200% 100%;
        animation: shimmer 1.8s ease-in-out infinite;
        pointer-events: none;
        z-index: 1;
      }

      .tryon-gallery-modal__item.tryon-img-container-loaded::before {
        display: none;
      }

      @keyframes shimmer {
        0% {
          background-position: 200% 0;
        }
        100% {
          background-position: -200% 0;
        }
      }

      .tryon-gallery-modal__empty {
        font-size: 16px;
        color: #5c5c58;
        text-align: center;
      }

      body.tryon-gallery-modal-open {
        overflow: hidden;
      }

      @media (prefers-reduced-motion: reduce) {
        .tryon-gallery-modal,
        .tryon-gallery-modal__overlay,
        .tryon-gallery-modal__dialog {
          transition: none !important;
          animation: none !important;
        }
      }

      /* ========== 全螢幕圖片瀏覽器樣式 ========== */
      .fullscreen-viewer {
        --fullscreen-enter-duration: 380ms;
        --fullscreen-exit-duration: 280ms;
        --fullscreen-ease: cubic-bezier(0.16, 1, 0.3, 1);
        position: fixed;
        inset: 0;
        z-index: 10000;
        display: none;
        opacity: 0;
        pointer-events: none;
        will-change: opacity;
      }

      .fullscreen-viewer--open {
        display: block;
      }

      .fullscreen-viewer--visible {
        opacity: 1;
        pointer-events: auto;
      }

      .fullscreen-viewer--closing {
        pointer-events: none;
      }

      .fullscreen-viewer__overlay {
        position: absolute;
        inset: 0;
        background: rgba(0, 0, 0, 0.95);
        opacity: 0;
        transition: opacity var(--fullscreen-enter-duration) var(--fullscreen-ease);
      }

      .fullscreen-viewer--visible .fullscreen-viewer__overlay {
        opacity: 1;
      }

      .fullscreen-viewer--closing .fullscreen-viewer__overlay {
        transition-duration: var(--fullscreen-exit-duration);
      }

      .fullscreen-viewer__container {
        position: relative;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        z-index: 1;
        isolation: isolate;
      }

      .fullscreen-viewer__header {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        z-index: 3;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 24px;
        background: linear-gradient(180deg, rgba(0, 0, 0, 0.5) 0%, transparent 100%);
      }

      .fullscreen-viewer__counter {
        font-size: 16px;
        font-weight: 600;
        color: #fff;
        text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
      }

      .fullscreen-viewer__close {
        width: 48px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        color: #fff;
        font-size: 32px;
        line-height: 1;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .fullscreen-viewer__close:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: scale(1.05);
      }

      .fullscreen-viewer__close:active {
        transform: scale(0.95);
      }

      .fullscreen-viewer__main {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        position: static;
        padding: 80px 0 120px;
      }

      @media (max-width: 768px) {
        .fullscreen-viewer__main {
          padding: 80px 0 140px;
        }
      }

      .fullscreen-viewer__image-wrapper {
        position: relative;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        cursor: grab;
        touch-action: none;
        z-index: 1;
        pointer-events: auto;
      }

      .fullscreen-viewer__image-wrapper--dragging {
        cursor: grabbing;
      }

      .fullscreen-viewer__image-wrapper--zoomed {
        cursor: zoom-out;
      }

      .fullscreen-viewer__image {
        max-width: 100%;
        max-height: 100%;
        width: auto;
        height: auto;
        object-fit: contain;
        user-select: none;
        transition: transform 0.3s var(--fullscreen-ease), opacity 0.3s var(--fullscreen-ease);
        opacity: 0;
        transform: scale(0.9);
      }

      .fullscreen-viewer__image.fullscreen-viewer__image--loaded {
        opacity: 1;
        transform: scale(1);
      }

      .fullscreen-viewer__nav {
        position: fixed;
        top: 50%;
        transform: translateY(-50%);
        width: 56px;
        height: 56px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(255, 255, 255, 0.12);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1.5px solid rgba(255, 255, 255, 0.25);
        border-radius: 50%;
        color: #fff;
        cursor: pointer;
        transition: all 0.25s cubic-bezier(0.16, 1, 0.3, 1);
        padding: 0;
        user-select: none;
        -webkit-tap-highlight-color: transparent;
        z-index: 10200;
      }

      .fullscreen-viewer__nav svg {
        width: 24px;
        height: 24px;
        display: block;
        pointer-events: none;
      }

      .fullscreen-viewer__nav:hover {
        background: rgba(255, 255, 255, 0.22);
        border-color: rgba(255, 255, 255, 0.4);
        transform: translateY(-50%) scale(1.1);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
      }

      .fullscreen-viewer__nav:active {
        transform: translateY(-50%) scale(0.95);
        background: rgba(255, 255, 255, 0.3);
      }

      .fullscreen-viewer__nav:disabled {
        opacity: 0.3;
        cursor: not-allowed;
        pointer-events: none;
      }

      .fullscreen-viewer__nav--prev {
        left: 10px;
      }

      .fullscreen-viewer__nav--next {
        right: 10px;
      }

      @media (max-width: 768px) {
        .fullscreen-viewer__nav {
          width: 48px;
          height: 48px;
        }

        .fullscreen-viewer__nav svg {
          width: 20px;
          height: 20px;
        }

        .fullscreen-viewer__nav--prev {
          left: 16px;
        }

        .fullscreen-viewer__nav--next {
          right: 16px;
        }
      }

      .fullscreen-viewer__thumbnails {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        z-index: 3;
        display: flex;
        gap: 12px;
        padding: 20px 24px;
        overflow-x: auto;
        overflow-y: hidden;
        background: linear-gradient(0deg, rgba(0, 0, 0, 0.5) 0%, transparent 100%);
        scrollbar-width: none;
      }

      .fullscreen-viewer__thumbnails::-webkit-scrollbar {
        display: none;
      }

      .fullscreen-viewer__thumbnail {
        flex-shrink: 0;
        width: 64px;
        height: 64px;
        border-radius: 8px;
        overflow: hidden;
        border: 2px solid transparent;
        cursor: pointer;
        transition: all 0.2s ease;
        opacity: 0.6;
      }

      .fullscreen-viewer__thumbnail:hover {
        opacity: 1;
        transform: scale(1.05);
      }

      .fullscreen-viewer__thumbnail.fullscreen-viewer__thumbnail--active {
        opacity: 1;
        border-color: #fff;
        box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.5);
      }

      .fullscreen-viewer__thumbnail img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }

      body.fullscreen-viewer-open {
        overflow: hidden;
      }

      @media (prefers-reduced-motion: reduce) {
        .fullscreen-viewer,
        .fullscreen-viewer__overlay,
        .fullscreen-viewer__image {
          transition: none !important;
        }
      }

      @media screen and (min-width: 1024px) {
        .tryon-showcase {
          padding: 0 40px;
        }
        .tryon-showcase__body {
          flex-direction: row;
          gap: 48px;
          align-items: flex-start;
          margin: 0 auto;
          max-width: fit-content;
        }
        .tryon-showcase__iframe,
        .tryon-showcase__side-panel {
          flex: 1 1 50%;
          /* max-width: 50%; */
          width: 438px;
          max-width: 438px;
          margin: 0 auto;
        }
        .tryon-scroll-gallery {
          padding: 28px;
        }
      }

      @media screen and (max-width: 480px) {
        .tryon-qr__body {
          flex-direction: column;
          width: 100%;
        }
        .tryon-qr__image {
          width: 100%;
          height: auto;
        }
      }

      .personalized_hero_section {
        display: flex;
        padding: 64px 24px 64px 24px;
        flex-direction: column;
        align-items: flex-start;
        gap: 48px;
      }

      .personalized_hero_section .text-section {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        gap: 10px;
        width: 100%;
      }

      .personalized_hero_section h1 {
        color: #1e1e19;
        /* Medium&SmallSubtitle/CH/Bold */
        font-family: 'Noto Sans TC';
        font-size: 32px;
        font-style: normal;
        font-weight: 700;
        line-height: 39px; /* 121.875% */
        letter-spacing: 0.64px;
      }

      .personalized_hero_section h1 br {
        display: none;
      }

      .personalized_hero_section p {
        color: #787974;
        max-width: 241px;
        text-align: center;
        font-family: 'Noto Sans TC';
        font-size: 17px;
        font-style: normal;
        font-weight: 400;
        line-height: 22px; /* 129.412% */
        letter-spacing: 0.34px;
      }

      h4 {
        color: #1e1e19;
        font-size: 28px;
        font-weight: 700;
        line-height: 35px;
        letter-spacing: 0.56px;
      }

      .btn-section {
        width: 100%;
        display: flex;
        justify-content: center;
      }

      .btn-section button {
        display: flex;
        min-width: fit-content;
        width: 121px;
        height: 45px;
        padding: 13px 15px;
        justify-content: center;
        align-items: center;
        gap: 10px;
        border-radius: 100px;
        background: #000;
        color: #fff;
        font-size: 17px;
        font-weight: 500;
        line-height: 22px;
        letter-spacing: 0.34px;
        cursor: pointer;
      }

      .btn-section button:hover {
        background: rgba(0, 0, 0, 0.8);
        transition: background 300ms ease-out;
      }

      .step-section {
        display: flex;
        flex-direction: column;
        gap: 24px;
        width: 100%;
      }

      #steps-container {
        gap: 32px 64px;
        justify-content: center;
        max-width: 1280px;
        width: 100%;
        margin: 0 auto;
      }

      /* 少於 4 個時，每排全部排成一列 */
      /* 4 個以上，每列顯示兩個 */

      /* #steps-container:not(.two-columns) {
        display: flex;
        gap: 96px;
      }
      #steps-container.two-columns {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        max-width: 500px;
        margin: 0 auto;
      } */

      #steps-container {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        max-width: 100%;
        /* 可選：限制最大寬度避免太寬 */
        gap: 32px 64px;
        margin: 0 auto;
      }

      .step-section .step-container {
        justify-content: center;
      }

      @media screen and (min-width: 768px) {
        #steps-container {
          display: flex;
          gap: 96px;
        }
      }

      .step-section .steps {
        display: flex;
        flex-direction: column;
        gap: 24px;
      }

      .step-section .step-container {
        display: flex;
        gap: 12px;
        position: relative;
        min-width: 80px;
      }

      /* .step-section .step-container:not(:last-child)::after {
      content: '';
      position: absolute;
      top: 75%;
      left: 23.5px;
      width: 3px;
      height: 50px;
      background: #787974;
    } */

      .step-section .step-index {
        font-family: 'Figtree', Arial, sans-serif;
      }

      .step-section .step-text {
        display: flex;
        flex-direction: column;
        /* align-items: flex-start; */
        gap: 4px;
      }

      .step-section .step-text p {
        color: #1e1e19;
        text-align: center;
        font-family: Figtree;
        font-size: 32px;
        font-style: normal;
        font-weight: 700;
        line-height: 32px; /* 100% */
        letter-spacing: 0.64px;
      }

      .step-section .step-text span {
        color: #787974;
        text-align: center;
        /* Subheadline/EN/Medium */
        font-family: Figtree;
        font-size: 15px;
        font-style: normal;
        font-weight: 500;
        line-height: 20px; /* 133.333% */
        letter-spacing: -0.12px;
      }

      .step-section .step {
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 50px;
        height: 50px;
      }

      .step-section .step svg {
        width: 32px;
        height: 32px;
      }

      .step-section .step span {
        position: absolute;
        color: #fff;
        text-align: center;
        font-size: 16px;
        font-weight: 700;
        line-height: 16px;
      }

      .step-section .btn-section button {
        gap: 4px;
      }

      @media screen and (min-width: 768px) {
        .personalized_hero_section {
          max-width: 1440px;
          margin: 0 auto;
          padding: 100px 10px 100px 10px;
          align-items: center;
          gap: 64px;
        }
        .personalized_hero_section .text-section {
          gap: 12px;
        }

        .personalized_hero_section h1 {
          color: #1e1e19;
          text-align: center;
          font-family: 'Noto Sans TC', 'Figtree';
          font-size: 51px;
          font-style: normal;
          font-weight: 700;
          line-height: 56px;
          /* 109.804% */
          letter-spacing: 1.02px;
        }

        .personalized_hero_section h1 br {
          display: block;
        }

        .personalized_hero_section p {
          color: #787974;
          text-align: center;
          font-feature-settings:
            'liga' off,
            'clig' off;
          /* Title2/CH/Regular */
          font-family: 'Noto Sans TC';
          font-size: 22px;
          font-style: normal;
          font-weight: 400;
          line-height: 27px; /* 122.727% */
          letter-spacing: 0.8px;
          max-width: 895px;
        }

        h4 {
          text-align: center;
          font-size: 32px;
          font-weight: 700;
          line-height: 34px;
          letter-spacing: 0.64px;
        }

        .step-section {
          gap: 64px;
        }

        .step-section .step-container {
          flex-direction: column;
          align-items: center;
          gap: 24px;
        }

        /* .step-section .step-container:not(:last-child)::after {
        content: none;
      } */

        /* .step-section .step-container:not(:last-child)::before {
        content: '';
        position: absolute;
        top: 24px;
        left: 20px;
        width: 200px;
        height: 3px;
        background: #787974;
      } */

        .step-section .step-text {
          align-items: center;
          gap: 12px;
        }

        .step-section .step-text span {
          color: #787974;
          text-align: center;
          font-feature-settings:
            'liga' off,
            'clig' off;

          /* Title2/EN/Regular */
          font-family: Figtree;
          font-size: 22px;
          font-style: normal;
          font-weight: 400;
          line-height: 27px;
          /* 122.727% */
          letter-spacing: -0.8px;
        }

        .step-section .step-text p {
          color: #1e1e19;
          text-align: center;
          font-family: 'Noto Sans TC', 'Figtree';
          font-size: 64px;
          font-style: normal;
          font-weight: 700;
          line-height: 66px;
          /* 103.125% */
          letter-spacing: 1.28px;
        }

        .step-section .step-text p,
        .step-section .step-text span {
          display: flex;
          width: 100%;
          justify-content: center;
        }

        .step-section .steps {
          flex-direction: row;
          justify-content: center;
          gap: 120px;
        }

        .step-section .step svg {
          width: 48px;
          height: 48px;
        }

        .step-section .step span {
          font-size: 24px;
          font-weight: 700;
          line-height: 24px;
        }
      }

      .cta-section {
        position: relative;
        width: 100%;
        padding: 100px 24px 64px 24px;
        gap: 40px;
        height: 500px;
        background:
          linear-gradient(90deg, rgba(0, 0, 0, 0.2) 0%, rgba(0, 0, 0, 0) 48%),
          linear-gradient(0deg, rgba(0, 0, 0, 0.24) 0%, rgba(0, 0, 0, 0.24) 100%),
          url('./img/personalized/coupon-bg-mobile.png') lightgray 50% / cover no-repeat;
        color: #fff;
      }

      .cta-section .copy-alert {
        position: absolute;
        top: 28px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        padding: 10px 15px;
        justify-content: center;
        align-items: center;
        gap: 4px;
        border-radius: 100px;
        border: 1px solid #fff;
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(6px);
        cursor: default;
        color: #fff;
        text-align: center;
        font-family:
          'Noto Sans TC' Arial,
          sans-serif;
        font-size: 15px;
        font-style: normal;
        font-weight: 700;
        line-height: 17px;
        letter-spacing: 0.3px;
      }

      .cta-section .cta-section-container {
        height: 100%;
        width: 100%;
        max-width: 1280px;
        margin: 0 auto;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 24px 0;
        display: none;
      }

      .cta-section .cta-text {
        display: flex;
        flex-direction: column;
        width: 100%;
        gap: 12px;
      }

      .cta-section .cta-text p {
        font-family:
          'Noto Sans TC' Arial,
          sans-serif;
        font-size: 28px;
        font-weight: 700;
        line-height: 35px;
        letter-spacing: -0.56px;
      }

      .cta-section .cta-text span {
        font-family:
          'Noto Sans TC' Arial,
          sans-serif;
        font-size: 17px;
        font-weight: 500;
        line-height: 22px;
        letter-spacing: -0.34px;
      }

      .cta-section .cta-coupon {
        width: 100%;
      }

      .cta-section .cta-coupon p {
        font-family: 'Figtree', Arial, sans-serif;
        font-size: 72px;
        font-weight: 800;
        line-height: 74px;
        letter-spacing: -1.44px;
      }

      .cta-section .cta-coupon span {
        font-family: 'Figtree', Arial, sans-serif;
        font-size: 32px;
        font-weight: 700;
        line-height: 36px;
        letter-spacing: -0.64px;
      }

      .cta-section .coupon-copy {
        display: none;
        align-items: center;
        border-radius: 40px;
        background: rgba(255, 255, 255, 0.28);
        backdrop-filter: blur(12px);
        padding: 14px 24px;
        gap: 8px;
        width: fit-content;
      }

      .cta-section .copy-btn {
        width: 24px;
        height: 24px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0;
        border: none;
        background: none;
        cursor: pointer;
      }

      @media screen and (min-width: 768px) {
        .cta-section {
          padding: 155px 80px 140px 80px;
          flex-direction: row;
          justify-content: space-between;
          align-items: center;
          width: 100%;
          background:
            linear-gradient(90deg, rgba(0, 0, 0, 0.2) 0%, rgba(0, 0, 0, 0) 48%),
            linear-gradient(0deg, rgba(0, 0, 0, 0.24) 0%, rgba(0, 0, 0, 0.24) 100%),
            url('./img/personalized/coupon-bg-desktop.png') lightgray 50% / cover no-repeat;
        }

        .cta-section .copy-alert {
          top: 64px;
        }

        .cta-section .cta-section-container {
          height: 100%;
          width: 100%;
          max-width: 1280px;
          margin: 0 auto;
          display: flex;
        }

        .cta-section .cta-text {
          min-width: 700px;
        }

        .cta-section .cta-text p {
          color: #fff;
          font-family: 'Noto Sans TC';
          font-size: 55px;
          font-style: normal;
          font-weight: 700;
          line-height: 62px; /* 112.727% */
          letter-spacing: -1.1px;
        }

        .cta-section .cta-text span {
          font-size: 36px;
          font-weight: 500;
          line-height: 41px;
          letter-spacing: -0.72px;
        }

        .cta-section .cta-coupon p {
          font-size: 120px;
          font-weight: 800;
          line-height: 125px;
          letter-spacing: -2.4px;
          text-align: right;
        }

        .cta-section .cta-coupon span {
          color: #fff;
          font-family: Figtree;
          font-size: 36px;
          font-style: normal;
          font-weight: 500;
          line-height: 38px;
          /* 105.556% */
          letter-spacing: -0.72px;
        }

        .cta-section .copy-btn {
          height: 36px;
          width: 36px;
        }
      }

      .recom-section {
        display: flex;
        padding: 100px 24px 64px 24px;
        flex-direction: column;
        justify-content: center;
        align-items: flex-start;
        gap: 40px;
        width: 100%;
      }

      .recom-section .text-section {
        display: flex;
        flex-direction: column;
        width: 100%;
        gap: 10px;
        align-items: center;
      }

      .recom-section .text-section h2 {
        color: #000;
        font-family:
          'Noto Sans TC' Arial,
          sans-serif;
        font-size: 32px;
        font-weight: 700;
        line-height: 39px;
        letter-spacing: 0.64px;
        white-space: pre-wrap;
      }

      .recom-section .text-section p {
        color: rgba(0, 0, 0, 0.8);
        font-family:
          'Noto Sans TC' Arial,
          sans-serif;
        font-size: 17px;
        font-weight: 300;
        line-height: 22px;
        letter-spacing: 0.34px;
        text-align: center;
      }

      @media screen and (min-width: 768px) {
        .recom-section {
          padding: 155px 80px 140px 80px;
          gap: 100px;
        }

        .recom-section .text-section {
          gap: 24px;
        }

        .recom-section .text-section h2 {
          color: #1e1e19;
          text-align: center;
          font-size: 51px;
          line-height: 56px;
          letter-spacing: 1.02px;
        }

        .recom-section .text-section p {
          color: #787974;
          text-align: center;
          font-size: 28px;
          font-weight: 400;
          line-height: 33px;
          letter-spacing: -0.56px;
        }
      }

      /* email */
      .mail-section {
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
        min-height: 100vh;
        padding: 100px 24px;
      }

      .last-img-cover,
      .mail-section img {
        display: none;
      }

      /* 隱藏 placeholder 圖片 */
      img[src*="placehold.co"] {
        display: none !important;
      }

      .mail-section__container {
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        max-width: 400px;
        gap: 36px 0;
      }

      .mail-section__text {
        display: flex;
        flex-direction: column;
        gap: 18px 0;
      }

      .mail-section .mail-section__title {
        color: #000;
        text-align: center;
        /* Medium&SmallSubtitle/CH/Bold */
        font-family:
          'Noto Sans TC' Arial,
          sans-serif;
        font-size: 32px;
        font-style: normal;
        font-weight: 700;
        line-height: 39px;
        /* 121.875% */
        letter-spacing: 0.64px;
      }

      .mail-section .mail-section__desc {
        color: #787974;
        text-align: center;
        font-family: 'Noto Sans TC', 'Figtree';
        font-size: 17px;
        font-style: normal;
        font-weight: 400;
        line-height: 22px;
        /* 129.412% */
        letter-spacing: 0.34px;
      }

      .mail-section .mail-section__content {
        display: flex;
        align-items: center;
        gap: 10px;
        align-self: stretch;
      }

      .mail-section .mail-section__input {
        display: flex;
        padding: 10px 14px;
        align-items: center;
        gap: 4px;
        flex: 1 0 0;
        border-radius: 100px;
        background: #fff;
        border: none;
        color: #787974;
        /* Body/EN */
        font-family: Figtree;
        font-size: 17px;
        font-style: normal;
        font-weight: 500;
        line-height: 22px;
        letter-spacing: -0.136px;
      }

      .mail-section .mail-section__input.invalid {
        outline: 2px solid #b00b05;
      }

      input:-webkit-autofill,
      input:-webkit-autofill:hover,
      input:-webkit-autofill:focus,
      input:-webkit-autofill:active {
        -webkit-text-fill-color: #fff;
        -webkit-box-shadow: 0 0 0 1000px rgba(255, 255, 255, 0) inset;
        transition: background-color 5000s ease-in-out 0s;
      }

      .mail-section .mail-section__input:not(.invalid):focus {
        outline: 2px solid #1e1e19;
        caret-color: #00bcb7;
      }

      .mail-section .mail-section__btn {
        border: none;
        display: flex;
        padding: 10px 16px;
        justify-content: center;
        align-items: center;
        min-width: 75px;
        height: 40px;
        gap: 4px;
        border-radius: 40px;
        background: rgba(0, 0, 0, 0.95);
        color: #fff;
        /* Body/CH */
        font-family:
          'Noto Sans TC' Arial,
          sans-serif;
        font-size: 17px;
        font-style: normal;
        font-weight: 500;
        line-height: 22px;
        /* 129.412% */
        letter-spacing: 0.34px;
      }

      .mail-section .mail-section__btn:hover:not(:disabled) {
        cursor: pointer;
        background: rgba(0, 0, 0, 1);
      }

      .mail-section .mail-section__btn:disabled {
        cursor: not-allowed;
        background: #e0e0df;
        color: #a3a39f;
      }

      .mail-section #mailSectionBtn-finish {
        display: none;
        opacity: 0;
        transition: opacity 400ms ease;
      }

      .mail-section #mailSectionBtn.sent #mailSectionBtn-finish {
        display: flex;
        align-items: center;
        opacity: 1;
      }

      .mail-section div[data-depth] {
        position: absolute;
        transition: transform 0.3s ease-out;
        will-change: transform;
      }

      .mail-section img[data-depth] {
        position: absolute;
        transition: transform 0.3s ease-out;
        will-change: transform;
      }

      @media screen and (min-width: 1240px) {
        .mail-section {
          overflow: visible;
          padding: 155px 80px 140px 80px;
          background: rgba(0, 0, 0, 0.95);
        }

        .last-img-cover,
        .mail-section img {
          display: block;
        }

        .mail-section .mail-section__title {
          color: #f4f4f4;
          text-align: center;
          font-family:
            'Noto Sans TC' Arial,
            sans-serif;
          font-size: 51px;
          font-style: normal;
          font-weight: 700;
          line-height: 56px;
          /* 109.804% */
          letter-spacing: 1.02px;
        }

        .mail-section .mail-section__desc {
          color: #e0e0df;
          text-align: center;
          font-feature-settings:
            'liga' off,
            'clig' off;
          /* Title2/CH/Regular */
          font-family: 'Noto Sans TC', 'Figtree';
          font-size: 22px;
          font-style: normal;
          font-weight: 400;
          line-height: 27px;
          /* 122.727% */
          letter-spacing: 0.8px;
        }

        .mail-section .mail-section__btn {
          background-color: #2da2fb;
          color: #fff;
        }

        .mail-section .mail-section__btn:hover:not(:disabled) {
          background-color: #43adff;
          color: #fff;
        }

      .mail-section .mail-section__btn:disabled {
        background-color: #0c8ce9;
        color: #e0e0df;
      }
      }

      /* LINE 優惠按鈕樣式 - 使用 LINE 主色系 */
      .liff-promo-btn {
        border: none;
        display: flex !important;
        padding: 12px 24px;
        justify-content: center;
        align-items: center;
        gap: 8px;
        border-radius: 40px;
        background: #00C300;
        color: #fff;
        font-family: 'Noto Sans TC', Arial, sans-serif;
        font-size: 17px;
        font-style: normal;
        font-weight: 500;
        line-height: 22px;
        letter-spacing: 0.34px;
        cursor: pointer;
        transition: all 0.3s ease;
        min-width: 200px;
        margin-top: 20px;
        position: relative;
        z-index: 10;
        visibility: visible !important;
        opacity: 1 !important;
      }

      .liff-promo-btn:hover:not(:disabled) {
        background: #00A000;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 195, 0, 0.3);
      }

      .liff-promo-btn:active:not(:disabled) {
        transform: translateY(0);
        box-shadow: 0 2px 6px rgba(0, 195, 0, 0.2);
      }

      .liff-promo-btn:disabled {
        cursor: not-allowed;
        background: #a0a0a0;
        color: #e0e0df;
        opacity: 0.6;
      }

      .liff-promo-btn--loading {
        position: relative;
        color: transparent;
      }

      .liff-promo-btn--loading::after {
        content: '';
        position: absolute;
        width: 20px;
        height: 20px;
        top: 50%;
        left: 50%;
        margin-left: -10px;
        margin-top: -10px;
        border: 2px solid #fff;
        border-top-color: transparent;
        border-radius: 50%;
        animation: liff-promo-spin 0.8s linear infinite;
      }

      @keyframes liff-promo-spin {
        to {
          transform: rotate(360deg);
        }
      }

      @media screen and (min-width: 1240px) {
        .liff-promo-btn {
          font-size: 18px;
          padding: 14px 28px;
          min-width: 220px;
        }
      }

      /* restart */
      .restart-section {
        display: flex;
        padding: 140px 24px 120px 24px;
        flex-direction: column;
        align-items: center;
        gap: 48px;
        align-self: stretch;
        width: 100%;
      }

      .restart-section .text-section {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
        gap: 24px;
      }

      .restart-section .text-section p {
        color: #000;
        text-align: center;
        font-family:
          'Noto Sans TC' Arial,
          sans-serif;
        font-size: 32px;
        font-weight: 700;
        line-height: 39px;
        letter-spacing: 0.64px;
      }

      .restart-section .restart-icon {
        width: 72px;
        height: 72px;
      }

      @media screen and (min-width: 768px) {
        .restart-section {
          padding: 140px 80px 120px 80px;
        }

        .restart-section .text-section p {
          color: #1e1e19;
          font-size: 48px;
          line-height: 53px;
          letter-spacing: 0.96px;
        }

        .restart-section .restart-icon {
          width: 110px;
          height: 110px;
        }
      }

      .hr-section {
        width: 100%;
        height: 20px;
        flex-shrink: 0;
        align-self: stretch;
        background-color: #f2f2f2;
      }

      .copy-alert-transition-enter-active {
        animation: slideIn 0.3s ease-out;
      }

      .copy-alert-transition-leave-active {
        animation: fadeOut 0.3s ease-in;
      }

      @keyframes slideIn {
        from {
          transform: translateX(-50%) translateY(-35%);
          opacity: 0;
        }

        to {
          transform: translateX(-50%) translateY(0);
          opacity: 1;
        }
      }

      @keyframes fadeOut {
        from {
          transform: translateX(-50%) translateY(0);
          opacity: 1;
        }

        to {
          transform: translateX(-50%) translateY(-35%);
          opacity: 0;
        }
      }

      .w-full {
        width: 100%;
      }

      .flex {
        display: flex;
      }

      .justify-center {
        justify-content: center;
      }

      .mx-auto {
        margin-left: auto;
        margin-right: auto;
      }

      .max-w-\[1280px\] {
        max-width: 1280px;
      }
    </style>
    <style>
      .send-alert {
        position: fixed;
        z-index: 99999999999999999999;
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        width: 100%;
        max-width: calc(100vw - 20px);
        margin: 0 auto;
        max-height: 62px;
        padding: 14px 12px 14px 24px;
        align-items: center;
        gap: 14px;
        flex-shrink: 0;
        border-radius: 18px;
        opacity: 0;
      }
      @media screen and (min-width: 768px) {
        .send-alert {
          max-width: 355px;
        }
      }

      .send-alert .close-send-alert {
        margin-left: auto;
        cursor: pointer;
        display: flex;
        align-items: center;
      }

      @media screen and (max-width: 375px) {
        .send-alert {
          max-width: 85vw;
        }
      }

      .send-alert div {
        /* Headline/CH */
        font-family:
          'Noto Sans TC' Arial,
          sans-serif;
        font-size: 17px;
        font-style: normal;
        font-weight: 700;
        line-height: 22px;
        /* 129.412% */
        letter-spacing: 0.34px;
      }

      .send-alert.showing {
        display: flex;
        animation: slideUp 0.3s ease-out forwards;
      }

      .send-alert.hiding {
        animation: slideDown 0.3s ease-in forwards;
      }

      @media screen and (min-width: 768px) {
        .send-alert {
          position: absolute;
          bottom: unset;
          top: 14px;
        }

        .send-alert.showing {
          animation: slideIn 0.3s ease-out forwards;
        }

        .send-alert.hiding {
          animation: fadeOut 0.3s ease-in forwards;
        }
      }

      @keyframes slideUp {
        from {
          transform: translateX(-50%) translateY(10px);
          opacity: 0;
        }

        to {
          transform: translateX(-50%) translateY(0);
          opacity: 1;
        }
      }

      @keyframes slideDown {
        from {
          transform: translateX(-50%) translateY(0);
          opacity: 1;
        }

        to {
          transform: translateX(-50%) translateY(10px);
          opacity: 0;
        }
      }

      @keyframes slideIn {
        from {
          transform: translateX(-50%) translateY(-35%);
          opacity: 0;
        }

        to {
          transform: translateX(-50%) translateY(0);
          opacity: 1;
        }
      }

      @keyframes fadeOut {
        from {
          transform: translateX(-50%) translateY(0);
          opacity: 1;
        }

        to {
          transform: translateX(-50%) translateY(-35%);
          opacity: 0;
        }
      }
    </style>
  </head>

  <body>
    <section id="personalized-page">
      <div id="inf_iframe_personalized_page">
        <section class="cta-section">
          <div class="copy-alert" id="copy-alert" style="opacity: 0">
            <svg
              width="18"
              height="18"
              viewBox="0 0 18 18"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M6.75 3.75H5.25C4.85218 3.75 4.47064 3.90804 4.18934 4.18934C3.90804 4.47064 3.75 4.85218 3.75 5.25V14.25C3.75 14.6478 3.90804 15.0294 4.18934 15.3107C4.47064 15.592 4.85218 15.75 5.25 15.75H12.75C13.1478 15.75 13.5294 15.592 13.8107 15.3107C14.092 15.0294 14.25 14.6478 14.25 14.25V5.25C14.25 4.85218 14.092 4.47064 13.8107 4.18934C13.5294 3.90804 13.1478 3.75 12.75 3.75H11.25"
                stroke="white"
                stroke-width="1.5"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
              <path
                d="M6.75 3.75C6.75 3.35218 6.90804 2.97064 7.18934 2.68934C7.47064 2.40804 7.85218 2.25 8.25 2.25H9.75C10.1478 2.25 10.5294 2.40804 10.8107 2.68934C11.092 2.97064 11.25 3.35218 11.25 3.75C11.25 4.14782 11.092 4.52936 10.8107 4.81066C10.5294 5.09196 10.1478 5.25 9.75 5.25H8.25C7.85218 5.25 7.47064 5.09196 7.18934 4.81066C6.90804 4.52936 6.75 4.14782 6.75 3.75Z"
                stroke="white"
                stroke-width="1.5"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
              <path
                d="M6.75 10.5L8.25 12L11.25 9"
                stroke="white"
                stroke-width="1.5"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
            </svg>
            <div>已複製折扣碼</div>
          </div>
          <div class="cta-section-container">
            <div class="cta-text">
              <p class="coupon-text" style="white-space: pre-wrap; max-width: 50%">
                <!-- 以九折優惠，<br />
              開啟專屬你的風格之選。 -->
              </p>
            </div>
            <div class="cta-coupon">
              <div class="coupon-copy">
                <span>Code: <span class="coupon-code"></span></span>
                <button class="copy-btn" onclick="copyDiscountCode()">
                  <svg
                    id="copy-icon"
                    xmlns="http://www.w3.org/2000/svg"
                    width="32"
                    height="33"
                    viewBox="0 0 32 33"
                    fill="none"
                  >
                    <path
                      d="M9.33301 13.0912C9.33301 12.148 9.70766 11.2436 10.3745 10.5767C11.0414 9.9098 11.9459 9.53516 12.889 9.53516H24.4437C24.9107 9.53516 25.3731 9.62714 25.8045 9.80584C26.2359 9.98455 26.6279 10.2465 26.9581 10.5767C27.2884 10.9069 27.5503 11.2989 27.729 11.7303C27.9077 12.1618 27.9997 12.6242 27.9997 13.0912V24.6458C27.9997 25.1128 27.9077 25.5752 27.729 26.0066C27.5503 26.4381 27.2884 26.8301 26.9581 27.1603C26.6279 27.4905 26.2359 27.7524 25.8045 27.9311C25.3731 28.1098 24.9107 28.2018 24.4437 28.2018H12.889C12.422 28.2018 11.9596 28.1098 11.5282 27.9311C11.0968 27.7524 10.7047 27.4905 10.3745 27.1603C10.0443 26.8301 9.7824 26.4381 9.60369 26.0066C9.42499 25.5752 9.33301 25.1128 9.33301 24.6458V13.0912Z"
                      stroke="white"
                      stroke-opacity="0.95"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    />
                    <path
                      d="M5.34933 22.5177C4.94046 22.2846 4.60036 21.9477 4.36343 21.541C4.1265 21.1343 4.00113 20.6723 4 20.2017V6.86833C4 5.40166 5.2 4.20166 6.66667 4.20166H20C21 4.20166 21.544 4.71499 22 5.53499"
                      stroke="white"
                      stroke-opacity="0.95"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    />
                  </svg>
                  <svg
                    id="copied-icon"
                    width="100%"
                    height="100%"
                    viewBox="0 0 36 36"
                    fill="none"
                    xmlns="http://www.w3.org/2000/svg"
                    style="display: none"
                  >
                    <path
                      d="M13.5 7.5H10.5C9.70435 7.5 8.94129 7.81607 8.37868 8.37868C7.81607 8.94129 7.5 9.70435 7.5 10.5V28.5C7.5 29.2956 7.81607 30.0587 8.37868 30.6213C8.94129 31.1839 9.70435 31.5 10.5 31.5H25.5C26.2956 31.5 27.0587 31.1839 27.6213 30.6213C28.1839 30.0587 28.5 29.2956 28.5 28.5V10.5C28.5 9.70435 28.1839 8.94129 27.6213 8.37868C27.0587 7.81607 26.2956 7.5 25.5 7.5H22.5"
                      stroke="white"
                      stroke-width="3"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    />
                    <path
                      d="M13.5 7.5C13.5 6.70435 13.8161 5.94129 14.3787 5.37868C14.9413 4.81607 15.7044 4.5 16.5 4.5H19.5C20.2956 4.5 21.0587 4.81607 21.6213 5.37868C22.1839 5.94129 22.5 6.70435 22.5 7.5C22.5 8.29565 22.1839 9.05871 21.6213 9.62132C21.0587 10.1839 20.2956 10.5 19.5 10.5H16.5C15.7044 10.5 14.9413 10.1839 14.3787 9.62132C13.8161 9.05871 13.5 8.29565 13.5 7.5Z"
                      stroke="white"
                      stroke-width="3"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    />
                    <path
                      d="M13.5 21L16.5 24L22.5 18"
                      stroke="white"
                      stroke-width="3"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    />
                  </svg>
                </button>
              </div>
            </div>
          </div>
        </section>
        <section class="mobile-cta-section">
          <div class="cta-section-container">
            <div class="cta-text">
              <p class="coupon-text" style="white-space: pre-wrap">
                <!-- 以九折優惠，<br />
              開啟專屬你的風格之選。 -->
              </p>
            </div>
            <div class="cta-coupon">
              <div class="coupon-copy">
                <span>Code: <span class="coupon-code"></span></span>
                <button class="copy-btn" onclick="copyDiscountCode()">
                  <svg
                    id="copy-icon--mobile"
                    width="100%"
                    height="100%"
                    viewBox="0 0 36 36"
                    fill="none"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <path
                      d="M10.5 14.5005C10.5 13.4395 10.9215 12.422 11.6717 11.6717C12.422 10.9215 13.4395 10.5 14.5005 10.5H27.4995C28.0249 10.5 28.5451 10.6035 29.0304 10.8045C29.5158 11.0056 29.9568 11.3002 30.3283 11.6717C30.6998 12.0432 30.9944 12.4842 31.1955 12.9696C31.3965 13.4549 31.5 13.9751 31.5 14.5005V27.4995C31.5 28.0249 31.3965 28.5451 31.1955 29.0304C30.9944 29.5158 30.6998 29.9568 30.3283 30.3283C29.9568 30.6998 29.5158 30.9944 29.0304 31.1955C28.5451 31.3965 28.0249 31.5 27.4995 31.5H14.5005C13.9751 31.5 13.4549 31.3965 12.9696 31.1955C12.4842 30.9944 12.0432 30.6998 11.6717 30.3283C11.3002 29.9568 11.0056 29.5158 10.8045 29.0304C10.6035 28.5451 10.5 28.0249 10.5 27.4995V14.5005Z"
                      stroke="black"
                      stroke-width="3"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    />
                    <path
                      d="M6.018 25.1055C5.55801 24.8433 5.17541 24.4642 4.90886 24.0067C4.64232 23.5492 4.50128 23.0295 4.5 22.5V7.5C4.5 5.85 5.85 4.5 7.5 4.5H22.5C23.625 4.5 24.237 5.0775 24.75 6"
                      stroke="black"
                      stroke-width="3"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    />
                  </svg>
                  <svg
                    id="copied-icon--mobile"
                    width="100%"
                    height="100%"
                    viewBox="0 0 36 36"
                    fill="none"
                    xmlns="http://www.w3.org/2000/svg"
                    style="display: none"
                  >
                    <path
                      d="M13.5 7.5H10.5C9.70435 7.5 8.94129 7.81607 8.37868 8.37868C7.81607 8.94129 7.5 9.70435 7.5 10.5V28.5C7.5 29.2956 7.81607 30.0587 8.37868 30.6213C8.94129 31.1839 9.70435 31.5 10.5 31.5H25.5C26.2956 31.5 27.0587 31.1839 27.6213 30.6213C28.1839 30.0587 28.5 29.2956 28.5 28.5V10.5C28.5 9.70435 28.1839 8.94129 27.6213 8.37868C27.0587 7.81607 26.2956 7.5 25.5 7.5H22.5"
                      stroke="black"
                      stroke-width="3"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    />
                    <path
                      d="M13.5 7.5C13.5 6.70435 13.8161 5.94129 14.3787 5.37868C14.9413 4.81607 15.7044 4.5 16.5 4.5H19.5C20.2956 4.5 21.0587 4.81607 21.6213 5.37868C22.1839 5.94129 22.5 6.70435 22.5 7.5C22.5 8.29565 22.1839 9.05871 21.6213 9.62132C21.0587 10.1839 20.2956 10.5 19.5 10.5H16.5C15.7044 10.5 14.9413 10.1839 14.3787 9.62132C13.8161 9.05871 13.5 8.29565 13.5 7.5Z"
                      stroke="black"
                      stroke-width="3"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    />
                    <path
                      d="M13.5 21L16.5 24L22.5 18"
                      stroke="black"
                      stroke-width="3"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    />
                  </svg>
                </button>
              </div>
            </div>
          </div>
        </section>
        <section class="tryon_section">
        </section>
        <section class="personalized_hero_section">
          <div class="text-section">
            <h1 id="heroTitle">關於你</h1>
            <p id="heroDesc">你所喜愛的細節，引領我們打造屬於你的風格藍圖。</p>
          </div>
          <div class="step-section">
            <div class="steps" id="steps-container">
              <!-- Steps will be dynamically populated via JS -->
            </div>
            <div class="btn-section">
              <button onclick="scrollToRecom()">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="22"
                  height="23"
                  viewBox="0 0 22 23"
                  fill="none"
                >
                  <path
                    d="M11 4.78516V17.6185"
                    stroke="white"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                  <path
                    d="M14.6667 13.9517L11 17.6183"
                    stroke="white"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                  <path
                    d="M7.33398 13.9517L11.0007 17.6183"
                    stroke="white"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                </svg>
                <span>查看結果</span>
              </button>
            </div>
          </div>
        </section>

        <div class="hr-section"></div>

        <section id="jump-recom" class="recom-section">
          <div class="text-section">
            <h2 id="recom_section_title-01">獨樹一幟的你，<br />量身打造的精選。</h2>
            <p id="recom_section_desc-01">每個細節，都源自你的喜好，來看看你的風格代表作。</p>
          </div>
          <div class="w-full flex justify-center">
            <div class="max-w-[1280px] mx-auto w-full">
              <div id="personalized-recommendations" class="w-full"></div>
            </div>
          </div>
        </section>

        <div class="hr-section"></div>

        <section id="jump-more" class="recom-section">
          <div class="text-section">
            <h2 id="recom_section_title-02">更多靈感推薦，<br />讓選擇更輕鬆。</h2>
            <p id="recom_section_desc-02">讓你的選擇更有層次，這些靈感推薦讓你的風格更出彩。</p>
          </div>
          <div class="w-full flex justify-center">
            <div class="max-w-[1280px] mx-auto w-full">
              <div id="more-recommendations" class="w-full"></div>
            </div>
          </div>
        </section>

        <div class="mail-section">
          <div id="sendAlert" class="send-alert"></div>
          <div class="mail-section__container">
            <div class="mail-section__text">
              <div class="mail-section__title">
                合適之選
                <br />
                直達你的信箱
              </div>
              <div class="mail-section__desc" id="mailDesc">
                根據你的尺寸與穿著偏好，精選合適商品與專屬優惠，每週為你送上。
              </div>
            </div>

            <div class="mail-section__content">
              <input
                type="text"
                id="mailSectionInput"
                class="mail-section__input"
                autocomplete="off"
                placeholder="輸入郵件"
                onkeyup="if(event.key === 'Enter') { triggerMailButton(); }"
              />
              <button
                id="mailSectionBtn"
                class="mail-section__btn"
                disabled
                onclick="sendSubscribeMail()"
              >
                <div id="mailSectionBtn--send">送出</div>
                <div id="mailSectionBtn-finish">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="20"
                    height="20"
                    viewBox="0 0 20 20"
                    fill="none"
                  >
                    <path
                      d="M4.16675 9.99998L8.33341 14.1666L16.6667 5.83331"
                      stroke="white"
                      stroke-width="3"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    />
                  </svg>
                </div>
              </button>
            </div>

            <button id="liffPromoBtn" class="liff-promo-btn" onclick="sendLiffPromoMessage()">
              取得最新優惠資訊
            </button>
          </div>
          <!-- 浮動圖片 -->
          <img
            loading="lazy"
            src="https://placehold.co/160x160"
            style="
              width: 11.11vw;
              height: 11.11vw;
              left: 22.08vw;
              top: -4.6vw;
              opacity: 0.5;
              background: #f3f3ef;
              border-radius: 9px;
              object-fit: cover;
            "
            data-depth="0.5"
          />
          <img
            loading="lazy"
            src="https://placehold.co/160x160"
            style="
              width: 11.11vw;
              height: 11.11vw;
              left: 78.96vw;
              top: 25.28vw;
              opacity: 0.5;
              background: #f3f3ef;
              border-radius: 9px;
              object-fit: cover;
            "
            data-depth="1"
          />
          <img
            loading="lazy"
            src="https://placehold.co/150x150"
            style="
              width: 10.42vw;
              height: 10.42vw;
              left: 91.39vw;
              top: 11.91vw;
              opacity: 0.6;
              border-radius: 9px;
              object-fit: cover;
            "
            data-depth="1.2"
          />
          <img
            loading="lazy"
            src="https://placehold.co/170x170"
            style="
              width: 11.81vw;
              height: 11.81vw;
              left: 70.35vw;
              top: 5.35vw;
              opacity: 0.55;
              border-radius: 9px;
              object-fit: cover;
            "
            data-depth="1.5"
          />
          <img
            loading="lazy"
            src="https://placehold.co/150x150"
            style="
              width: 10.42vw;
              height: 10.42vw;
              left: 3.96vw;
              top: 7.85vw;
              opacity: 0.4;
              border-radius: 9px;
              object-fit: cover;
            "
            data-depth="0.8"
          />
          <img
            loading="lazy"
            src="https://placehold.co/170x170"
            style="
              width: 11.81vw;
              height: 11.81vw;
              left: 12.36vw;
              top: 15.63vw;
              background: linear-gradient(0deg, rgba(0, 0, 0, 0.2) 0%, rgba(0, 0, 0, 0.2) 100%);
              border-radius: 9px;
              object-fit: cover;
            "
            data-depth="2"
          />
          <div
            class="last-img-cover"
            style="
              position: absolute;
              width: 11.81vw;
              height: 11.81vw;
              left: 12.36vw;
              top: 15.63vw;
              background: linear-gradient(0deg, rgba(0, 0, 0, 0.2) 0%, rgba(0, 0, 0, 0.2) 100%);
              border-radius: 9px;
              object-fit: cover;
              z-index: 2;
            "
            data-depth="2"
          ></div>
        </div>

        <section class="restart-section" id="restartContainer">
          <div class="text-section">
            <div class="restart-icon">
              <img src="./img/personalized/start-animation.gif" width="90" height="90" alt="" />
            </div>
            <p>還沒找到理想選擇?<br />再試一次個性化推薦!</p>
          </div>
          <div class="btn-section">
            <a href="#" onclick="goBack(event)" class="back-link">
              <button>再試一次</button>
            </a>
          </div>
        </section>
      </div>
    </section>
    <template id="emailTemplate">
      <!doctype html>
      <html lang="zh-Hant">
        <head>
          <meta charset="UTF-8" />
          <meta name="viewport" content="width=device-width, initial-scale=1.0" />
          <meta http-equiv="X-UA-Compatible" content="IE=edge" />
          <title>INFITS EDM</title>
          <style type="text/css">
            body,
            table,
            td,
            a,
            img {
              -webkit-text-size-adjust: 100%;
              -ms-text-size-adjust: 100%;
            }

            table,
            td {
              mso-table-lspace: 0pt;
              mso-table-rspace: 0pt;
            }

            img {
              -ms-interpolation-mode: bicubic;
              border: 0;
              line-height: 100%;
              outline: none;
              text-decoration: none;
            }

            body {
              margin: 0;
              padding: 0;
              width: 100% !important;
              box-sizing: border-box;
            }

            .container {
              width: 100%;
              max-width: 600px;
            }

            .embeddedItem__imgBox {
              width: 100%;
              height: 226px;
            }

            @media only screen and (max-width: 600px) {
              .container {
                width: 100% !important;
                max-width: none !important;
              }

              .full-width {
                width: 100% !important;
              }

              .hide-on-mobile {
                display: none !important;
              }

              .stack-on-mobile {
                display: block !important;
                width: 100% !important;
                max-width: 100% !important;
                padding: 0 !important;
                /* Remove all padding to avoid asymmetry */
                margin: 0 auto !important;
                /* Center the content */
                padding-bottom: 36px !important;
                /* margin-bottom: 36px !important; */
              }

              /* .stack-on-mobile:last-child {
                        padding-bottom: 0 !important;
                        margin-bottom: 0 !important;
                    } */
              .embeddedItem {
                width: 100%;
                max-width: 353px;
                margin: 0 auto;
              }

              .embeddedItem__imgBox {
                height: 353px !important;
                width: 353px !important;
                margin: 0 auto;
              }

              img.footer-logo {
                width: 100% !important;
                /* max-width: none !important; */
                height: 100% !important;
              }

              .greeting-text {
                text-align: center !important;
              }

              .padding-adjust {
                padding-left: 20px !important;
                padding-right: 20px !important;
              }

              .product-section {
                padding-left: 20px !important;
                padding-right: 20px !important;
                text-align: center !important;
              }

              .product-placeholder {
                display: block !important;
                margin: 0 auto !important;
                /* Center the placeholder content */
                text-align: center !important;
              }

              .hero-section {
                padding-left: 20px !important;
                padding-right: 20px !important;
              }

              .embeddedItemInfo__title {
                max-width: 353px !important;
              }

              .edm-hero-container {
                padding: 0 20px !important;
                padding-top: 32px !important;
              }

              .edm-title {
                color: #fff;
                text-align: center;
                font-family: 'Noto Sans TC';
                font-size: 36px;
                font-style: normal;
                font-weight: 700;
                line-height: 41px;
                letter-spacing: -0.72px;
                width: 100%;
              }

              .edm-subtitle,
              .edm-date {
                color: #ffffff;
                font-family: 'Figtree';

                font-family: 'Figtree';
                font-size: 12px;
                font-style: normal;
                font-weight: 500;
                line-height: 14px;
                /* 116.667% */
                letter-spacing: -0.24px;
              }
            }
          </style>
        </head>

        <body style="background-color: #f4f4f4; margin: 0; padding: 0">
          <table
            border="0"
            cellpadding="0"
            cellspacing="0"
            width="100%"
            style="background-color: #f4f4f4"
          >
            <tr>
              <td align="center" valign="top">
                <table
                  border="0"
                  cellpadding="0"
                  cellspacing="0"
                  class="container"
                  width="600"
                  style="max-width: 600px; background-color: #ffffff"
                >
                  <tr>
                    <td
                      align="center"
                      valign="top"
                      class="edm-hero-container"
                      style="
                        padding: 0 64px;
                        padding-top: 50px;
                        background:
                          linear-gradient(0deg, rgba(0, 0, 0, 0.2) 0%, rgba(0, 0, 0, 0.2) 100%),
                          url('http://inffits-new-officialwebsite.s3-website-ap-northeast-1.amazonaws.com/hero-bg-demo.png')
                            lightgray center / cover no-repeat;
                        width: 100%;
                        height: 400px;
                      "
                    >
                      <table border="0" cellpadding="0" cellspacing="0" width="100%">
                        <tr>
                          <td
                            class="edm-subtitle"
                            width="50%"
                            style="
                              width: 50%;
                              max-width: 50%;
                              box-sizing: border-box;
                              color: #fff;
                              font-size: 14px;
                              font-style: normal;
                              font-weight: 500;
                              line-height: 16px;
                              letter-spacing: -0.28px;
                            "
                          >
                            Just for you
                          </td>
                          <td
                            class="edm-date"
                            width="50%"
                            align="right"
                            style="
                              width: 50%;
                              max-width: 50%;
                              box-sizing: border-box;
                              color: #fff;
                              font-size: 14px;
                              font-style: normal;
                              font-weight: 500;
                              line-height: 16px;
                              letter-spacing: -0.28px;
                            "
                          >
                            Apr 10, 2025
                          </td>
                        </tr>
                        <tr>
                          <td
                            class="edm-title"
                            colspan="2"
                            style="
                              padding-top: 86px;
                              width: 100%;
                              max-width: 100%;
                              box-sizing: border-box;
                              color: #fff;
                              font-family: 'Noto Sans TC';
                              font-size: 48px;
                              font-style: normal;
                              font-weight: 700;
                              line-height: 53px;
                              letter-spacing: -0.96px;
                              text-align: center;
                            "
                          >
                            來看看<br />
                            你的風格代表作
                          </td>
                          <td></td>
                        </tr>
                        <tr>
                          <td
                            colspan="2"
                            align="center"
                            style="
                              padding-top: 122px;
                              width: 100%;
                              max-width: 100%;
                              box-sizing: border-box;
                            "
                          >
                            <table border="0" cellpadding="0" cellspacing="0" width="100%">
                              <tr>
                                <td align="right" valign="middle">
                                  <img
                                    src="http://inffits-new-officialwebsite.s3-website-ap-northeast-1.amazonaws.com/infFITS_LOGO-light.png"
                                    alt="infFITS官方標誌 - AI智慧尺寸(智能尺寸/AI找尺寸)與AI智慧選物(AI導購/AI導流)解決方案，助電商提升業績、加速選購、達成營運成長成功。"
                                    style="width: 64px; height: auto; display: inline-block"
                                  />
                                </td>
                                <td align="center" valign="middle">
                                  <span style="color: #fff; display: inline-block">｜</span>
                                </td>
                                <td align="left" valign="middle" style="padding-bottom: 8px">
                                  <img
                                    src="http://inffits-new-officialwebsite.s3-website-ap-northeast-1.amazonaws.com/guten.png"
                                    alt="guten LOGO"
                                    style="width: 64px; height: auto; display: inline-block"
                                  />
                                </td>
                              </tr>
                            </table>
                          </td>
                          <td></td>
                        </tr>
                      </table>
                    </td>
                  </tr>
                  <tr>
                    <td
                      class="greeting-text padding-adjust"
                      align="left"
                      style="
                        padding: 48px 64px;
                        font-family: Arial, sans-serif;
                        font-size: 16px;
                        color: #333333;
                        line-height: 24px;
                      "
                    >
                      <p
                        style="
                          margin: 0;
                          color: #000;
                          font-family: Figtree, Arial, sans-serif;
                          font-size: 24px;
                          font-weight: 700;
                          line-height: 26px;
                          padding-bottom: 32px;
                        "
                      >
                        Hi Duo,
                      </p>
                      <p
                        style="
                          color: #1e1e19;
                          font-family: 'Noto Sans TC', Arial, sans-serif;
                          font-size: 16px;
                          font-weight: 400;
                          line-height: 21px;
                          letter-spacing: 0.32px;
                        "
                      >
                        根據你的喜好，這些精選推薦正是為你量身打造的風格之選。此外，別錯過專屬優惠，為你的選擇增添更多驚喜。
                      </p>
                    </td>
                  </tr>
                  <tr>
                    <td class="product-section" align="center" style="padding: 0 64px">
                      <table border="0" cellpadding="0" cellspacing="0" width="100%">
                        <tr>
                          <td
                            class="stack-on-mobile product-placeholder"
                            width="50%"
                            style="
                              width: 50%;
                              max-width: 50%;
                              box-sizing: border-box;
                              padding-bottom: 32px;
                            "
                          ></td>
                          <td
                            class="stack-on-mobile product-placeholder"
                            width="50%"
                            align="right"
                            style="
                              width: 50%;
                              max-width: 50%;
                              box-sizing: border-box;
                              padding-bottom: 32px;
                            "
                          ></td>
                        </tr>
                        <tr>
                          <td
                            class="stack-on-mobile product-placeholder"
                            width="50%"
                            style="
                              width: 50%;
                              max-width: 50%;
                              box-sizing: border-box;
                              padding-bottom: 32px;
                            "
                          ></td>
                          <td
                            class="stack-on-mobile product-placeholder"
                            align="right"
                            width="50%"
                            style="
                              width: 50%;
                              max-width: 50%;
                              box-sizing: border-box;

                              padding-bottom: 32px;
                            "
                          ></td>
                        </tr>
                        <tr>
                          <td
                            class="stack-on-mobile product-placeholder"
                            width="50%"
                            style="
                              width: 50%;
                              max-width: 50%;
                              box-sizing: border-box;
                              padding-bottom: 32px;
                            "
                          ></td>
                          <td
                            class="stack-on-mobile product-placeholder"
                            align="right"
                            width="50%"
                            style="
                              width: 50%;
                              max-width: 50%;
                              box-sizing: border-box;

                              padding-bottom: 32px;
                            "
                          ></td>
                        </tr>
                        <tr>
                          <td
                            class="stack-on-mobile product-placeholder"
                            width="50%"
                            style="width: 50%; max-width: 50%; box-sizing: border-box"
                          ></td>
                          <td
                            class="stack-on-mobile product-placeholder"
                            align="right"
                            width="50%"
                            style="width: 50%; max-width: 50%; box-sizing: border-box"
                          ></td>
                        </tr>
                      </table>
                    </td>
                  </tr>
                  <tr>
                    <td
                      class="padding-adjust"
                      align="left"
                      style="
                        padding: 48px 64px;
                        font-family: Arial, sans-serif;
                        font-size: 16px;
                        color: #333333;
                        line-height: 24px;
                      "
                    >
                      <p
                        style="
                          color: #1e1e19;
                          font-family: 'Noto Sans TC', Arial, sans-serif;
                          font-size: 16px;
                          font-weight: 400;
                          line-height: 21px;
                          letter-spacing: 0.32px;
                        "
                      >
                        心動不如馬上行動! 使用折扣碼
                        <span style="color: #e65824">[GIFT2025]</span> 享有 9
                        折優惠，把握最佳時機入手你的風格代表作!
                      </p>
                    </td>
                  </tr>
                  <tr>
                    <td class="padding-adjust" align="center" style="padding-bottom: 48px">
                      <table border="0" cellpadding="0" cellspacing="0">
                        <tr>
                          <td
                            align="center"
                            style="
                              background-color: rgba(0, 0, 0, 0.95);
                              padding: 14px 20px;
                              border-radius: 8px;
                            "
                          >
                            <a
                              href="https://www.jerscy.com.tw/"
                              style="
                                color: #fff;
                                font-family: 'Noto Sans TC', Arial, sans-serif;
                                font-size: 17px;
                                font-weight: 500;
                                line-height: 22px;
                                letter-spacing: 0.34px;
                                text-decoration: none;
                              "
                              >前往購物</a
                            >
                          </td>
                        </tr>
                      </table>
                    </td>
                  </tr>
                  <tr>
                    <td
                      class="padding-adjust"
                      align="left"
                      style="padding: 64px; background-color: #000000"
                    >
                      <img
                        src="http://inffits-new-officialwebsite.s3-website-ap-northeast-1.amazonaws.com/infFITS_LOGO-light.png"
                        alt="infFITS_LOGO"
                        class="footer-logo"
                        style="
                          width: 100px;
                          max-width: 100px;
                          max-height: 22px;
                          object-fit: contain;
                          margin-bottom: 72px;
                          display: block;
                        "
                      />
                      <p style="margin-bottom: 14px">
                        <a
                          href="#"
                          style="
                            color: #e8e8e8;
                            font-family: 'Noto Sans TC', Arial, sans-serif;
                            font-size: 16px;
                            line-height: 18px;
                            letter-spacing: 0.32px;
                            font-weight: 500;
                            text-decoration: none;
                          "
                          >取消訂閱</a
                        >
                      </p>
                      <p style="margin-bottom: 14px">
                        <a
                          href="http://inffits-new-officialwebsite.s3-website-ap-northeast-1.amazonaws.com/site/privacy"
                          style="
                            color: #e8e8e8;
                            font-family: 'Noto Sans TC', Arial, sans-serif;
                            font-size: 16px;
                            line-height: 18px;
                            letter-spacing: 0.32px;
                            font-weight: 500;
                            text-decoration: none;
                          "
                          >隱私權聲明</a
                        >
                      </p>
                      <p style="margin-bottom: 36px">
                        <a
                          href="http://inffits-new-officialwebsite.s3-website-ap-northeast-1.amazonaws.com/site/terms"
                          style="
                            color: #e8e8e8;
                            font-family: 'Noto Sans TC', Arial, sans-serif;
                            font-size: 16px;
                            line-height: 18px;
                            letter-spacing: 0.32px;
                            font-weight: 500;
                            text-decoration: none;
                          "
                          >使用條款</a
                        >
                      </p>
                      <p
                        style="
                          color: #a3a39f;
                          font-family: 'Figtree', Arial, sans-serif;
                          font-size: 16px;
                          line-height: 21px;
                          font-weight: 500;
                        "
                      >
                        infFITS (飛德科技股份有限公司)<br />
                        Hsinchu City, Taiwan
                      </p>
                    </td>
                  </tr>
                </table>
              </td>
            </tr>
          </table>
        </body>
      </html>
    </template>
    <script src="./js/tryon-carousel-utils.js"></script>
    <script>
      const params = new URLSearchParams(window.location.search)
      let Brand = params.get('brand') || ''
      const randomGen = !!Brand ? 'false' : 'true'
      if (randomGen ==='true') {
        Brand = 'JERSCY'
      }
      const link = params.get('link') || params.get('Link') || ''
      const tryOn = params.get('tryon') || 'false'
      const type = params.get('type') || 'pd'
      const TRYON_COPILOT_ENDPOINT = 'https://api.inffits.com/pid_get_copilot_status/model'
      const TRYON_COMPANION_SOURCE = {
        brand: 'DABE',
        // productId: '10108161',
        Link: link
      }
      const tryonCarouselState = {
        images: [],
        currentIndex: 0,
        autoplayTimer: null,
        controlsBound: false,
        isDragging: false,
        dragStartX: 0,
        dragCurrentX: 0,
        dragStartTime: 0,
        lastMoveTime: 0,
        lastMoveX: 0,
        velocity: 0,
        animationFrame: null
      }
      const tryonScrollCarouselState = {
        images: [],
        controlsBound: false,
        isModalOpen: false,
        lastFocusedElement: null,
        modalAnimationTimer: null
      }
      let isTryonIframeFallback = false
      let fakeData = {}
      let isCopied = false
      let isFetchCouponCalled = false
      let customEdm = []
      let tryonCompanionAssetsLoading = false
      let tryonCompanionAssetsLoaded = false
      const defaultEdmItems = [
        {
          image_link:
            'https://img.shoplineapp.com/media/image_clips/66f3a479776575000dab9267/original.jpg?1727243384',
          price: '990',
          prectype: 'tee',
          size_tag: 'M',
          link: 'https://www.jerscy.com.tw/products/66f29881e6d86a00019e27a0?letiation=66f2988783324a0001816667',
          pid: '66f29881e6d86a00019e27a0',
          id: '66f29881e6d86a00019e27a0',
          availability: 'out of stock',
          title: '造型長袖超級重磅TEE｜全新造型・造型更加分',
          sale_price: '940',
          status: 'available',
          dbid: 'all_ALL'
        },
        {
          image_link:
            'https://img.shoplineapp.com/media/image_clips/670a55e8c051c818d50caf05/original.jpg?1728730600',
          price: '1,290',
          prectype: 'pants',
          size_tag: 'M',
          link: 'https://www.jerscy.com.tw/products/670929aefe05db00018abeaa?letiation=670929b0372c34000163626f',
          pid: '670929aefe05db00018abeaa',
          id: '670929aefe05db00018abeaa',
          availability: 'in stock',
          title: '天絲彈力休閒西裝褲',
          sale_price: '',
          status: 'available',
          dbid: 'all_ALL'
        },
        {
          image_link:
            'https://img.shoplineapp.com/media/image_clips/6540b7d14b96889acbb1292b/original.jpg?1698740176',
          price: '690',
          prectype: 'tee',
          size_tag: 'M',
          link: 'https://www.jerscy.com.tw/products/6540b11af914420001e6dd6a?letiation=6540b11ba857420001604f8b',
          pid: '6540b11af914420001e6dd6a',
          id: '6540b11af914420001e6dd6a',
          availability: 'out of stock',
          title: '【第2件免費】新質感長袖TEE｜NEW ESSENCE・關鍵剪裁・完美修身',
          sale_price: '',
          status: 'available',
          dbid: 'all_ALL'
        },
        {
          image_link:
            'https://img.shoplineapp.com/media/image_clips/645244be096aa6001719a446/original.jpg?1683113150',
          fb_product_category: 'clothing & accessories > clothing',
          gender: 'male',
          link: 'https://www.jerscy.com.tw/products/64523497ad97a416e7d6eeb0?letiation=645234966c09a3001b15657a',
          description:
            '終極重磅TEE系列。11.4oz全新厚度，全新磅數，感受更硬挺的紮實厚度。採用空氣渦流紡，結合超緊密織法，滑順且極低毛羽布料，告別夏日穿著素T粘膩感。不僅如此，布料更耐水洗且不易起毬。精挑細選色彩，讓你看到的每一色都好搭配。',
          pid: '64523497ad97a416e7d6eeb0',
          availability: 'in stock',
          title: '拉格蘭 終極重磅TEE｜強勢力作・終極11.4OZ厚磅素T',
          sale_price: '711',
          condition: 'new',
          product_type: '人氣系列 &gt; 重磅TEE系列 &gt; 寬版休閒',
          price: '790',
          prectype: 'tee',
          size_tag: 'S',
          id: '64523497ad97a416e7d6eeb0',
          google_product_category: 'Apparel & Accessories > Clothing',
          brand: 'JERSCY',
          status: 'available',
          dbid: 'all_ALL'
        },
        {
          image_link:
            'https://img.shoplineapp.com/media/image_clips/64d3683173f9c70016f69439/original.jpg?1691576368',
          fb_product_category: 'clothing & accessories > clothing',
          gender: 'male',
          link: 'https://www.jerscy.com.tw/products/5e6f5bdeecd74c0557568d7f?letiation=643615b8a9c67a02a7a6ef7e',
          description:
            '業界唯一導入NASA太空等級Ionic+® 銀離子抗菌除臭科技，解決夏日流汗導致汗臭問題。採用10.9oz布料為基底，超級重磅口袋TEE全新設計，經典重現，簡約時尚隨性百搭，獨家開發重磅布料，挑戰市場最具份量最耐洗的重磅口袋素T，解決男生穿著素T激凸和超耐洗的最佳解決方案！美國棉Cotton USA認證，全程台灣製，精緻細工質感細節，網友評比CP值最高重磅素T。提醒一下，怕重不要穿！',
          pid: '5e6f5bdeecd74c0557568d7f',
          availability: 'in stock',
          title: '超級重磅口袋TEE｜10.9OZ高磅不激凸・升級銀離子抗菌除臭科技・打造不臭口袋素T',
          sale_price: '676',
          condition: 'new',
          product_type: '人氣系列 &gt; 重磅TEE系列 &gt; 合身俐落',
          price: '690',
          prectype: 'tee',
          size_tag: 'M',
          id: '5e6f5bdeecd74c0557568d7f',
          google_product_category: 'Apparel & Accessories > Clothing > Shirts & Tops',
          brand: 'JERSCY',
          status: 'available',
          dbid: 'all_ALL'
        },
        {
          image_link:
            'https://img.shoplineapp.com/media/image_clips/66388f8aaef15e001df53940/original.jpg?1714982793',
          price: '590',
          prectype: 'tee',
          size_tag: 'M',
          link: 'https://www.jerscy.com.tw/products/66383cc18826fb00014a2104?letiation=66383cc208fcd800019a4ece',
          pid: '66383cc18826fb00014a2104',
          id: '66383cc18826fb00014a2104',
          availability: 'in stock',
          title: '【超殺買1送1】涼感TEE｜涼爽透氣・吸汗速乾機能・四季首選舒適棉T',
          sale_price: '',
          status: 'available',
          dbid: 'all_ALL'
        }
      ]

      document.addEventListener('DOMContentLoaded', async (event) => {
        // console.log('DOM 完全加载和解析')
        const heroTitleElement = document.getElementById('heroTitle')
        const heroDescElement = document.getElementById('heroDesc')
        const recomTitleElement = document.getElementById('recom_section_title-01')
        const recomDescElement = document.getElementById('recom_section_desc-01')
        const recomTitleElement2 = document.getElementById('recom_section_title-02')
        const recomDescElement2 = document.getElementById('recom_section_desc-02')
        const restartContainer = document.getElementById('restartContainer')
        const mailDescElement = document.getElementById('mailDesc')
        if (type === 'pd') {
          heroTitleElement.textContent = '關於你'
          recomTitleElement.textContent = '獨樹一幟的你，\n量身打造的精選。'
          recomDescElement.textContent = '每個細節，都源自你的喜好，來看看你的風格代表作。'
          recomTitleElement2.textContent = '更多靈感推薦，\n讓選擇更輕鬆。'
          recomDescElement2.textContent = '讓你的選擇更有層次，這些靈感推薦讓你的風格更出彩。'
          heroDescElement.textContent = '你所喜愛的細節，引領我們打造屬於你的風格藍圖。'
          mailDescElement.textContent =
            '每週將為你整理專屬風格推薦與新品資訊，不錯過任何靈感與好物。'
          fakeData = {
            coupon: {
              text: '以九折優惠，\n開啟專屬你的風格之選。',
              code: 'GIFT2025',
              img_desktop: './img/personalized/coupon-bg-desktop.png',
              img_mobile: './img/personalized/coupon-bg-mobile.png',
              timeValid: [],
              status: false
            },
            personalized_recommendation: {
              title: '',
              description: '',
              ctype_val: '',
              status: false
            },
            more_recommendation: {
              title: '',
              description: '',
              ctype_val: '',
              status: false
            },
            tags: [
              {
                TagGroup: '著衣風格',
                Name: '丹寧'
              },
              {
                TagGroup: '風格與場合',
                Name: '休閒'
              },
              {
                TagGroup: '穿著偏好',
                Name: '適中'
              },
              {
                TagGroup: '版型與特色',
                Name: '透氣'
              }
            ]
          }
        }
        if (type === 'size') {
          fakeData = {
            coupon: {
              text: '以九折優惠，\n迎接更自在的著衣感受。',
              code: 'GIFT2025',
              img_desktop: './img/personalized/size-coupon-bg-desktop.png',
              img_mobile: './img/personalized/size-coupon-bg-mobile.png',
              timeValid: [],
              status: false
            },
            personalized_recommendation: {
              title: '',
              description: '',
              ctype_val: '',
              status: false
            },
            more_recommendation: {
              title: '',
              description: '',
              ctype_val: '',
              status: false
            },
            tags: [
              {
                TagGroup: '上身尺寸',
                Name: 'S'
              },
              {
                TagGroup: '內衣尺寸',
                Name: '32A'
              },
              {
                TagGroup: '下身尺寸',
                Name: 'M'
              },
              {
                TagGroup: '洋裝尺寸',
                Name: 'S'
              }
            ]
          }
          await fetchCoupon()
          updateTryOnView()
          heroTitleElement.textContent = '量身尺寸表'
          recomTitleElement.textContent = fakeData.personalized_recommendation.title
          recomDescElement.textContent = fakeData.personalized_recommendation.description
          recomTitleElement2.textContent = fakeData.more_recommendation.title
          recomDescElement2.textContent = fakeData.more_recommendation.description

          heroDescElement.textContent = '以你的身形為本，打造恰到好處的合身感受。'
          mailDescElement.textContent =
            '根據你的尺寸與穿著偏好，精選合適商品與專屬優惠，每週為你送上。'
          restartContainer.style.display = 'none'
        }
        updateCouponBackground()

        const couponTextElements = document.querySelectorAll('.coupon-text')
        couponTextElements.forEach((el) => {
          el.textContent = fakeData.coupon.text || ''
        })

        const couponCodeElements = document.querySelectorAll('.coupon-code')
        couponCodeElements.forEach((el) => {
          el.textContent = fakeData.coupon.code || ''
        })

        // Hide coupon text and code if status is false
        if (fakeData.coupon.status === false) {
          const couponTextElements = document.querySelectorAll('.coupon-text')
          const couponCodeElements = document.querySelectorAll('.coupon-code')
          const couponCopyElements = document.querySelectorAll('.coupon-copy')

          couponTextElements.forEach((el) => {
            el.style.display = 'none'
          })

          couponCodeElements.forEach((el) => {
            el.style.display = 'none'
          })

          couponCopyElements.forEach((el) => {
            el.style.display = 'none'
          })
        }
        updateMailSectionBtnState()

        // 輸入時即時更新按鈕狀態
        document
          .getElementById('mailSectionInput')
          .addEventListener('input', updateMailSectionBtnState)

        const tags =
          randomGen === 'true'
            ? fakeData.tags
            : JSON.parse(sessionStorage.getItem('inf-ai-tags') || '[]')
        customEdm =
          randomGen === 'true'
            ? defaultEdmItems
            : JSON.parse(sessionStorage.getItem('inf-ai-edm-items') || '[]')

        // const images = document.querySelectorAll('.mail-section img')
        // images.forEach((img, index) => {
        //   if (index < customEdm.length) {
        //     img.src = customEdm[index].image_link // Set the new src from API
        //   } else {
        //     console.warn(`No URL available for image at index ${index}`)
        //   }
        // })
        
        // 新增函式：從推薦區塊抓取圖片更新 mail-section
        function updateMailSectionImages() {
          // console.log('🖼️ 開始更新 mail-section 圖片...')
          
          const mailImages = document.querySelectorAll('.mail-section img[data-depth]')
          const collectedImages = []
          
          // 檢查推薦容器是否存在
          const personalizedContainer = document.getElementById('personalized-recommendations')
          const moreContainer = document.getElementById('more-recommendations')
          
          // console.log('🔍 容器檢查:')
          // console.log(`  personalized-recommendations: ${personalizedContainer ? '存在' : '不存在'}`)
          // console.log(`  more-recommendations: ${moreContainer ? '存在' : '不存在'}`)
          
          if (personalizedContainer) {
            // console.log(`  personalized-recommendations 內容長度: ${personalizedContainer.innerHTML.length}`)
            // console.log(`  personalized-recommendations 預覽: ${personalizedContainer.innerHTML.substring(0, 100)}...`)
          }
          
          // 1. 先從 personalized-recommendations 抓取
          const personalizedImgs = document.querySelectorAll('#personalized-recommendations .embeddedItem__imgBox img')
          // console.log(`🔍 找到 ${personalizedImgs.length} 個 personalized-recommendations 圖片元素`)
          
          personalizedImgs.forEach((img, index) => {
            // console.log(`  第${index + 1}個圖片 src: ${img.src}`)
            if (img.src && !img.src.includes('placehold.co')) {
              collectedImages.push(img.src)
              // console.log(`  ✅ 已收集: ${img.src}`)
            } else {
              // console.log(`  ❌ 跳過: ${img.src} (無效或是 placeholder)`)
            }
          })
          
          // console.log(`📦 從 personalized-recommendations 抓到 ${collectedImages.length} 張圖片`)
          
          // 2. 如果不足 6 張，從 more-recommendations 補足
          if (collectedImages.length < 6) {
            const moreImgs = document.querySelectorAll('#more-recommendations .embeddedItem__imgBox img')
            // console.log(`🔍 找到 ${moreImgs.length} 個 more-recommendations 圖片元素`)
            
            moreImgs.forEach((img, index) => {
              if (collectedImages.length >= 6) return // 已經足夠 6 張
              // console.log(`  第${index + 1}個圖片 src: ${img.src}`)
              if (img.src && !img.src.includes('placehold.co') && !collectedImages.includes(img.src)) {
                collectedImages.push(img.src)
                // console.log(`  ✅ 已收集: ${img.src}`)
              } else {
                // console.log(`  ❌ 跳過: ${img.src} (無效、重複或是 placeholder)`)
              }
            })
            
            // console.log(`📦 補足後共有 ${collectedImages.length} 張圖片`)
          }
          
          // 3. 如果還是不足 6 張，不再用假圖填滿
          // while (collectedImages.length < 6) {
          //   collectedImages.push(placeholderImages[collectedImages.length])
          // }
          
          // console.log(`✅ 最終共有 ${collectedImages.length} 張圖片`)
          
          // 4. 更新 mail-section 的圖片
          mailImages.forEach((img, index) => {
            if (index < collectedImages.length) {
              img.src = collectedImages[index]
              // console.log(`🖼️ 更新第 ${index + 1} 張圖片:`, collectedImages[index])
            }
          })
          
          // console.log('✅ mail-section 圖片更新完成')
        }
        
        // 加到 window 對象供全域使用
        window.updateMailSectionImages = updateMailSectionImages
        
        // 初始更新一次（使用原本的 customEdm）
        // images.forEach((img, index) => {
        //   if (index < customEdm.length) {
        //     img.src = customEdm[index].image_link
        //   } else {
        //     console.warn(`No URL available for image at index ${index}`)
        //   }
        // })

        // Redirect if no tags are found or tryOn is false
        if (tags.length <= 0 || tryOn === 'false') {
          goBack()
        }

        // 先執行 updateTryOnView
        updateTryOnView();

        // 等待 DOM 更新完成後再執行 api_Products
        setTimeout(() => {
          api_Products(Brand);
        }, 100);

        // 加载并执行 embedded.js
        const script = document.createElement('script')
        script.src = './embedded.js'
        script.onload = () => {
          // 初始化全局配置存儲
          window.productRecommendationConfigs = {}
          
          // 將參數傳遞給 Product_Recommendation 函數並存儲配置
          const personalizedConfig = {
            brand: Brand,
            containerId: 'personalized-recommendations',
            backgroundColor: 'transparent',
            title: '',
            customPadding: '0px',
            // customEdm: customEdm,  // 註解掉，讓它使用 API 動態資料
            arrowPosition: 'center', // none, center, top (default: center)
            autoplay: false,
            hide_size: true,
            hide_discount: true,
            ctype_val: fakeData.personalized_recommendation.ctype_val.split(','),
            bid: {},
            breakpoints: {
              768: {
                slidesPerView: 4,
                slidesPerGroup: 4,
                spaceBetween: 24,
                grid: {
                  rows: 1,
                  fill: 'row'
                }
              },
              0: {
                slidesPerView: 2.5,
                slidesPerGroup: 2,
                spaceBetween: 12,
                grid: {
                  rows: 1,
                  fill: 'row'
                }
              }
            }
          }
          
          const moreRecommendationsConfig = {
            brand: Brand,
            containerId: 'more-recommendations',
            backgroundColor: 'transparent',
            title: '',
            customPadding: '0px',
            arrowPosition: 'center', // none, center, top (default: center)
            autoplay: false,
            hide_size: true,
            hide_discount: true,
            ctype_val: fakeData.more_recommendation.ctype_val.split(','),
            bid: {},
            breakpoints: {
              768: {
                slidesPerView: 4,
                slidesPerGroup: 4,
                spaceBetween: 24,
                grid: {
                  rows: 1,
                  fill: 'row'
                }
              },
              0: {
                slidesPerView: 2.5,
                slidesPerGroup: 2,
                spaceBetween: 12,
                grid: {
                  rows: 1,
                  fill: 'row'
                }
              }
            }
          }
          
          // 存儲配置到全局變數
          window.productRecommendationConfigs['personalized-recommendations'] = personalizedConfig
          window.productRecommendationConfigs['more-recommendations'] = moreRecommendationsConfig
          
          // 調用 Product_Recommendation 函數
          window.Product_Recommendation(personalizedConfig)
          window.Product_Recommendation(moreRecommendationsConfig)
          
          // 啟動圖片監聽器，監聽推薦區塊圖片變化並即時更新 mail-section
          if (typeof startImageObserver === 'function') {
            startImageObserver()
          } else {
            // console.warn('⚠️ startImageObserver 函數不存在，將延遲啟動...')
            setTimeout(() => {
              if (typeof startImageObserver === 'function') {
                startImageObserver()
              }
            }, 1000)
          }
        }
        script.onerror = () => console.error('无法加载 embedded.js')
        document.body.appendChild(script)

        // Populate steps dynamically
        const stepsContainer = document.getElementById('steps-container')
        stepsContainer.innerHTML = '' // 清空容器
        if (type === 'size') {
          stepsContainer.classList.add('steps-container--size')
        } else {
          if (tags.length >= 4) {
            stepsContainer.classList.add('two-columns')
          } else {
            stepsContainer.classList.remove('two-columns')
          }
        }

        tags.forEach((tag, i) => {
          const stepContainer = document.createElement('div')
          stepContainer.className = 'step-container'

          const stepText = document.createElement('div')
          stepText.className = 'step-text'
          stepText.innerHTML = `
                  <p>${tag.Name}</p>
                <span>  ${type === 'pd' ? `0${i + 1}` : ''} ${tag.TagGroup}</span>
                `
          stepContainer.appendChild(stepText)
          stepsContainer.appendChild(stepContainer)
        })

        // console.log('轉換後的數據:', tags)

        const floatingImages = document.querySelectorAll('.mail-section *[data-depth]')
        document.addEventListener('mousemove', (e) => {
          const x = e.clientX / window.innerWidth - 0.5
          const y = e.clientY / window.innerHeight - 0.5

          floatingImages.forEach((img) => {
            const depth = parseFloat(img.dataset.depth) || 1
            const moveX = x * depth * 30
            const moveY = y * depth * 30
            img.style.transform = `translate(${moveX}px, ${moveY}px)`
          })
        })
      })

      async function api_Products(Brand) {
  let Gender_ClothID;
  let dataUrl = "https://api.inffits.com/httpgpi/model";
  let Payload = {
    Brand: Brand,
    url: link || Brand,
    CONFIG: "on",
    // DB: "on"
    "91APP": "on"
    // hostname: document.location.hostname
  };

  await fetch(dataUrl, {
    method: "POST",
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(Payload)
  })
  .then(response => response.json())
  .then(res => {
    let Results = res;
    if (!Results || !Results["Gender_ClothID"]) {
      handleTryonIframeFallback()
      return
    }
    Gender_ClothID = Results["Gender_ClothID"];
    const ctryonWindow = document.getElementById('inffits_ctryon_window');
    if (ctryonWindow) {
      ctryonWindow.setAttribute('src',
        'https://inffits.com/webDesign/HTML/js/iframe/indexwebiframe_CAX_tw_' +
        Brand.toLowerCase() + '.html?' + Gender_ClothID
      );
    }
    
    let SizeAIFast_switch = true;
    window.addEventListener('message', function (event) {
      if (event.data["MsgHeader"] == "IDRxReady") {
        let member_id = "";
        let given_id = "";
        let lgiven_id = "";
        let tryonwindow = document.getElementById("inffits_ctryon_window").contentWindow;
        
        // Always Generate a pair of GVID
        let gvid_exist = false;
        try {
          if (typeof localStorage["GVID"] !== 'undefined') {
            gvid_exist = true;
          }
        } catch (e) {
          gvid_exist = false;
        }
        
        if (gvid_exist) {
          given_id = localStorage["GVID"];
        } else {
          given_id = makeid(20);
          localStorage.setItem("GVID", given_id);
        }
        
        // Always Generate a pair of LGVID
        let lgvid_exist = false;
        try {
          if (typeof localStorage["LGVID"] !== 'undefined') {
            lgvid_exist = true;
          }
        } catch (e) {
          lgvid_exist = false;
        }
        
        if (lgvid_exist) {
          lgiven_id = localStorage["LGVID"];
        } else {
          lgiven_id = makeid(20);
          localStorage.setItem("LGVID", lgiven_id);
        }

        const test = true; // 添加 test 參數
        IDRxGet(member_id, given_id, tryonwindow, lgiven_id, test, SizeAIFast_switch);

        //Flow Adjustment
        const ctryonWindow = document.getElementById("inffits_ctryon_window");
        if (ctryonWindow) {
          ctryonWindow.contentWindow.postMessage(
            { MsgHeader: "RemoveWaistFlow" }, 
            "*"
          );
        }
      }
    }, false);
  })
  .catch(error => {
    console.error('Error:', error);
  });
}

      function handleTryonIframeFallback() {
        if (isTryonIframeFallback) return
        isTryonIframeFallback = true
        const iframeBlock = document.getElementById('inffits_cblock')
        if (iframeBlock) {
          iframeBlock.style.display = 'none'
        }
        const inlineGallery = document.getElementById('tryonGalleryInline')
        if (inlineGallery) {
          inlineGallery.hidden = false
          inlineGallery.classList.add('tryon-gallery-inline--visible')
        }
        const scrollGallery = document.querySelector('.tryon-scroll-gallery')
        const tryonScrollViewAll = document.querySelector('#tryonScrollViewAll')
        if (scrollGallery) {
          scrollGallery.style.display = 'none'
        }
        if (tryonScrollViewAll) {
          tryonScrollViewAll.style.display = 'none'
        }
        renderTryonGalleryInline()
      }

      function updateTryOnView() {
        const tryOnSection = document.querySelector('.tryon_section')
        const personalizedHeroSection = document.querySelector('.personalized_hero_section')
        if (tryOnSection && tryOn === 'true') {
          tryOnSection.innerHTML = `
          <div class="text-section">
            <h2 id="tryon_section_title">您的專屬試衣間</h2>
            <p id="tryon_section_desc">根據你的身形資訊，精選舒適好物，讓每次穿搭更自在自信。</p>
          </div>
          <div class="tryon-showcase">
            <div class="tryon-showcase__body">
              <div class="tryon-showcase__iframe">
                <div id="inffits_cblock">
                  <div
                    id="ctryon"
                    style="
                      margin: auto;
                      top: 0px;
                      text-align: left;
                      visibility: visible;
                      outline: none;
                      border: solid 1px rgb(245, 245, 245);
                    "
                  >
                    <iframe
                      id="inffits_ctryon_window"
                      style="
                        width: 100%;
                        height: 100%;
                        visibility: visible;
                        border: none;
                        outline: none;
                        z-index: 14;
                      "
                      src=""
                      data-gtm-yt-inspected-39="true"
                    ></iframe>
                  </div>
                </div>
                <div class="tryon-gallery-inline" id="tryonGalleryInline" hidden>
                  <div class="tryon-gallery-inline__header">
                    <h3 class="tryon-gallery-inline__title">穿搭靈感推薦</h3>
                    <p class="tryon-gallery-inline__summary" id="tryonGalleryInlineSummary">
                      暫無穿搭圖片
                    </p>
                  </div>
                  <div class="tryon-gallery-inline__content" id="tryonGalleryInlineContent">
                    <p class="tryon-gallery-inline__empty">暫無穿搭圖片</p>
                  </div>
                </div>
              </div>
              <div class="tryon-showcase__side-panel">
                <div class="tryon-qr" aria-live="polite">
                  <div class="tryon-qr__header">
                    <span class="tryon-qr__badge" id="tryonProductBadge">專屬推薦
                      </span>
                    <p class="tryon-qr__hint" style="display: none;">立即掃碼結帳獲取更多優惠。</p>
                  </div>
                  <div class="tryon-qr__body">
                    <img
                      id="tryonQrImage"
                      class="tryon-qr__image"
                      src=""
                      alt="同步購物 QR code"
                      loading="lazy"
                    />
                    <div class="tryon-qr__meta">
                      <p class="tryon-qr__name" id="tryonProductName">載入專屬推薦中...</p>
                      <span class="tryon-qr__sku" id="tryonProductSku"></span>
                      <a
                        id="tryonProductLink"
                        class="tryon-qr__cta tryon-qr__cta--disabled"
                        href="#"
                        target="_blank"
                        rel="noopener noreferrer"
                        aria-disabled="true"
                        style="display: none;"
                      >
                        前往商品頁
                      </a>

                      <button type="button" class="tryon-scroll-gallery__cta" id="tryonScrollViewAll" disabled>
                        <span class="tryon-scroll-gallery__cta-label">查看更多穿搭靈感</span>
                      </button>
                    </div>
                  </div>
                </div>
                <div class="tryon-carousel" aria-live="polite">
                  <div class="tryon-carousel__header">
                    <span class="tryon-carousel__title">商品細節預覽</span>
                    <span class="tryon-carousel__status" id="tryonCarouselStatus">載入中...</span>
                  </div>
                  <div class="tryon-carousel__viewport" id="tryonCarouselViewport" tabindex="0">
                    <ul class="tryon-carousel__track" id="tryonCarouselTrack">
                      <li class="tryon-carousel__slide tryon-carousel__slide--active">
                        <div class="tryon-carousel__loading" id="tryonCarouselLoading">載入圖片中...</div>
                      </li>
                    </ul>
                  </div>
                  <div class="tryon-carousel__controls">
                    <button
                      type="button"
                      class="tryon-carousel__btn tryon-carousel__btn--prev"
                      id="tryonCarouselPrev"
                      aria-label="上一張"
                    >
                      ←
                    </button>
                    <button
                      type="button"
                      class="tryon-carousel__btn tryon-carousel__btn--next"
                      id="tryonCarouselNext"
                      aria-label="下一張"
                    >
                      →
                    </button>
                  </div>
                </div>
                <div class="tryon-scroll-gallery" aria-live="polite" style="display: none;">
                  <button type="button" class="tryon-scroll-gallery__cta" id="tryonScrollViewAll" disabled>
                    <span class="tryon-scroll-gallery__cta-label">查看更多穿搭靈感</span>
                  </button>
                  <p class="tryon-scroll-gallery__count" id="tryonScrollCount">載入穿搭靈感中...</p>
              </div>
                <div class="tryon-gallery-modal" id="tryonGalleryModal" aria-hidden="true">
                  <div class="tryon-gallery-modal__overlay" id="tryonGalleryModalOverlay"></div>
                  <div
                    class="tryon-gallery-modal__dialog"
                    role="dialog"
                    aria-modal="true"
                    aria-labelledby="tryonGalleryModalTitle"
                    tabindex="-1"
                  >
                    <div class="tryon-gallery-modal__header">
                      <h3 class="tryon-gallery-modal__title" id="tryonGalleryModalTitle">穿搭靈感推薦</h3>
                    <button
                      type="button"
                        class="tryon-gallery-modal__close"
                        id="tryonGalleryModalClose"
                        aria-label="關閉穿搭靈感視窗"
                      >
                        ×
                    </button>
                    </div>
                    <div class="tryon-gallery-modal__content" id="tryonGalleryModalContent">
                      <p class="tryon-gallery-modal__empty">載入穿搭靈感中...</p>
                    </div>
                  </div>
                </div>
                <!-- 全螢幕圖片瀏覽器 -->
                <div class="fullscreen-viewer" id="fullscreenViewer" aria-hidden="true">
                  <div class="fullscreen-viewer__overlay" id="fullscreenViewerOverlay"></div>
                  <div class="fullscreen-viewer__container">
                    <div class="fullscreen-viewer__header">
                      <span class="fullscreen-viewer__counter" id="fullscreenCounter">1/1</span>
                      <button
                        type="button"
                        class="fullscreen-viewer__close"
                        id="fullscreenViewerClose"
                        aria-label="關閉全螢幕瀏覽"
                      >
                        ×
                      </button>
                    </div>
                    <div class="fullscreen-viewer__main">
                      <div class="fullscreen-viewer__image-wrapper" id="fullscreenImageWrapper">
                        <img
                          class="fullscreen-viewer__image"
                          id="fullscreenImage"
                          src=""
                          alt="商品細節"
                        />
                      </div>
                      <button
                        type="button"
                        class="fullscreen-viewer__nav fullscreen-viewer__nav--prev"
                        id="fullscreenViewerPrev"
                        aria-label="上一張圖片"
                      >
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                          <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                      </button>
                      <button
                        type="button"
                        class="fullscreen-viewer__nav fullscreen-viewer__nav--next"
                        id="fullscreenViewerNext"
                        aria-label="下一張圖片"
                      >
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                          <path d="M9 18L15 12L9 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                      </button>
                    </div>
                    <div class="fullscreen-viewer__thumbnails" id="fullscreenThumbnails">
                      <!-- 縮圖將由 JS 動態生成 -->
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <style media="screen and (min-width:441px)">
            #inffits_cblock {
              margin: auto;
              height: 700px;
              width: 440px;
            }
            #ctryon {
              margin: auto;
              height: 700px;
              width: 440px;
            }
          </style>
          <style media="screen and (min-width:424px) and (max-width:440px)">
            #inffits_cblock {
              margin: auto;
              height: 640px;
              width: 400px;
            }
            #ctryon {
              margin: auto;
              height: 640px;
              width: 400px;
            }
          </style>
          <style media="screen and (min-width:361px) and (max-width:424px)">
            #inffits_cblock {
              margin: auto;
              height: 600px;
              width: 360px;
            }
            #ctryon {
              margin: auto;
              height: 600px;
              width: 360px;
            }
          </style>
          <style media="screen and (max-width: 360px) ">
            #inffits_cblock {
              margin: auto;
              height: 580px;
              width: 320px;
            }
            #ctryon {
              margin: auto;
              height: 580px;
              width: 320px;
            }
          </style>
          <div id="inffits_cblock_tail"></div>
          `
          personalizedHeroSection.style.display = 'none'
          tryOnSection.style.display = 'flex'
          requestAnimationFrame(() => {
            initTryonCompanion()
          })
        } else {
          tryOnSection.innerHTML = ''
          personalizedHeroSection.style.display = 'flex'
          tryOnSection.style.display = 'none'
          resetTryonCompanion()
        }
      }

      /**
       * 初始化試衣 QR 與圖片輪播
       */
      function initTryonCompanion() {
        if (tryOn !== 'true') return
        if (typeof TryonCarouselUtils === 'undefined') {
          console.warn('TryonCarouselUtils 尚未載入，無法建立輪播')
          return
        }
        bindTryonCarouselControls()
        bindTryonScrollControls()
        fetchTryonCompanionAssets()
      }

      /**
       * 呼叫 Copilot API 取得輪播資源
       */
      async function fetchTryonCompanionAssets() {
        // 依據 MDN（防止重複發送 fetch 請求）的建議，加入 loading/loaded 旗標避免重複呼叫 API
        if (tryonCompanionAssetsLoading || tryonCompanionAssetsLoaded) {
          return
        }
        tryonCompanionAssetsLoading = true
        const loadingEl = document.getElementById('tryonCarouselLoading')
        if (loadingEl) {
          loadingEl.style.display = 'flex'
        }
        try {
          const payload = TryonCarouselUtils.createCopilotPayload(
            TRYON_COMPANION_SOURCE.brand,
            // TRYON_COMPANION_SOURCE.productId
            TRYON_COMPANION_SOURCE.Link
          )
          const response = await fetch(TRYON_COPILOT_ENDPOINT, {
            method: 'POST',
            headers: {
              accept: 'application/json',
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
          })
          if (!response.ok) {
            throw new Error(`Copilot API 回應異常：${response.status}`)
          }
          const result = await response.json()
          const normalized = TryonCarouselUtils.transformCopilotPayload(result)
          renderTryonCompanion(normalized)
          tryonCompanionAssetsLoaded = true
        } catch (error) {
          console.error('載入試衣輪播失敗：', error)
          showTryonCompanionError()
        } finally {
          tryonCompanionAssetsLoading = false
          if (loadingEl) {
            loadingEl.style.display = 'none'
          }
        }
      }

      /**
       * 將 API 整理後的資料寫入介面
       * @param {{images: string[], heroImage: string, productName: string, productSku: string, productLink: string}} payload
       */
      function renderTryonCompanion(payload) {
        const { images, galleryImages, heroImage, productName, productSku, productLink } = payload
        const nameEl = document.getElementById('tryonProductName')
        if (nameEl) {
          nameEl.textContent = productName || '暫無商品資訊'
        }

        const skuEl = document.getElementById('tryonProductSku')
        if (skuEl) {
          if (productSku) {
            skuEl.textContent = `款式編號｜${productSku}`
            skuEl.style.display = 'block'
          } else {
            skuEl.textContent = ''
            skuEl.style.display = 'none'
          }
        }

        const linkEl = document.getElementById('tryonProductLink')
        if (linkEl) {
          linkEl.removeEventListener('click', handleDisabledTryonLink)
          if (productLink) {
            linkEl.href = productLink
            linkEl.classList.remove('tryon-qr__cta--disabled')
            linkEl.setAttribute('aria-disabled', 'false')
          } else {
            linkEl.href = '#'
            linkEl.classList.add('tryon-qr__cta--disabled')
            linkEl.setAttribute('aria-disabled', 'true')
            linkEl.addEventListener('click', handleDisabledTryonLink)
          }
        }

        const qrImageEl = document.getElementById('tryonQrImage')
        if (qrImageEl) {
          qrImageEl.src = TryonCarouselUtils.buildQrImageUrl(productLink)
          qrImageEl.alt = productName ? `${productName} QR code` : '同步購物 QR code'
        }

        // 商品細節預覽使用 coverimage_url（正方形）
        const detailImages =
          images && images.length
            ? images
            : heroImage
            ? [heroImage]
            : []

        // 穿搭靈感推薦使用 image_url（高長方形）
        const inspirationImages =
          Array.isArray(galleryImages) && galleryImages.length
            ? galleryImages
            : []

        setTryonCarouselImages(detailImages)
        setTryonScrollImages(inspirationImages)
      }

      /**
       * 顯示載入失敗狀態
       */
      function showTryonCompanionError() {
        const nameEl = document.getElementById('tryonProductName')
        if (nameEl) {
          nameEl.textContent = '暫時無法載入商品資訊'
        }
        const statusEl = document.getElementById('tryonCarouselStatus')
        if (statusEl) {
          statusEl.textContent = '載入失敗'
        }
        const trackEl = document.getElementById('tryonCarouselTrack')
        if (trackEl) {
          trackEl.innerHTML = ''
          const empty = document.createElement('li')
          empty.className = 'tryon-carousel__empty'
          empty.textContent = '請稍後再試，圖片載入暫停。'
          trackEl.appendChild(empty)
        }
        showTryonScrollFallback('暫時無法載入穿搭圖片')
      }

      /**
       * 設定輪播圖片資料
       * @param {string[]} images
       */
      function setTryonCarouselImages(images) {
        tryonCarouselState.images = Array.isArray(images) ? images.slice(0, 8) : []
        tryonCarouselState.currentIndex = 0
        renderTryonCarouselSlides()
        restartTryonCarouselAutoplay()
      }

      /**
       * 依照目前索引渲染輪播
       */
      function renderTryonCarouselSlides() {
        const trackEl = document.getElementById('tryonCarouselTrack')
        if (!trackEl) return
        trackEl.innerHTML = ''

        if (!tryonCarouselState.images.length) {
          const placeholder = document.createElement('li')
          placeholder.className = 'tryon-carousel__empty'
          placeholder.textContent = '暫無可用圖片'
          trackEl.appendChild(placeholder)
          updateTryonCarouselStatus()
          return
        }

        tryonCarouselState.images.forEach((url, index) => {
          const slide = document.createElement('li')
          slide.className = 'tryon-carousel__slide'
          if (index === tryonCarouselState.currentIndex) {
            slide.classList.add('tryon-carousel__slide--active')
          }
          const img = document.createElement('img')
          img.src = url
          img.alt = `商品細節預覽 ${index + 1}`
          img.loading = 'lazy'
          slide.appendChild(img)
          trackEl.appendChild(slide)
        })
        updateTryonCarouselStatus()
      }

      /**
       * 更新顯示中的張數狀態
       */
      function updateTryonCarouselStatus() {
        const statusEl = document.getElementById('tryonCarouselStatus')
        if (!statusEl) return
        const total = tryonCarouselState.images.length
        if (!total) {
          statusEl.textContent = '0/0'
          return
        }
        statusEl.textContent = `${tryonCarouselState.currentIndex + 1}/${total}`
      }

      /**
       * 輪播換圖
       * @param {number} step
       */
      function changeTryonCarouselSlide(step) {
        const total = tryonCarouselState.images.length
        if (!total) return
        tryonCarouselState.currentIndex = (tryonCarouselState.currentIndex + step + total) % total
        renderTryonCarouselSlides()
      }

      /**
       * 啟動自動輪播
       */
      function restartTryonCarouselAutoplay() {
        pauseTryonCarouselAutoplay()
        if (tryonCarouselState.images.length <= 1) return
        tryonCarouselState.autoplayTimer = setInterval(() => {
          changeTryonCarouselSlide(1)
        }, 6000)
      }

      /**
       * 暫停自動輪播
       */
      function pauseTryonCarouselAutoplay() {
        if (tryonCarouselState.autoplayTimer) {
          clearInterval(tryonCarouselState.autoplayTimer)
          tryonCarouselState.autoplayTimer = null
        }
      }

      /**
       * 綁定輪播控制元件
       */
      function bindTryonCarouselControls() {
        if (tryonCarouselState.controlsBound) return
        const prevBtn = document.getElementById('tryonCarouselPrev')
        const nextBtn = document.getElementById('tryonCarouselNext')
        const viewport = document.getElementById('tryonCarouselViewport')

        if (prevBtn) {
          prevBtn.addEventListener('click', () => {
            changeTryonCarouselSlide(-1)
            restartTryonCarouselAutoplay()
          })
        }
        if (nextBtn) {
          nextBtn.addEventListener('click', () => {
            changeTryonCarouselSlide(1)
            restartTryonCarouselAutoplay()
          })
        }
        if (viewport) {
          viewport.addEventListener('mouseenter', pauseTryonCarouselAutoplay)
          viewport.addEventListener('mouseleave', restartTryonCarouselAutoplay)
          viewport.addEventListener('focusin', pauseTryonCarouselAutoplay)
          viewport.addEventListener('focusout', restartTryonCarouselAutoplay)
          bindTryonCarouselDrag(viewport)
        }
        tryonCarouselState.controlsBound = true
      }

      /**
       * 綁定商品細節預覽輪播的拖拽功能（水平拖拽）
       * @param {HTMLElement} viewport
       */
      function bindTryonCarouselDrag(viewport) {
        if (!viewport) return

        const handleStart = (clientX) => {
          if (tryonCarouselState.images.length <= 1) return
          if (tryonCarouselState.animationFrame) {
            cancelAnimationFrame(tryonCarouselState.animationFrame)
            tryonCarouselState.animationFrame = null
          }
          tryonCarouselState.isDragging = true
          tryonCarouselState.dragStartX = clientX
          tryonCarouselState.dragCurrentX = clientX
          tryonCarouselState.dragStartTime = Date.now()
          tryonCarouselState.lastMoveTime = Date.now()
          tryonCarouselState.lastMoveX = clientX
          tryonCarouselState.velocity = 0
          pauseTryonCarouselAutoplay()
          viewport.classList.add('tryon-carousel__viewport--dragging')
        }

        const handleMove = (clientX) => {
          if (!tryonCarouselState.isDragging) return
          const now = Date.now()
          const timeDelta = now - tryonCarouselState.lastMoveTime
          
          if (timeDelta > 0) {
            const distanceDelta = clientX - tryonCarouselState.lastMoveX
            tryonCarouselState.velocity = distanceDelta / timeDelta
          }
          
          tryonCarouselState.dragCurrentX = clientX
          tryonCarouselState.lastMoveX = clientX
          tryonCarouselState.lastMoveTime = now
          
          const dragDistance = tryonCarouselState.dragCurrentX - tryonCarouselState.dragStartX
          const viewportWidth = viewport.offsetWidth
          const dragRatio = dragDistance / viewportWidth
          
          if (tryonCarouselState.animationFrame) {
            cancelAnimationFrame(tryonCarouselState.animationFrame)
          }
          tryonCarouselState.animationFrame = requestAnimationFrame(() => {
            updateTryonCarouselDragTransform(dragRatio)
          })
        }

        const handleEnd = () => {
          if (!tryonCarouselState.isDragging) return
          
          if (tryonCarouselState.animationFrame) {
            cancelAnimationFrame(tryonCarouselState.animationFrame)
            tryonCarouselState.animationFrame = null
          }
          
          const dragDistance = tryonCarouselState.dragCurrentX - tryonCarouselState.dragStartX
          const viewportWidth = viewport.offsetWidth
          const dragRatio = dragDistance / viewportWidth
          const absVelocity = Math.abs(tryonCarouselState.velocity)
          const threshold = viewportWidth * 0.2
          const velocityThreshold = 0.5

          viewport.classList.remove('tryon-carousel__viewport--dragging')
          
          // 恢復 transition 以實現平滑動畫
          const trackEl = document.getElementById('tryonCarouselTrack')
          if (trackEl) {
            const slides = trackEl.querySelectorAll('.tryon-carousel__slide')
            slides.forEach((slide) => {
              slide.style.transition = 'opacity 0.35s cubic-bezier(0.33, 1, 0.68, 1), transform 0.35s cubic-bezier(0.33, 1, 0.68, 1)'
            })
          }

          // 根據距離和速度決定是否切換
          const shouldSwitch = Math.abs(dragDistance) > threshold || absVelocity > velocityThreshold
          
          if (shouldSwitch) {
            // 切換到下一張
            if (dragDistance > 0 || tryonCarouselState.velocity > 0) {
              changeTryonCarouselSlide(-1)
            } else {
              changeTryonCarouselSlide(1)
            }
          } else {
            // 回到原位置
            resetTryonCarouselDragTransform()
          }

          tryonCarouselState.isDragging = false
          tryonCarouselState.dragStartX = 0
          tryonCarouselState.dragCurrentX = 0
          tryonCarouselState.velocity = 0
          restartTryonCarouselAutoplay()
        }

        // 滑鼠事件
        viewport.addEventListener('mousedown', (e) => {
          e.preventDefault()
          handleStart(e.clientX)
        })

        document.addEventListener('mousemove', (e) => {
          if (tryonCarouselState.isDragging) {
            e.preventDefault()
            handleMove(e.clientX)
          }
        })

        document.addEventListener('mouseup', () => {
          handleEnd()
        })

        // 觸摸事件
        viewport.addEventListener('touchstart', (e) => {
          if (e.touches.length === 1) {
            handleStart(e.touches[0].clientX)
          }
        }, { passive: false })

        viewport.addEventListener('touchmove', (e) => {
          if (tryonCarouselState.isDragging && e.touches.length === 1) {
            e.preventDefault()
            handleMove(e.touches[0].clientX)
          }
        }, { passive: false })

        viewport.addEventListener('touchend', () => {
          handleEnd()
        })

        viewport.addEventListener('touchcancel', () => {
          handleEnd()
        })
      }

      /**
       * 更新商品細節預覽拖拽時的 transform
       * @param {number} dragRatio - 拖拽比例 (-1 到 1)
       */
      function updateTryonCarouselDragTransform(dragRatio) {
        const trackEl = document.getElementById('tryonCarouselTrack')
        if (!trackEl) return
        const slides = trackEl.querySelectorAll('.tryon-carousel__slide')
        if (!slides.length) return

        const currentIndex = tryonCarouselState.currentIndex
        const total = slides.length
        // 使用更平滑的緩動函數
        const easedRatio = dragRatio < 0 
          ? -Math.pow(Math.abs(dragRatio), 0.8)
          : Math.pow(dragRatio, 0.8)
        const clampedRatio = Math.max(-1, Math.min(1, easedRatio))

        slides.forEach((slide, index) => {
          let translateX = 0
          let opacity = 0
          let scale = 1

          if (index === currentIndex) {
            translateX = clampedRatio * 100
            scale = 1 - Math.abs(clampedRatio) * 0.08
            opacity = 1 - Math.abs(clampedRatio) * 0.5
          } else if (index === (currentIndex - 1 + total) % total && clampedRatio > 0) {
            translateX = (clampedRatio - 1) * 100
            scale = 0.92 + Math.abs(clampedRatio) * 0.08
            opacity = Math.abs(clampedRatio) * 0.9
          } else if (index === (currentIndex + 1) % total && clampedRatio < 0) {
            translateX = (clampedRatio + 1) * 100
            scale = 0.92 + Math.abs(clampedRatio) * 0.08
            opacity = Math.abs(clampedRatio) * 0.9
          }

          slide.style.transform = `translateX(${translateX}%) scale(${scale})`
          slide.style.opacity = Math.max(0, Math.min(1, opacity))
        })
      }

      /**
       * 重置商品細節預覽拖拽 transform
       */
      function resetTryonCarouselDragTransform() {
        const trackEl = document.getElementById('tryonCarouselTrack')
        if (!trackEl) return
        const slides = trackEl.querySelectorAll('.tryon-carousel__slide')
        slides.forEach((slide) => {
          slide.style.transform = ''
          slide.style.opacity = ''
          slide.style.transition = ''
        })
      }

      /**
       * 重置輪播狀態
       */
      function resetTryonCompanion() {
        pauseTryonCarouselAutoplay()
        tryonCarouselState.images = []
        tryonCarouselState.currentIndex = 0
        const trackEl = document.getElementById('tryonCarouselTrack')
        if (trackEl) {
          trackEl.innerHTML = ''
        }
        tryonScrollCarouselState.images = []
        showTryonScrollFallback('暫無穿搭圖片')
        closeTryonScrollModal({ restoreFocus: false })
      }

      /**
       * 設定穿搭靈感圖片清單
       * @param {string[]} images
       */
      function setTryonScrollImages(images) {
        tryonScrollCarouselState.images = Array.isArray(images) ? images.slice() : []
        updateTryonScrollButtonState()
        renderTryonGalleryModal()
      }

      /**
       * 更新穿搭按鈕狀態與提示
       */
      function updateTryonScrollButtonState() {
        const countEl = document.getElementById('tryonScrollCount')
        const ctaEls = document.querySelectorAll('#tryonScrollViewAll')
        if (!countEl || !ctaEls.length) return
        const total = tryonScrollCarouselState.images.length
        const shouldPulse =
          typeof TryonCarouselUtils !== 'undefined'
            ? TryonCarouselUtils.shouldHighlightTryonScrollCta(total)
            : total > 0

        if (!total) {
          countEl.textContent = '暫無穿搭圖片'
          ctaEls.forEach((ctaEl) => {
            ctaEl.disabled = true
            ctaEl.setAttribute('aria-disabled', 'true')
          })
          toggleTryonScrollCtaPulse(false)
          return
        }
        countEl.textContent = `共 ${total} 張穿搭靈感`
        ctaEls.forEach((ctaEl) => {
          ctaEl.disabled = false
          ctaEl.setAttribute('aria-disabled', 'false')
        })
        toggleTryonScrollCtaPulse(shouldPulse)
      }

      /**
       * 控制 CTA 脈衝效果（依照 WCAG 2.4.7 焦點可視原則避免過度動畫）
       * @param {boolean} isActive
       */
      function toggleTryonScrollCtaPulse(isActive) {
        const ctaEls = document.querySelectorAll('#tryonScrollViewAll')
        if (!ctaEls.length) return
        ctaEls.forEach((ctaEl) => {
          if (!ctaEl) return
          ctaEl.classList.toggle('tryon-scroll-gallery__cta--pulse', Boolean(isActive))
        })
      }

      /**
       * 取得穿搭彈窗動畫設定
       * 依據 Material Design Motion Duration 建議，並針對瀏覽器缺省值提供 fallback
       * @returns {{enterDuration: number, exitDuration: number}}
       */
      function getTryonModalAnimationConfig() {
        const fallback = { enterDuration: 420, exitDuration: 320 }
        if (
          typeof TryonCarouselUtils !== 'undefined' &&
          typeof TryonCarouselUtils.getTryonModalAnimationSpec === 'function'
        ) {
          const spec = TryonCarouselUtils.getTryonModalAnimationSpec()
          if (
            spec &&
            Number.isFinite(spec.enterDuration) &&
            Number.isFinite(spec.exitDuration)
          ) {
            return spec
          }
        }
        return fallback
      }

      /**
       * 渲染彈窗內容
       */
      function renderTryonGalleryModal() {
        renderTryonGalleryContent(
          document.getElementById('tryonGalleryModalContent'),
          {
            emptyClass: 'tryon-gallery-modal__empty',
            itemClass: 'tryon-gallery-modal__item'
          }
        )
        renderTryonGalleryInline()
      }

      function renderTryonGalleryInline() {
        if (!isTryonIframeFallback) return
        const inlineWrapper = document.getElementById('tryonGalleryInline')
        if (inlineWrapper) {
          inlineWrapper.hidden = false
          inlineWrapper.classList.add('tryon-gallery-inline--visible')
        }
        const summaryEl = document.getElementById('tryonGalleryInlineSummary')
        if (summaryEl) {
          const total = tryonScrollCarouselState.images.length
          summaryEl.textContent = total
            ? `共 ${total} 張穿搭靈感`
            : '暫無穿搭圖片'
        }
        renderTryonGalleryContent(
          document.getElementById('tryonGalleryInlineContent'),
          {
            emptyClass: 'tryon-gallery-inline__empty',
            itemClass: 'tryon-gallery-inline__item'
          }
        )
      }

      /**
       * 預加載圖片
       * @param {string} url - 圖片網址
       * @returns {Promise<HTMLImageElement>}
       */
      function preloadTryonImage(url) {
        return new Promise((resolve, reject) => {
          const img = new Image()
          img.onload = () => resolve(img)
          img.onerror = reject
          img.src = url
        })
      }

      /**
       * 批次預加載圖片（優先加載前幾張）
       * @param {string[]} urls - 圖片網址陣列
       * @param {number} priority - 優先加載數量
       */
      function preloadTryonImages(urls, priority = 3) {
        if (!urls || !urls.length) return Promise.resolve([])
        
        // 優先加載前幾張圖片
        const priorityUrls = urls.slice(0, priority)
        const remainingUrls = urls.slice(priority)
        
        // 先加載優先圖片
        const priorityPromises = priorityUrls.map(url => 
          preloadTryonImage(url).catch(err => {
            console.warn('圖片預加載失敗:', url, err)
            return null
          })
        )
        
        // 優先圖片加載完後，再加載剩餘圖片
        Promise.all(priorityPromises).then(() => {
          remainingUrls.forEach(url => {
            preloadTryonImage(url).catch(err => {
              console.warn('圖片預加載失敗:', url, err)
            })
          })
        })
        
        return Promise.all(priorityPromises)
      }

      function renderTryonGalleryContent(targetEl, options = {}) {
        if (!targetEl) return
        const { emptyClass = 'tryon-gallery-modal__empty', itemClass = 'tryon-gallery-modal__item' } = options
        targetEl.innerHTML = ''
        if (!tryonScrollCarouselState.images.length) {
          const empty = document.createElement('p')
          empty.className = emptyClass
          empty.textContent = '暫無穿搭圖片'
          targetEl.appendChild(empty)
          return
        }
        tryonScrollCarouselState.images.forEach((url, index) => {
          const item = document.createElement('figure')
          item.className = itemClass
          const img = document.createElement('img')
          img.alt = `穿搭靈感推薦 ${index + 1}`
          
          // 圖片加載完成處理
          img.onload = function() {
            this.classList.add('tryon-img-loaded')
            item.classList.add('tryon-img-container-loaded')
          }
          
          // 圖片加載失敗處理
          img.onerror = function() {
            item.classList.add('tryon-img-container-loaded')
            console.warn('穿搭圖片加載失敗:', url)
          }
          
          // 設置 src 觸發加載
          img.src = url
          
          // 對於前幾張圖片使用 eager 加載，其餘使用 lazy
          img.loading = index < 3 ? 'eager' : 'lazy'
          
          item.appendChild(img)
          targetEl.appendChild(item)
        })
      }

      /**
       * 顯示穿搭靈感載入失敗狀態
       * @param {string} message
       */
      function showTryonScrollFallback(message) {
        tryonScrollCarouselState.images = []
        const countEl = document.getElementById('tryonScrollCount')
        if (countEl) {
          countEl.textContent = message || '暫無穿搭圖片'
        }
        const ctaEls = document.querySelectorAll('#tryonScrollViewAll')
        ctaEls.forEach((ctaEl) => {
          ctaEl.disabled = true
          ctaEl.setAttribute('aria-disabled', 'true')
        })
        toggleTryonScrollCtaPulse(false)
        const contentEl = document.getElementById('tryonGalleryModalContent')
        if (contentEl) {
          contentEl.innerHTML = ''
          const empty = document.createElement('p')
          empty.className = 'tryon-gallery-modal__empty'
          empty.textContent = message || '暫無穿搭圖片'
          contentEl.appendChild(empty)
        }
        renderTryonGalleryInline()
      }

      /**
       * 綁定彈窗控制
       */
      function bindTryonScrollControls() {
        if (tryonScrollCarouselState.controlsBound) return
        const openBtn = document.getElementById('tryonScrollViewAll')
        const closeBtn = document.getElementById('tryonGalleryModalClose')
        const overlay = document.getElementById('tryonGalleryModalOverlay')
        if (openBtn) {
          openBtn.addEventListener('click', openTryonScrollModal)
        }
        if (closeBtn) {
          closeBtn.addEventListener('click', () => closeTryonScrollModal())
        }
        if (overlay) {
          overlay.addEventListener('click', () => closeTryonScrollModal())
        }
        document.addEventListener('keydown', handleTryonGalleryKeydown)
        tryonScrollCarouselState.controlsBound = true
        
        // 綁定全螢幕瀏覽器控制
        bindFullscreenViewerControls()
      }

      // ========== 全螢幕圖片瀏覽器邏輯 ==========
      const fullscreenViewerState = {
        isOpen: false,
        currentIndex: 0,
        images: [],
        scale: 1,
        translateX: 0,
        translateY: 0,
        isDragging: false,
        startX: 0,
        startY: 0,
        lastX: 0,
        lastY: 0,
        controlsBound: false,
        animationTimer: null
      }

      /**
       * 綁定全螢幕瀏覽器事件
       */
      function bindFullscreenViewerControls() {
        if (fullscreenViewerState.controlsBound) return
        
        const closeBtn = document.getElementById('fullscreenViewerClose')
        const overlay = document.getElementById('fullscreenViewerOverlay')
        const prevBtn = document.getElementById('fullscreenViewerPrev')
        const nextBtn = document.getElementById('fullscreenViewerNext')
        const imageWrapper = document.getElementById('fullscreenImageWrapper')
        
        console.log('🔧 綁定全螢幕瀏覽器控制:', { prevBtn, nextBtn })
        
        if (closeBtn) {
          closeBtn.addEventListener('click', closeFullscreenViewer)
        }
        if (overlay) {
          overlay.addEventListener('click', closeFullscreenViewer)
        }
        if (prevBtn) {
          console.log('✅ 上一張按鈕已找到並綁定')
          prevBtn.addEventListener('click', (e) => {
            console.log('⬅️ 上一張按鈕被點擊！')
            e.stopPropagation()
            e.preventDefault()
            changeFullscreenImage(-1)
          })
          // 添加 mousedown 測試
          prevBtn.addEventListener('mousedown', () => {
            console.log('🖱️ 上一張按鈕 mousedown')
          })
        } else {
          console.error('❌ 找不到上一張按鈕')
        }
        if (nextBtn) {
          console.log('✅ 下一張按鈕已找到並綁定')
          nextBtn.addEventListener('click', (e) => {
            console.log('➡️ 下一張按鈕被點擊！')
            e.stopPropagation()
            e.preventDefault()
            changeFullscreenImage(1)
          })
          // 添加 mousedown 測試
          nextBtn.addEventListener('mousedown', () => {
            console.log('🖱️ 下一張按鈕 mousedown')
          })
        } else {
          console.error('❌ 找不到下一張按鈕')
        }
        
        // 圖片雙擊縮放
        if (imageWrapper) {
          imageWrapper.addEventListener('dblclick', toggleFullscreenZoom)
          // 觸控雙擊
          let lastTap = 0
          imageWrapper.addEventListener('touchend', (e) => {
            const currentTime = new Date().getTime()
            const tapLength = currentTime - lastTap
            if (tapLength < 300 && tapLength > 0) {
              e.preventDefault()
              toggleFullscreenZoom(e)
            }
            lastTap = currentTime
          })
          
          // 拖拽功能
          bindFullscreenDragEvents(imageWrapper)
        }
        
        // 鍵盤導航
        document.addEventListener('keydown', handleFullscreenKeydown)
        
        // 綁定輪播圖點擊事件
        bindCarouselImageClick()
        
        fullscreenViewerState.controlsBound = true
      }

      /**
       * 綁定商品輪播圖點擊開啟全螢幕
       */
      function bindCarouselImageClick() {
        const trackEl = document.getElementById('tryonCarouselTrack')
        if (!trackEl) {
          console.warn('⚠️ tryonCarouselTrack 元素不存在')
          return
        }
        
        console.log('✅ 綁定輪播圖點擊事件')
        
        // 使用事件委派
        trackEl.addEventListener('click', (e) => {
          console.log('🖱️ tryonCarouselTrack 被點擊', e.target)
          
          const slide = e.target.closest('.tryon-carousel__slide')
          if (!slide) {
            console.log('⚠️ 點擊的不是 slide 元素')
            return
          }
          
          const slides = Array.from(trackEl.querySelectorAll('.tryon-carousel__slide'))
          const clickedIndex = slides.indexOf(slide)
          
          console.log('📊 輪播狀態:', {
            所有slides數量: slides.length,
            點擊的slide索引: clickedIndex,
            輪播圖片陣列長度: tryonCarouselState.images.length,
            當前輪播索引: tryonCarouselState.currentIndex,
            圖片陣列: tryonCarouselState.images
          })
          
          if (clickedIndex !== -1 && tryonCarouselState.images.length > 0) {
            // 使用當前輪播的索引而不是點擊的 slide 索引
            // 因為輪播可能有多個 slide，但只有一個是 active 的
            const actualIndex = tryonCarouselState.currentIndex
            console.log('🎯 開啟全螢幕，使用索引:', actualIndex)
            openFullscreenViewer(tryonCarouselState.images, actualIndex)
          } else {
            console.warn('❌ 無法開啟全螢幕:', { clickedIndex, imagesLength: tryonCarouselState.images.length })
          }
        })
      }

      /**
       * 開啟全螢幕瀏覽器
       * @param {string[]} images - 圖片陣列
       * @param {number} startIndex - 起始索引
       */
      function openFullscreenViewer(images, startIndex = 0) {
        if (!images || !images.length) return
        
        console.log('📸 開啟全螢幕瀏覽器，圖片數量:', images.length, '起始索引:', startIndex)
        
        fullscreenViewerState.images = images
        fullscreenViewerState.currentIndex = startIndex
        fullscreenViewerState.scale = 1
        fullscreenViewerState.translateX = 0
        fullscreenViewerState.translateY = 0
        
        const viewer = document.getElementById('fullscreenViewer')
        if (!viewer) {
          console.error('❌ 找不到 fullscreenViewer 元素')
          return
        }
        
        if (fullscreenViewerState.animationTimer) {
          clearTimeout(fullscreenViewerState.animationTimer)
          fullscreenViewerState.animationTimer = null
        }
        
        viewer.classList.remove('fullscreen-viewer--closing')
        viewer.classList.add('fullscreen-viewer--open')
        
        requestAnimationFrame(() => {
          requestAnimationFrame(() => {
            viewer.classList.add('fullscreen-viewer--visible')
          })
        })
        
        viewer.setAttribute('aria-hidden', 'false')
        document.body.classList.add('fullscreen-viewer-open')
        fullscreenViewerState.isOpen = true
        
        // 渲染內容
        renderFullscreenImage()
        renderFullscreenThumbnails()
        updateFullscreenNavButtons()
        
        // 確認按鈕存在
        setTimeout(() => {
          const prevBtn = document.getElementById('fullscreenViewerPrev')
          const nextBtn = document.getElementById('fullscreenViewerNext')
          console.log('🔍 檢查按鈕狀態:', {
            prevBtn存在: !!prevBtn,
            nextBtn存在: !!nextBtn,
            prevBtn樣式: prevBtn ? window.getComputedStyle(prevBtn).display : 'N/A',
            nextBtn樣式: nextBtn ? window.getComputedStyle(nextBtn).display : 'N/A',
            prevBtn位置: prevBtn ? prevBtn.getBoundingClientRect() : 'N/A',
            nextBtn位置: nextBtn ? nextBtn.getBoundingClientRect() : 'N/A'
          })
        }, 500)
      }

      /**
       * 關閉全螢幕瀏覽器
       */
      function closeFullscreenViewer() {
        const viewer = document.getElementById('fullscreenViewer')
        if (!viewer) return
        
        if (fullscreenViewerState.animationTimer) {
          clearTimeout(fullscreenViewerState.animationTimer)
        }
        
        viewer.classList.add('fullscreen-viewer--closing')
        viewer.classList.remove('fullscreen-viewer--visible')
        viewer.setAttribute('aria-hidden', 'true')
        fullscreenViewerState.isOpen = false
        
        fullscreenViewerState.animationTimer = setTimeout(() => {
          viewer.classList.remove('fullscreen-viewer--open', 'fullscreen-viewer--closing')
          document.body.classList.remove('fullscreen-viewer-open')
        }, 280)
      }

      /**
       * 渲染當前圖片
       */
      function renderFullscreenImage() {
        const img = document.getElementById('fullscreenImage')
        const counter = document.getElementById('fullscreenCounter')
        const wrapper = document.getElementById('fullscreenImageWrapper')
        
        if (!img || !fullscreenViewerState.images.length) return
        
        const currentUrl = fullscreenViewerState.images[fullscreenViewerState.currentIndex]
        
        // 重置縮放和位移
        fullscreenViewerState.scale = 1
        fullscreenViewerState.translateX = 0
        fullscreenViewerState.translateY = 0
        updateImageTransform()
        
        if (wrapper) {
          wrapper.classList.remove('fullscreen-viewer__image-wrapper--zoomed')
        }
        
        // 移除已加載類別，觸發淡入動畫
        img.classList.remove('fullscreen-viewer__image--loaded')
        
        img.onload = function() {
          this.classList.add('fullscreen-viewer__image--loaded')
        }
        
        img.src = currentUrl
        img.alt = `商品細節 ${fullscreenViewerState.currentIndex + 1}`
        
        if (counter) {
          counter.textContent = `${fullscreenViewerState.currentIndex + 1}/${fullscreenViewerState.images.length}`
        }
      }

      /**
       * 渲染縮圖列表
       */
      function renderFullscreenThumbnails() {
        const container = document.getElementById('fullscreenThumbnails')
        if (!container) return
        
        container.innerHTML = ''
        
        fullscreenViewerState.images.forEach((url, index) => {
          const thumb = document.createElement('button')
          thumb.className = 'fullscreen-viewer__thumbnail'
          thumb.type = 'button'
          thumb.setAttribute('aria-label', `查看第 ${index + 1} 張圖片`)
          
          if (index === fullscreenViewerState.currentIndex) {
            thumb.classList.add('fullscreen-viewer__thumbnail--active')
          }
          
          const img = document.createElement('img')
          img.src = url
          img.alt = `縮圖 ${index + 1}`
          
          thumb.appendChild(img)
          thumb.addEventListener('click', () => {
            fullscreenViewerState.currentIndex = index
            renderFullscreenImage()
            renderFullscreenThumbnails()
            updateFullscreenNavButtons()
          })
          
          container.appendChild(thumb)
        })
        
        // 滾動到當前縮圖
        const activeThumb = container.querySelector('.fullscreen-viewer__thumbnail--active')
        if (activeThumb) {
          activeThumb.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' })
        }
      }

      /**
       * 切換圖片
       * @param {number} step - 步數（-1 或 1）
       */
      function changeFullscreenImage(step) {
        const total = fullscreenViewerState.images.length
        if (!total) return
        
        console.log('🖼️ 切換圖片:', step > 0 ? '下一張' : '上一張', '當前索引:', fullscreenViewerState.currentIndex)
        
        fullscreenViewerState.currentIndex = (fullscreenViewerState.currentIndex + step + total) % total
        renderFullscreenImage()
        renderFullscreenThumbnails()
        updateFullscreenNavButtons()
      }

      /**
       * 更新導航按鈕狀態
       */
      function updateFullscreenNavButtons() {
        const prevBtn = document.getElementById('fullscreenViewerPrev')
        const nextBtn = document.getElementById('fullscreenViewerNext')
        const total = fullscreenViewerState.images.length
        
        if (!prevBtn || !nextBtn || total <= 1) return
        
        // 循環模式，按鈕始終可用
        prevBtn.disabled = false
        nextBtn.disabled = false
      }

      /**
       * 雙擊縮放切換
       */
      function toggleFullscreenZoom(e) {
        const wrapper = document.getElementById('fullscreenImageWrapper')
        if (!wrapper) return
        
        if (fullscreenViewerState.scale > 1) {
          // 縮小到原始大小
          fullscreenViewerState.scale = 1
          fullscreenViewerState.translateX = 0
          fullscreenViewerState.translateY = 0
          wrapper.classList.remove('fullscreen-viewer__image-wrapper--zoomed')
        } else {
          // 放大到 2 倍
          fullscreenViewerState.scale = 2
          
          // 計算點擊位置，讓圖片以該點為中心放大
          const rect = wrapper.getBoundingClientRect()
          const clientX = e.clientX || (e.touches && e.touches[0] ? e.touches[0].clientX : rect.left + rect.width / 2)
          const clientY = e.clientY || (e.touches && e.touches[0] ? e.touches[0].clientY : rect.top + rect.height / 2)
          
          const x = clientX - rect.left - rect.width / 2
          const y = clientY - rect.top - rect.height / 2
          
          fullscreenViewerState.translateX = -x * 0.5
          fullscreenViewerState.translateY = -y * 0.5
          
          wrapper.classList.add('fullscreen-viewer__image-wrapper--zoomed')
        }
        
        updateImageTransform()
      }

      /**
       * 綁定拖拽事件
       */
      function bindFullscreenDragEvents(wrapper) {
        const handleStart = (e) => {
          if (fullscreenViewerState.scale <= 1) return
          
          fullscreenViewerState.isDragging = true
          wrapper.classList.add('fullscreen-viewer__image-wrapper--dragging')
          
          const clientX = e.clientX || (e.touches && e.touches[0] ? e.touches[0].clientX : 0)
          const clientY = e.clientY || (e.touches && e.touches[0] ? e.touches[0].clientY : 0)
          
          fullscreenViewerState.startX = clientX - fullscreenViewerState.translateX
          fullscreenViewerState.startY = clientY - fullscreenViewerState.translateY
        }
        
        const handleMove = (e) => {
          if (!fullscreenViewerState.isDragging) return
          
          e.preventDefault()
          
          const clientX = e.clientX || (e.touches && e.touches[0] ? e.touches[0].clientX : 0)
          const clientY = e.clientY || (e.touches && e.touches[0] ? e.touches[0].clientY : 0)
          
          fullscreenViewerState.translateX = clientX - fullscreenViewerState.startX
          fullscreenViewerState.translateY = clientY - fullscreenViewerState.startY
          
          updateImageTransform()
        }
        
        const handleEnd = () => {
          if (!fullscreenViewerState.isDragging) return
          
          fullscreenViewerState.isDragging = false
          wrapper.classList.remove('fullscreen-viewer__image-wrapper--dragging')
        }
        
        wrapper.addEventListener('mousedown', handleStart)
        wrapper.addEventListener('mousemove', handleMove)
        wrapper.addEventListener('mouseup', handleEnd)
        wrapper.addEventListener('mouseleave', handleEnd)
        
        wrapper.addEventListener('touchstart', handleStart, { passive: true })
        wrapper.addEventListener('touchmove', handleMove, { passive: false })
        wrapper.addEventListener('touchend', handleEnd)
        wrapper.addEventListener('touchcancel', handleEnd)
      }

      /**
       * 更新圖片 transform
       */
      function updateImageTransform() {
        const img = document.getElementById('fullscreenImage')
        if (!img) return
        
        img.style.transform = `scale(${fullscreenViewerState.scale}) translate(${fullscreenViewerState.translateX / fullscreenViewerState.scale}px, ${fullscreenViewerState.translateY / fullscreenViewerState.scale}px)`
      }

      /**
       * 鍵盤導航
       */
      function handleFullscreenKeydown(event) {
        if (!fullscreenViewerState.isOpen) return
        
        switch (event.key) {
          case 'Escape':
            closeFullscreenViewer()
            break
          case 'ArrowLeft':
            event.preventDefault()
            changeFullscreenImage(-1)
            break
          case 'ArrowRight':
            event.preventDefault()
            changeFullscreenImage(1)
            break
        }
      }

      /**
       * 開啟穿搭彈窗
       */
      function openTryonScrollModal() {
        if (!tryonScrollCarouselState.images.length) return
        const modal = document.getElementById('tryonGalleryModal')
        if (!modal) return
        const dialog = modal.querySelector('.tryon-gallery-modal__dialog')
        const animationConfig = getTryonModalAnimationConfig()
        
        // 更新動畫時長配置
        modal.style.setProperty('--tryon-modal-enter-duration', `${animationConfig.enterDuration}ms`)
        modal.style.setProperty('--tryon-modal-exit-duration', `${animationConfig.exitDuration}ms`)
        
        if (typeof window !== 'undefined' && tryonScrollCarouselState.modalAnimationTimer) {
          window.clearTimeout(tryonScrollCarouselState.modalAnimationTimer)
          tryonScrollCarouselState.modalAnimationTimer = null
        }
        
        tryonScrollCarouselState.lastFocusedElement = document.activeElement
        
        // 預加載優先圖片（前 3 張）
        preloadTryonImages(tryonScrollCarouselState.images, 3)
        
        // 先設置 display: flex，但保持不可見
        modal.classList.remove('tryon-gallery-modal--closing')
        modal.classList.add('tryon-gallery-modal--open')
        
        // 使用雙重 requestAnimationFrame 確保動畫流暢
        // 第一個 RAF：確保 display 已生效
        if (typeof window !== 'undefined' && typeof window.requestAnimationFrame === 'function') {
          window.requestAnimationFrame(() => {
            // 第二個 RAF：確保瀏覽器已完成佈局計算，再觸發動畫
            window.requestAnimationFrame(() => {
              modal.classList.add('tryon-gallery-modal--visible')
            })
          })
        } else {
          modal.classList.add('tryon-gallery-modal--visible')
        }
        
        modal.setAttribute('aria-hidden', 'false')
        document.body.classList.add('tryon-gallery-modal-open')
        
        // 依據 WAI-ARIA Authoring Practices Modal Dialog 規範，開啟後立即聚焦對話框
        tryonScrollCarouselState.isModalOpen = true
        if (dialog) {
          // 延遲聚焦，避免影響動畫流暢度
          setTimeout(() => {
            dialog.focus()
          }, 50)
        }
      }

      /**
       * 關閉穿搭彈窗
       * @param {{restoreFocus?: boolean}} options
       */
      function closeTryonScrollModal(options = {}) {
        const modal = document.getElementById('tryonGalleryModal')
        if (!modal) return
        const { restoreFocus = true } = options
        const animationConfig = getTryonModalAnimationConfig()
        const exitDuration = Math.max(Number(animationConfig.exitDuration) || 0, 0)
        if (typeof window !== 'undefined' && tryonScrollCarouselState.modalAnimationTimer) {
          window.clearTimeout(tryonScrollCarouselState.modalAnimationTimer)
          tryonScrollCarouselState.modalAnimationTimer = null
        }
        modal.classList.add('tryon-gallery-modal--closing')
        modal.classList.remove('tryon-gallery-modal--visible')
        modal.setAttribute('aria-hidden', 'true')
        // 依據 WAI-ARIA Authoring Practices，關閉對話框需將焦點還給觸發元素
        tryonScrollCarouselState.isModalOpen = false
        const finalizeClose = () => {
          modal.classList.remove('tryon-gallery-modal--open', 'tryon-gallery-modal--closing')
          modal.style.removeProperty('--tryon-modal-enter-duration')
          modal.style.removeProperty('--tryon-modal-exit-duration')
          document.body.classList.remove('tryon-gallery-modal-open')
          if (restoreFocus && tryonScrollCarouselState.lastFocusedElement instanceof HTMLElement) {
            tryonScrollCarouselState.lastFocusedElement.focus()
          }
        }
        if (typeof window !== 'undefined' && exitDuration > 0) {
          tryonScrollCarouselState.modalAnimationTimer = window.setTimeout(finalizeClose, exitDuration)
        } else {
          finalizeClose()
        }
      }

      /**
       * 監聽鍵盤事件關閉彈窗
       * @param {KeyboardEvent} event
       */
      function handleTryonGalleryKeydown(event) {
        if (event.key === 'Escape' && tryonScrollCarouselState.isModalOpen) {
          closeTryonScrollModal()
        }
      }


      /**
       * 阻止被停用的 CTA 觸發
       */
      function handleDisabledTryonLink(event) {
        event.preventDefault()
      }

      function updateCouponBackground() {
        const couponContainerElement = document.querySelector('.cta-section')
        if (!couponContainerElement) return

        const isMobile = window.innerWidth <= 768
        const bgImage = isMobile ? fakeData.coupon.img_mobile : fakeData.coupon.img_desktop

        couponContainerElement.style.background = `
    linear-gradient(90deg, rgba(0, 0, 0, 0.2) 0%, rgba(0, 0, 0, 0) 48%),
    linear-gradient(0deg, rgba(0, 0, 0, 0.24) 0%, rgba(0, 0, 0, 0.24) 100%),
    url('${bgImage}') lightgray 50% / cover no-repeat
  `
      }

      function updateMailSectionBtnState() {
        const emailInput = document.getElementById('mailSectionInput')
        const mailSectionBtn = document.getElementById('mailSectionBtn')
        const isEmpty = emailInput.value.trim() === ''
        mailSectionBtn.disabled = isEmpty
        const emailValue = emailInput.value.trim() // 獲取輸入值
        if (/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailValue) || !emailValue) {
          emailInput.classList.remove('invalid') // 格式正確或空時移除紅色邊框
        }
      }

      let isProcessing = false

      function sendSubscribeMail() {
        const emailInput = document.getElementById('mailSectionInput')
        const mailSectionBtn = document.getElementById('mailSectionBtn')
        const finishElement = document.getElementById('mailSectionBtn-finish')
        const sendElement = document.getElementById('mailSectionBtn--send')

        // 防止連續點擊
        if (isProcessing) return
        isProcessing = true
        setTimeout(() => {
          isProcessing = false
        }, 2000)

        // 獲取並驗證 email
        const email = emailInput.value.trim()
        if (!email) {
          // 可以觸發自訂彈窗代替 alert
          return
        }

        // 檢查 email 格式
        if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
          showSendAlert('send-email-valid')
          emailInput.classList.add('invalid')
          // emailInput.select()
          return
        }

        // 初始化按鈕狀態
        mailSectionBtn.classList.remove('sent')
        mailSectionBtn.disabled = true
        finishElement.style.display = 'none'
        finishElement.style.opacity = '0'

        // 執行 API 請求
        const template = document.getElementById('emailTemplate').content.cloneNode(true)
        const jsonData =
          randomGen === 'true'
            ? defaultEdmItems
            : JSON.parse(sessionStorage.getItem('inf-ai-edm-items') || '[]')
        const productHtmlArray = generateProductHtml(jsonData) // 假設已定義

        if (jsonData.length >= 4) {
          const placeholders = template.querySelectorAll('.product-placeholder')
          placeholders[0].innerHTML = productHtmlArray[0]
          placeholders[1].innerHTML = productHtmlArray[1]
          placeholders[2].innerHTML = productHtmlArray[2]
          placeholders[3].innerHTML = productHtmlArray[3]
          placeholders[4].innerHTML = productHtmlArray[4]
          placeholders[5].innerHTML = productHtmlArray[5]
        } else {
          // console.warn('Not enough products returned from API')
          const messageData = {
            type: 'send-email-error',
            value: true
          }
          window.parent.postMessage(messageData, '*')
          return
        }

        // template.getElementById('demo-product-container').innerHTML = productHtmlArray
        // if (jsonData.length >= 4) {
        //   const placeholders = template.querySelectorAll('.product-placeholder')
        // } else {
        //   console.warn('Not enough products returned from API')
        //   const messageData = {
        //     type: 'send-email-error',
        //     value: true
        //   }
        //   window.parent.postMessage(messageData, '*')
        //   return
        // }

        const emailTemplate = new XMLSerializer().serializeToString(template)

        fetch(
          'https://1r67xu2nn6.execute-api.ap-northeast-1.amazonaws.com/default/mail_edm_invoke',
          {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              to_email: email,
              subject: '每件商品都是你的風格代表作，獻給獨樹一幟的你。',
              html_body: emailTemplate
            })
          }
        )
          .then((response) => {
            if (!response.ok) throw new Error('Network response was not ok')
            return response // 假設 API 返回 JSON
          })
          .then((data) => {
            // console.log('✅ Email sent successfully:', data)
            mailSectionBtn.classList.add('sent')
            sendElement.style.display = 'none'
            // mailSectionBtn.disabled = false
            mailSectionBtn.style.pointerEvents = 'none'
            finishElement.style.display = 'block'
            finishElement.style.transition = 'opacity 0.4s'
            finishElement.style.opacity = '1'
            showSendAlert('send-email-finish')
          })
          .catch((error) => {
            showSendAlert('send-email-error')
            console.error('❌ Email sending failed:', error)
            mailSectionBtn.classList.remove('sent')
            // mailSectionBtn.disabled = false
            finishElement.style.display = 'none'
            finishElement.style.opacity = '0'
            sendElement.style.display = 'block'
            emailInput.value = '' // 清空輸入欄位
          })
      }

      function triggerMailButton() {
        const emailInput = document.getElementById('mailSectionInput')
        const mailSectionBtn = document.getElementById('mailSectionBtn')
        if (emailInput.value.trim() !== '') {
          mailSectionBtn.click()
        }
      }
      function IDRxGet(o, t, s, x, test) {
    if (typeof ga !== 'undefined') {
        var gaid = ga.getAll()[0].get('clientId');
    } else {
        var gaid = 'notfoundgaid'
    }
    var e = {
        MsgHeader: "IDRxGet",
        MRID: o,
        GVID: t,
        LGVID: x,
        ga_id: gaid,
        TESTING: test
    };
    s.postMessage(e, "*")
}
        function makeid (length) {
          let result = ''
          let characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789'
          let charactersLength = characters.length
          for (let i = 0; i < length; i++) {
            result += characters.charAt(Math.floor(Math.random() * charactersLength))
          }
          return result
        }
      function ids_init() {


        let member_id = ''
        let lgiven_id = ''
        let skuContent = '627b5ab044a027000fde0add'

        let lgvid_exist = false
        try {
          if (typeof localStorage['LGVID'] !== 'undefined') {
            lgvid_exist = true
          }
        } catch (e) {
          lgvid_exist = false
        }
        if (lgvid_exist) {
          lgiven_id = localStorage['LGVID']
        } else {
          lgiven_id = makeid(20)
          localStorage.setItem('LGVID', lgiven_id)
        }

        return { member_id: member_id, lgiven_id: lgiven_id, skuContent: skuContent }
      }

      function generateProductHtml(images) {
        return images.slice(0, 6).map((img) => {
          return `
                    <a class="embeddedItem" href="${img.link}" target="_blank" data-title="${img.title}" data-link="${img.link}" style="text-decoration: none; color: #333333; display: block; width: 100%; overflow: hidden;">
                        <div class="embeddedItem__img">
                            <div class="embeddedItem__imgBox" style="background-color: #efefef;height: 226px;width:226px">
                                <img loading="lazy" src="${img.image_link}" alt="${img.description}" style="width: 100%; max-width: 100%; height: 100%; object-fit: cover; display: block;">
                            </div>
                        </div>
                        <div class="embeddedItemInfo" style="overflow: hidden;">
                            <h3 class="embeddedItemInfo__title" style="font-family: Arial, 'Noto Sans TC', sans-serif; font-size: 16px; color: #3B3B32; margin: 10px 0 5px; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: inline-block;width:100%; max-width: 226px; line-height: 20px; height: 22px;">${img.title}</h3>
                            ${
                              img.sale_price && img.sale_price !== img.price
                                ? `<div class="embeddedItemInfo__content" style="font-family: Arial, 'Noto Sans TC', sans-serif; font-size: 14px; color: #333333; margin: 0; text-align: center; display: block; overflow: hidden;">
                                        <p class="embeddedItemInfo__discount" style="color: #eb7454; background: white; border: 1px solid #eb7454; padding: 2px 6px; border-radius: 5px; font-size: 12px; font-weight: bold; margin: 0 8px 0 0; display: inline-block; max-width: 60px;">${Math.ceil(
                                          100 -
                                            (parseInt(img.sale_price.replace(',', '')) * 100) /
                                              parseInt(img.price.replace(',', ''))
                                        )}% off</p>
                                        <p class="embeddedItemInfo__price" style="color: #eb7454; font-size: 14px; font-weight: 500; margin: 0; display: inline-block;">NT$ ${img.sale_price}</p>
                                    </div>`
                                : `<div class="embeddedItemInfo__content" style="font-family: Arial, 'Noto Sans TC', sans-serif; font-size: 14px; color: #333333; margin: 0; text-align: center; display: block; overflow: hidden;"> 
                                        <p class="embeddedItemInfo__discount" style="color: #eb7454; background: white; border: 1px solid #eb7454; padding: 2px 6px; border-radius: 5px; font-size: 12px; font-weight: bold; margin: 0 8px 0 0; display: inline-block; max-width: 60px;">5% off</p>               
                                        <p class="embeddedItemInfo__price" style="color: #eb7454; font-size: 14px; font-weight: 500; margin: 0; display: inline-block;">NT$ ${img.price}</p>
                                    </div>`
                            }
                        </div>
                    </a>
                `
        })
      }

      function showSendAlert(state = 'send-email-error') {
        const mailSectionBtn = document.getElementById('mailSectionBtn')
        const emailInput = document.getElementById('mailSectionInput')

        mailSectionBtn.disabled = true
        emailInput.readOnly = true

        const alert = document.getElementById('sendAlert')
        if (!alert) return

        const alertConfig = {
          'send-email-finish': {
            style: {
              background: 'rgba(252, 252, 248, 0.90)',
              boxShadow:
                '0px 71px 20px 0px rgba(0, 0, 0, 0.00), 0px 45px 18px 0px rgba(0, 0, 0, 0.01), 0px 25px 15px 0px rgba(0, 0, 0, 0.05), 0px 11px 11px 0px rgba(0, 0, 0, 0.09), 0px 3px 6px 0px rgba(0, 0, 0, 0.10)',

              backdropFilter: 'blur(12px)',
              color: '#1E1E19'
            },
            icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
              <path d="M5 12L10 17L20 7" stroke="#1E1E19" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>`,
            message: '已寄出，快去信箱查看吧！'
          },

          'send-email-valid': {
            style: {
              borderRadius: '18px',
              border: '1px solid rgba(136, 25, 19, 0.40)',
              background: 'rgba(246, 226, 226, 0.80)',
              boxShadow:
                '0px 71px 20px 0px rgba(0, 0, 0, 0.00), 0px 45px 18px 0px rgba(0, 0, 0, 0.01), 0px 25px 15px 0px rgba(0, 0, 0, 0.05), 0px 11px 11px 0px rgba(0, 0, 0, 0.09), 0px 3px 6px 0px rgba(0, 0, 0, 0.10)',
              backdropFilter: 'blur(12px)',
              color: '#881913'
            },
            icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
              <path d="M12 1.66992C12.955 1.66992 13.845 2.13692 14.39 2.91692L14.495 3.07692L22.609 16.6249C22.8556 17.052 22.9898 17.5347 22.9989 18.0277C23.0081 18.5208 22.892 19.0081 22.6615 19.4441C22.431 19.8801 22.0936 20.2504 21.6809 20.5204C21.2682 20.7904 20.7938 20.9513 20.302 20.9879L20.107 20.9959H3.882C3.38971 20.9904 2.90684 20.8602 2.47847 20.6175C2.05011 20.3749 1.69021 20.0276 1.43237 19.6082C1.17453 19.1888 1.02716 18.7109 1.00402 18.2191C0.980869 17.7273 1.0827 17.2377 1.3 16.7959L1.399 16.6109L9.509 3.07292C9.76867 2.64473 10.1343 2.29069 10.5706 2.04494C11.0069 1.79919 11.4992 1.67003 12 1.66992ZM12.01 14.9999L11.883 15.0069C11.64 15.0358 11.4159 15.1529 11.2534 15.3359C11.0909 15.5189 11.0011 15.7552 11.0011 15.9999C11.0011 16.2447 11.0909 16.4809 11.2534 16.664C11.4159 16.847 11.64 16.964 11.883 16.9929L12 16.9999L12.127 16.9929C12.3701 16.964 12.5941 16.847 12.7566 16.664C12.9191 16.4809 13.0089 16.2447 13.0089 15.9999C13.0089 15.7552 12.9191 15.5189 12.7566 15.3359C12.5941 15.1529 12.3701 15.0358 12.127 15.0069L12.01 14.9999ZM12 7.99992C11.7551 7.99995 11.5187 8.08988 11.3356 8.25264C11.1526 8.4154 11.0357 8.63967 11.007 8.88292L11 8.99992V12.9999L11.007 13.1169C11.0359 13.36 11.153 13.584 11.336 13.7465C11.519 13.909 11.7552 13.9988 12 13.9988C12.2448 13.9988 12.481 13.909 12.664 13.7465C12.847 13.584 12.9641 13.36 12.993 13.1169L13 12.9999V8.99992L12.993 8.88292C12.9643 8.63967 12.8474 8.4154 12.6644 8.25264C12.4813 8.08988 12.2449 7.99995 12 7.99992Z" fill="#B00B05"/>
            </svg>`,
            message: '郵件格式不正確'
          },

          'send-email-error': {
            style: {
              borderRadius: '18px',
              border: '1px solid rgba(130, 89, 32, 0.32)',
              background:
                'linear-gradient(0deg, rgba(255, 204, 0, 0.08) 0%, rgba(255, 204, 0, 0.08) 100%), #FFF',
              boxShadow:
                '0px 71px 20px 0px rgba(0, 0, 0, 0.00), 0px 45px 18px 0px rgba(0, 0, 0, 0.01), 0px 25px 15px 0px rgba(0, 0, 0, 0.05), 0px 11px 11px 0px rgba(0, 0, 0, 0.09), 0px 3px 6px 0px rgba(0, 0, 0, 0.10)',
              backdropFilter: 'blur(12px)',
              color: '#825920'
            },
            icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
              <path d="M17 3.33989C18.5202 4.21758 19.7826 5.47997 20.6603 7.00017C21.538 8.52038 22 10.2448 22 12.0002C22 13.7556 21.5379 15.48 20.6602 17.0002C19.7825 18.5204 18.5201 19.7828 16.9999 20.6605C15.4797 21.5381 13.7552 22.0002 11.9998 22.0001C10.2445 22.0001 8.52002 21.538 6.99984 20.6603C5.47965 19.7826 4.21729 18.5202 3.33963 17C2.46198 15.4797 1.99996 13.7553 2 11.9999L2.005 11.6759C2.061 9.94888 2.56355 8.26585 3.46364 6.79089C4.36373 5.31592 5.63065 4.09934 7.14089 3.25977C8.65113 2.42021 10.3531 1.98629 12.081 2.00033C13.8089 2.01437 15.5036 2.47589 17 3.33989ZM12 14.9999C11.7348 14.9999 11.4804 15.1052 11.2929 15.2928C11.1054 15.4803 11 15.7347 11 15.9999V16.0099C11 16.2751 11.1054 16.5295 11.2929 16.717C11.4804 16.9045 11.7348 17.0099 12 17.0099C12.2652 17.0099 12.5196 16.9045 12.7071 16.717C12.8946 16.5295 13 16.2751 13 16.0099V15.9999C13 15.7347 12.8946 15.4803 12.7071 15.2928C12.5196 15.1052 12.2652 14.9999 12 14.9999ZM12 7.99989C11.7348 7.99989 11.4804 8.10525 11.2929 8.29279C11.1054 8.48032 11 8.73468 11 8.99989V12.9999C11 13.2651 11.1054 13.5195 11.2929 13.707C11.4804 13.8945 11.7348 13.9999 12 13.9999C12.2652 13.9999 12.5196 13.8945 12.7071 13.707C12.8946 13.5195 13 13.2651 13 12.9999V8.99989C13 8.73468 12.8946 8.48032 12.7071 8.29279C12.5196 8.10525 12.2652 7.99989 12 7.99989Z" fill="#825920"/>
            </svg>`,
            message: '伺服器錯誤，請再嘗試一次'
          },
          'copy-code-finish': {
            style: {
              background: 'rgba(252, 252, 248, 0.90)',
              boxShadow:
                '0px 71px 20px 0px rgba(0, 0, 0, 0.00), 0px 45px 18px 0px rgba(0, 0, 0, 0.01), 0px 25px 15px 0px rgba(0, 0, 0, 0.05), 0px 11px 11px 0px rgba(0, 0, 0, 0.09), 0px 3px 6px 0px rgba(0, 0, 0, 0.10)',

              backdropFilter: 'blur(12px)',
              color: '#1E1E19'
            },
            icon: `         <svg width="25" height="25" viewBox="0 0 25 25" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M9.10742 5.96289H7.10742C6.57699 5.96289 6.06828 6.1736 5.69321 6.54868C5.31814 6.92375 5.10742 7.43246 5.10742 7.96289V19.9629C5.10742 20.4933 5.31814 21.002 5.69321 21.3771C6.06828 21.7522 6.57699 21.9629 7.10742 21.9629H17.1074C17.6379 21.9629 18.1466 21.7522 18.5216 21.3771C18.8967 21.002 19.1074 20.4933 19.1074 19.9629V7.96289C19.1074 7.43246 18.8967 6.92375 18.5216 6.54868C18.1466 6.1736 17.6379 5.96289 17.1074 5.96289H15.1074" stroke="#1E1E19" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
<path d="M9.10742 5.96289C9.10742 5.43246 9.31814 4.92375 9.69321 4.54868C10.0683 4.1736 10.577 3.96289 11.1074 3.96289H13.1074C13.6379 3.96289 14.1466 4.1736 14.5216 4.54868C14.8967 4.92375 15.1074 5.43246 15.1074 5.96289C15.1074 6.49332 14.8967 7.00203 14.5216 7.3771C14.1466 7.75218 13.6379 7.96289 13.1074 7.96289H11.1074C10.577 7.96289 10.0683 7.75218 9.69321 7.3771C9.31814 7.00203 9.10742 6.49332 9.10742 5.96289Z" stroke="#1E1E19" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
<path d="M9.10742 14.9629L11.1074 16.9629L15.1074 12.9629" stroke="#1E1E19" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
</svg>
`,
            message: '已複製折扣碼'
          },
          'liff-promo-success': {
            style: {
              background: 'rgba(0, 195, 0, 0.10)',
              border: '1px solid rgba(0, 195, 0, 0.40)',
              boxShadow:
                '0px 71px 20px 0px rgba(0, 0, 0, 0.00), 0px 45px 18px 0px rgba(0, 0, 0, 0.01), 0px 25px 15px 0px rgba(0, 0, 0, 0.05), 0px 11px 11px 0px rgba(0, 0, 0, 0.09), 0px 3px 6px 0px rgba(0, 0, 0, 0.10)',
              backdropFilter: 'blur(12px)',
              color: '#00C300'
            },
            icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
              <path d="M5 12L10 17L20 7" stroke="#00C300" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>`,
            message: '優惠資訊已發送！請查看您的 LINE 訊息'
          }
        }
        const config = alertConfig[state] || alertConfig['send-email-error']

        // 更新彈窗內容
        alert.innerHTML = `
                ${config.icon}
                <div>${config.message}</div>
                         <span class="close-send-alert" onclick="closeSendAlert()">
                          <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="24"
                            height="24"
                            viewBox="0 0 24 24"
                            fill="none"
                          >
                            <g clip-path="url(#clip0_5970_16761)">
                              <path
                                d="M12 24C15.1826 24 18.2348 22.7357 20.4853 20.4853C22.7357 18.2348 24 15.1826 24 12C24 8.8174 22.7357 5.76516 20.4853 3.51472C18.2348 1.26428 15.1826 0 12 0C8.8174 0 5.76516 1.26428 3.51472 3.51472C1.26428 5.76516 0 8.8174 0 12C0 15.1826 1.26428 18.2348 3.51472 20.4853C5.76516 22.7357 8.8174 24 12 24ZM8.20312 8.20312C8.64375 7.7625 9.35625 7.7625 9.79219 8.20312L11.9953 10.4062L14.1984 8.20312C14.6391 7.7625 15.3516 7.7625 15.7875 8.20312C16.2234 8.64375 16.2281 9.35625 15.7875 9.79219L13.5844 11.9953L15.7875 14.1984C16.2281 14.6391 16.2281 15.3516 15.7875 15.7875C15.3469 16.2234 14.6344 16.2281 14.1984 15.7875L11.9953 13.5844L9.79219 15.7875C9.35156 16.2281 8.63906 16.2281 8.20312 15.7875C7.76719 15.3469 7.7625 14.6344 8.20312 14.1984L10.4062 11.9953L8.20312 9.79219C7.7625 9.35156 7.7625 8.63906 8.20312 8.20312Z"
                                fill="black"
                                fill-opacity="0.16"
                              />
                            </g>
                            <defs>
                              <clipPath id="clip0_5970_16761">
                                <rect width="24" height="24" fill="white" />
                              </clipPath>
                            </defs>
                          </svg>
                        </span>
              `

        // 套用樣式
        Object.assign(alert.style, config.style)

        // 顯示動畫
        alert.classList.remove('hiding')
        alert.style.display = 'flex'
        alert.classList.add('showing')
      }
      function closeSendAlert() {
        const alert = document.getElementById('sendAlert')
        const messageText = alert.querySelector('div').textContent.trim()
        const emailInput = document.getElementById('mailSectionInput')
        const mailSectionBtn = document.getElementById('mailSectionBtn')
        const finishElement = document.getElementById('mailSectionBtn-finish')
        const sendElement = document.getElementById('mailSectionBtn--send')
        alert.classList.remove('showing')
        alert.classList.add('hiding')
        alert.addEventListener(
          'animationend',
          () => {
            alert.style.display = 'none'
            alert.classList.remove('hiding')
            mailSectionBtn.disabled = false
            emailInput.readOnly = false
            emailInput.value = '' // 清空輸入欄位
            if (messageText === '已寄出，快去信箱查看吧！') {
              mailSectionBtn.classList.remove('sent')
              mailSectionBtn.style.pointerEvents = 'auto'
              sendElement.style.display = 'block'
              finishElement.style.display = 'none'
              finishElement.style.opacity = '0'
            } else {
              console.log('❌ 文字不符，實際內容為：', messageText)
            }
            if (messageText === '已複製折扣碼') {
              isCopied = false
            }
          },
          { once: true }
        )
      }

      // Copy discount code functionality
      function copyDiscountCode() {
        if (isCopied) return

        const code = fakeData.coupon.code
        const copyAlert = document.getElementById('copy-alert')
        const copyBtn = document.querySelectorAll('.copy-btn')[0]
        const copyIcon = document.getElementById('copy-icon')
        const copiedIcon = document.getElementById('copied-icon')
        const copyIconMobile = document.getElementById('copy-icon--mobile')
        const copiedIconMobile = document.getElementById('copied-icon--mobile')
        try {
          const textarea = document.createElement('textarea')
          textarea.value = code
          textarea.style.position = 'fixed'
          textarea.style.opacity = '0'
          document.body.appendChild(textarea)
          textarea.select()
          const successful = document.execCommand('copy')
          document.body.removeChild(textarea)

          if (successful) {
            isCopied = true
            const isMobile = window.innerWidth <= 768
            if (isMobile) {
              showSendAlert('copy-code-finish')
            } else {
              copyAlert.classList.add('copy-alert-transition-enter-active')
              copyAlert.style.display = 'flex'
              copyAlert.style.opacity = '1'
              copyIcon.style.display = 'none'
              copiedIcon.style.display = 'block'
              copyIconMobile.style.display = 'none'
              copiedIconMobile.style.display = 'block'
              copyAlert.addEventListener(
                'animationend',
                function handler() {
                  copyAlert.classList.remove('copy-alert-transition-enter-active')
                  copyAlert.removeEventListener('animationend', handler)
                },
                { once: true }
              )

              setTimeout(() => {
                isCopied = false
                copyAlert.classList.add('copy-alert-transition-leave-active')
                copyAlert.addEventListener(
                  'animationend',
                  function handler() {
                    copyAlert.style.display = 'none'
                    copyAlert.classList.remove('copy-alert-transition-leave-active')
                    copyIcon.style.display = 'block'
                    copiedIcon.style.display = 'none'
                    copyIconMobile.style.display = 'block'
                    copiedIconMobile.style.display = 'none'
                    isCopied = false
                    copyAlert.removeEventListener('animationend', handler)
                  },
                  { once: true }
                )
              }, 3500)
            }
          } else {
            console.error('execCommand 複製失敗')
            alert('複製失敗，請手動複製折扣碼')
          }
        } catch (err) {
          console.error('回退方案複製失敗:', err)
          alert('複製失敗，請手動複製折扣碼')
        }
      }

      // Scroll to recommendations section
      function scrollToRecom() {
        const target = document.getElementById('jump-recom')
        if (target) {
          target.scrollIntoView({
            behavior: 'smooth',
            block: 'start'
          })
        }
      }

      // Go back to previous page
      function goBack(event) {
        if (event) event.preventDefault()
        randomGen === 'true' || !!Brand
          ? window.scrollTo({ top: 0, behavior: 'smooth' })
          : window.location.replace('./personalized.html')
      }

      function fetchCoupon() {
        if (isFetchCouponCalled) return Promise.resolve()
        isFetchCouponCalled = true
        const Module = 'Personalized_Size_Page'
        const requestData = {
          Brand: Brand,
          Module: Module
        }

        const options = {
          method: 'POST',
          headers: { accept: 'application/json' },
          body: JSON.stringify(requestData)
        }
        return fetch(
          `https://api.inffits.com/mkt_brand_config_proc/GetItem?Brand=${Brand}&Module=${Module}`,
          options
        )
          .then((response) => response.json())
          .then((data) => {
            const couponData = data.ConfigData.Discount_Info[0]
            const sectionInfoData = data.ConfigData.Section_Info
            fakeData.personalized_recommendation.title =
              sectionInfoData?.[0]?.Title || '專屬於你的身形精選'
            fakeData.personalized_recommendation.description =
              sectionInfoData?.[0]?.Description ||
              '從上身到下身，依據你的體態特徵，挑選出舒適又有型的單品。'
            fakeData.more_recommendation.title = sectionInfoData?.[1]?.Title || '更多靈感搭配'
            fakeData.more_recommendation.description =
              sectionInfoData?.[1]?.Description ||
              '依據你的尺寸與穿衣喜好，推薦搭配靈感，讓每一次搭配更自在而合宜。'
            fakeData.personalized_recommendation.status = sectionInfoData?.[0]?.status
            fakeData.more_recommendation.status = sectionInfoData?.[1]?.status
            fakeData.personalized_recommendation.ctype_val = sectionInfoData?.[0]?.ctype_val
            fakeData.more_recommendation.ctype_val = sectionInfoData?.[1]?.ctype_val
            fakeData.coupon.text = `${couponData.Title}\n${couponData.Description}`
            fakeData.coupon.code = couponData.Code
            fakeData.coupon.img_desktop = couponData.Imgsrc
            fakeData.coupon.img_mobile = couponData.MobileImgsrc
            fakeData.coupon.status = couponData.status
            fakeData.coupon.timeValid = couponData.TimeValid
            const dateRange =
              typeof couponData.TimeValid === 'string' ? couponData.TimeValid.split('~') : []

            const startDate = new Date(dateRange[0] + 'T00:00:00')
            const endDate = new Date(dateRange[1] + 'T00:00:00')

            // 當前日期（只保留年月日，時間歸零）
            const now = new Date()
            const currentDate = new Date(now.getFullYear(), now.getMonth(), now.getDate())

            // 比較是否在區間內（包含頭尾）
            const isInRange = currentDate >= startDate && currentDate <= endDate

            // console.warn(isInRange ? '當前日期在範圍內' : '當前日期不在範圍內')

            // Update coupon text and code in DOM
            const couponTextElements = document.querySelectorAll('.coupon-text')
            const couponCodeElements = document.querySelectorAll('.coupon-code')

            couponTextElements.forEach((el) => {
              el.textContent = fakeData.coupon.text || ''
            })

            couponCodeElements.forEach((el) => {
              el.textContent = fakeData.coupon.code || ''
            })

            // Hide coupon text and code if status is false or not in range
            if (fakeData.coupon.status === false || !isInRange) {
              document.querySelector('.mobile-cta-section').style.display = 'none'
              document.querySelector('.cta-section-container').style.display = 'none'
              document.querySelector('.mobile-cta-section .coupon-copy').style.display = 'none'
              document.querySelector('.cta-section .coupon-copy').style.display = 'none'
            } else {
              document.querySelector('.mobile-cta-section').style.display = ''
              document.querySelector('.cta-section-container').style.display = ''
              document.querySelector('.mobile-cta-section .coupon-copy').style.display = 'flex'
              document.querySelector('.cta-section .coupon-copy').style.display = 'flex'
            }
            document.querySelector('#jump-recom').style.display = fakeData
              .personalized_recommendation.status
              ? 'flex'
              : 'none'
            document.querySelector('#jump-more').style.display = fakeData.more_recommendation.status
              ? 'flex'
              : 'none'
          })
          .catch((error) => console.error('Error fetching coupon:', error))
      }

      let resizeTimer
      window.addEventListener('resize', () => {
        clearTimeout(resizeTimer)
        resizeTimer = setTimeout(() => {
          updateCouponBackground()
        }, 200)
      })

      // 新增接收 #inffits_ctryon_window iframe message
      window.addEventListener('message', function (event) {
        // 只接收來自 #inffits_ctryon_window 的訊息
        const tryonIframe = document.getElementById('inffits_ctryon_window')
        if (tryonIframe && event.source === tryonIframe.contentWindow) {
          // console.log('[iframe message]', event.data)
          if (event.data.header === 'bid') {
            const bid = event.data.value
            // console.log('收到新的 bid 資料:', bid)
            bid.Brand = Brand
            // 確保 fakeData 有正確的資料結構
            if (!fakeData.personalized_recommendation) {
              // console.warn('fakeData.personalized_recommendation 不存在，使用預設值')
              fakeData.personalized_recommendation = { ctype_val: '' }
            }
            if (!fakeData.more_recommendation) {
              // console.warn('fakeData.more_recommendation 不存在，使用預設值') 
              fakeData.more_recommendation = { ctype_val: '' }
            }
            
            // 更新現有推薦元件的 bid 參數
            updateProductRecommendationBid('personalized-recommendations', bid)
            updateProductRecommendationBid('more-recommendations', bid)
            
            // 延遲更新 mail-section 圖片，確保兩個推薦區塊都載入完成
            // setTimeout(() => {
            //   if (typeof updateMailSectionImages === 'function') {
            //     console.log('🖼️ bid 更新完成，正在更新 mail-section 圖片...')
            //     updateMailSectionImages()
            //   }
            // }, 4000) // 等待 4 秒讓兩個推薦區塊都完全載入
          }
        }
      })
      
      // 新增函式：更新推薦元件的 bid 參數
      function updateProductRecommendationBid(containerId, newBid) {
        // console.log(`🔄 開始更新 ${containerId} 的 bid 參數`)
        // console.log('📊 新的 bid 資料:', newBid)
        
        // 檢查容器是否存在
        const container = document.getElementById(containerId)
        if (!container) {
          // console.warn(`❌ Container ${containerId} not found`)
          return
        }
        
        // 在現有內容上方添加半透明 loading 遮罩，避免閃爍
        const loadingOverlay = document.createElement('div')
        loadingOverlay.id = `loading-overlay-${containerId}`
        loadingOverlay.style.cssText = `
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: transparent;
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 999;
        `
        loadingOverlay.innerHTML = `
          <div id="recommendation-loading">
            <span class="loading-text">Loading...</span>
          </div>
        `
        
        // 確保容器有相對定位
        if (getComputedStyle(container).position === 'static') {
          container.style.position = 'relative'
        }
        
        // 添加 loading 遮罩
        container.appendChild(loadingOverlay)
        
        // 取得對應的 ctype_val
        let ctype_val = []
        if (containerId === 'personalized-recommendations') {
          ctype_val = fakeData.personalized_recommendation.ctype_val
        } else if (containerId === 'more-recommendations') {
          ctype_val = fakeData.more_recommendation.ctype_val
        }
        
        // 確保 ctype_val 格式正確
        if (typeof ctype_val === 'string') {
          ctype_val = ctype_val.split(',')
        } else if (!Array.isArray(ctype_val)) {
          ctype_val = []
        }
        
        // console.log(`📋 ${containerId} 使用的 ctype_val:`, ctype_val)
        
        // 延遲清空並重新呼叫，減少閃爍
        setTimeout(() => {
          try {
            // 現在才清空容器（在 loading 顯示後）
            container.innerHTML = ''
            
            // 動態獲取當前 Product_Recommendation 配置並更新 bid 參數
            const getCurrentConfig = (containerId) => {
              // 嘗試從全局配置存儲中獲取當前配置
              if (window.productRecommendationConfigs && window.productRecommendationConfigs[containerId]) {
                const currentConfig = { ...window.productRecommendationConfigs[containerId] }
                // 只更新 bid 參數，保留其他配置不變
                currentConfig.bid = newBid
                return currentConfig
              }
              
              // 如果沒有找到存儲的配置，使用預設配置
              return {
                brand: Brand,
                containerId: containerId,
                backgroundColor: 'transparent',
                title: '',
                customPadding: '0px',
                customEdm: [], // 清空 customEdm，強制使用 API 資料
                arrowPosition: 'center',
                autoplay: false,
                hide_discount: true,
                hide_size: false, // 啟用尺寸 AI，這樣 bid 才會被使用
                ctype_val: ctype_val,
                bid: newBid, // 傳遞新的 bid
                breakpoints: {
                  768: {
                    slidesPerView: 4,
                    slidesPerGroup: 4,
                    spaceBetween: 24,
                    grid: {
                      rows: 1,
                      fill: 'row'
                    }
                  },
                  0: {
                    slidesPerView: 2.5,
                    slidesPerGroup: 2,
                    spaceBetween: 12,
                    grid: {
                      rows: 1,
                      fill: 'row'
                    }
                  }
                }
              }
            }
            
            const configWithNewBid = getCurrentConfig(containerId)
            
            // 更新全局配置存儲
            if (window.productRecommendationConfigs) {
              window.productRecommendationConfigs[containerId] = configWithNewBid
            }
            
            // console.log(`🚀 正在重新呼叫 Product_Recommendation...`)
            // console.log('📦 完整配置:', configWithNewBid)
            
            window.Product_Recommendation(configWithNewBid)
            
            // console.log(`✅ ${containerId} 更新呼叫完成，embedded.js 將處理後續 loading`)
            
            // 移除個別更新，改為統一在 iframe message 處理中更新
            
          } catch (error) {
            console.error(`❌ 更新 ${containerId} 時發生錯誤:`, error)
            
            // 移除 loading 遮罩
            const overlay = document.getElementById(`loading-overlay-${containerId}`)
            if (overlay) {
              overlay.remove()
              // console.error('🖼️ 延遲更新 mail-section 圖片...')
              updateMailSectionImages()
            }
            
            // 錯誤處理：顯示錯誤訊息
            container.innerHTML = `
              <div style="
                display: flex;
                justify-content: center;
                align-items: center;
                height: 200px;
                font-family: 'Noto Sans TC', Arial, sans-serif;
                color: #999;
                font-size: 16px;
                text-align: center;
              ">
                推薦更新失敗，請重新整理頁面<br>
                <small style="color: #ccc; margin-top: 8px;">錯誤: ${error.message}</small>
              </div>
            `
          }
        }, 200) // 讓 loading 遮罩先顯示 200ms
      }
      
      // 測試函式：模擬接收 bid 更新（僅供開發測試使用）
      window.testBidUpdate = function(testBid) {
        // console.log('🧪 測試 bid 更新功能:', testBid)
        
        // 提供幾種不同的測試 bid，模擬不同身形
        const testBids = {
          slim: {
            HV: '175',
            WV: '55', // 瘦身形
            CC: '88_88',
            DataItem: '0100',
            Shoulder: '42',
            UpChest: '88',
            DnChest: '84',
            Waist: '72',
            Hip: '88',
            Brand: Brand,
            ClothID: '',
            Sizes: '',
            FitP: '0,0,0,0',
            Gender: 'M',
            FMLpath: 'FMLSep',
            BUS: '0',
            GVID: '',
            LGVID: '',
            MRID: 'INF',
            ga_id: 'x',
            Pattern_Prefer: '1'
          },
          regular: {
            HV: '175',
            WV: '70', // 標準身形
            CC: '95_95',
            DataItem: '0100',
            Shoulder: '45',
            UpChest: '95',
            DnChest: '91',
            Waist: '82',
            Hip: '95',
            Brand: Brand,
            ClothID: '',
            Sizes: '',
            FitP: '0,0,0,0',
            Gender: 'M',
            FMLpath: 'FMLSep',
            BUS: '0',
            GVID: '',
            LGVID: '',
            MRID: 'INF',
            ga_id: 'x',
            Pattern_Prefer: '1'
          },
          large: {
            HV: '175',
            WV: '85', // 較胖身形
            CC: '105_105',
            DataItem: '0100',
            Shoulder: '48',
            UpChest: '105',
            DnChest: '101',
            Waist: '95',
            Hip: '105',
            Brand: Brand,
            ClothID: '',
            Sizes: '',
            FitP: '0,0,0,0',
            Gender: 'M',
            FMLpath: 'FMLSep',
            BUS: '0',
            GVID: '',
            LGVID: '',
            MRID: 'INF',
            ga_id: 'x',
            Pattern_Prefer: '1'
          }
        }
        
        let mockBid
        if (typeof testBid === 'string' && testBids[testBid]) {
          mockBid = testBids[testBid]
          // console.log(`🎯 使用預設 ${testBid} 身形測試資料`)
        } else if (testBid) {
          mockBid = testBid
          // console.log('🎯 使用自訂測試資料')
        } else {
          mockBid = testBids.large // 預設使用大尺寸測試
          // console.log('🎯 使用預設大尺寸測試資料')
        }
        
        // console.log('📊 測試 bid 詳細資料:', mockBid)
        
        // 觸發更新
        updateProductRecommendationBid('personalized-recommendations', mockBid)
        updateProductRecommendationBid('more-recommendations', mockBid)
        
        // 延遲更新 mail-section 圖片，確保兩個推薦區塊都載入完成
        // setTimeout(() => {
        //   if (typeof updateMailSectionImages === 'function') {
        //     console.log('🖼️ 測試 bid 更新完成，正在更新 mail-section 圖片...')
        //     updateMailSectionImages()
        //   }
        // }, 4000) // 等待 4 秒讓兩個推薦區塊都完全載入
        
        // console.log('✅ 測試呼叫完成！請等待 4-5 秒查看推薦商品更新和 mail-section 圖片更新')
        // console.log('💡 提示：可以嘗試不同身形: testBidUpdate("slim"), testBidUpdate("regular"), testBidUpdate("large")')
      }
      
      // 在 console 中顯示測試提示
      // console.log('💡 提示：您可以在 Console 中輸入 testBidUpdate() 來測試 bid 更新功能')
      
      // 調試函式：檢查推薦元件狀態
      window.debugRecommendations = function() {
        // console.log('🔍 開始檢查推薦元件狀態...')
        
        // 檢查容器是否存在
        const container1 = document.getElementById('personalized-recommendations')
        const container2 = document.getElementById('more-recommendations')
        
        // console.log('📦 容器狀態:')
        // console.log('  personalized-recommendations:', container1 ? '✅ 存在' : '❌ 不存在')
        // console.log('  more-recommendations:', container2 ? '✅ 存在' : '❌ 不存在')
        
        if (container1) {
          // console.log('  容器1內容:', container1.innerHTML.length > 0 ? '有內容' : '空的')
          // console.log('  容器1 HTML 預覽:', container1.innerHTML.substring(0, 200) + '...')
        }
        
        if (container2) {
          // console.log('  容器2內容:', container2.innerHTML.length > 0 ? '有內容' : '空的')
          // console.log('  容器2 HTML 預覽:', container2.innerHTML.substring(0, 200) + '...')
        }
        
        // 檢查全域變數
        // console.log('🔧 全域變數狀態:')
        // console.log('  window.Product_Recommendation:', typeof window.Product_Recommendation)
        // console.log('  Brand:', typeof Brand !== 'undefined' ? Brand : '未定義')
        // console.log('  customEdm 長度:', typeof customEdm !== 'undefined' ? customEdm.length : '未定義')
        // console.log('  fakeData:', typeof fakeData !== 'undefined' ? '已定義' : '未定義')
        
        if (typeof fakeData !== 'undefined') {
          // console.log('  fakeData.personalized_recommendation.ctype_val:', fakeData.personalized_recommendation?.ctype_val)
          // console.log('  fakeData.more_recommendation.ctype_val:', fakeData.more_recommendation?.ctype_val)
        }
        
        // 檢查 embedded.js 是否載入
        const embeddedScript = document.querySelector('script[src="./embedded.js"]')
        // console.log('📜 embedded.js:', embeddedScript ? '已載入' : '未載入')
        
        // console.log('✅ 檢查完成！')
      }
      
      // 強制重新載入推薦的函式
      window.forceReloadRecommendations = function() {
        // console.log('🔄 強制重新載入推薦...')
        
        if (typeof window.Product_Recommendation === 'undefined') {
          console.error('❌ Product_Recommendation 函式不存在！請確認 embedded.js 已載入')
          return
        }
        
        // 直接重新載入推薦
        const defaultBid = {
          HV: '180',
          WV: '100',
          CC: '97.5_97.5',
          DataItem: '0100',
          Shoulder: '',
          UpChest: '',
          DnChest: '',
          Waist: '',
          Hip: '',
          Brand: Brand,
          ClothID: '',
          Sizes: '',
          FitP: '0,0,0,0',
          Gender: 'M',
          FMLpath: 'FMLSep',
          BUS: '0',
          GVID: '',
          LGVID: '',
          MRID: 'INF',
          ga_id: 'x',
          Pattern_Prefer: '1'
        }
        
        updateProductRecommendationBid('personalized-recommendations', defaultBid)
        updateProductRecommendationBid('more-recommendations', defaultBid)
      }
      
      // console.log('🔍 調試工具已載入！使用:')
      // console.log('  debugRecommendations() - 檢查推薦狀態') 
      // console.log('  forceReloadRecommendations() - 強制重載推薦')
      // console.log('  testBidUpdate() - 測試 bid 更新')
      // console.log('  testBidUpdate("slim") - 測試瘦身形')
      // console.log('  testBidUpdate("regular") - 測試標準身形') 
      // console.log('  testBidUpdate("large") - 測試大身形')
      // console.log('  updateMailSectionImages() - 手動更新 mail-section 圖片')
      // console.log('  debugImageSelectors() - 檢查所有圖片選擇器')
      // console.log('💡 注意：更新後請等待 2-3 秒查看結果！')
      
      // 調試函式：檢查推薦區塊中的所有圖片元素
      function debugImageSelectors() {
        // console.log('🔍 開始檢查所有可能的圖片選擇器...')
        
        const selectors = [
          '#personalized-recommendations img',
          '#personalized-recommendations .embeddedItem img', 
          '#personalized-recommendations .embeddedItem__img img',
          '#personalized-recommendations .embeddedItem__imgBox img',
          '#personalized-recommendations .swiper-slide img',
          '#more-recommendations img',
          '#more-recommendations .embeddedItem img',
          '#more-recommendations .embeddedItem__img img', 
          '#more-recommendations .embeddedItem__imgBox img',
          '#more-recommendations .swiper-slide img'
        ]
        
        selectors.forEach(selector => {
          const elements = document.querySelectorAll(selector)
          // console.log(`🎯 選擇器 "${selector}": 找到 ${elements.length} 個元素`)
          elements.forEach((img, index) => {
            if (index < 3) { // 只顯示前3個
              console.log(`  第${index + 1}個: ${img.src}`)
            }
          })
        })
        
        // 檢查整個容器的 HTML 結構
        const personalizedContainer = document.getElementById('personalized-recommendations')
        if (personalizedContainer) {
          // console.log('📋 personalized-recommendations 完整 HTML:')
          // console.log(personalizedContainer.innerHTML)
        }
      }
      
      // 加到 window 對象供測試使用
      window.debugImageSelectors = debugImageSelectors
      
      // 新增：監聽推薦區塊圖片變化的 MutationObserver
      function startImageObserver(maxRetries = 10) {
        // console.log('🔍 開始監聽推薦區塊圖片變化...')
        
        const personalizedContainer = document.getElementById('personalized-recommendations')
        const moreContainer = document.getElementById('more-recommendations')
        
        if (!personalizedContainer && !moreContainer) {
          if (maxRetries > 0) {
            // console.warn(`⚠️ 找不到推薦容器，將在 1 秒後重試... (剩餘重試次數: ${maxRetries})`)
            setTimeout(() => startImageObserver(maxRetries - 1), 1000)
          } else {
            console.error('❌ 無法找到推薦容器，停止重試')
          }
          return
        }
        
        // 建立 MutationObserver 來監聽 DOM 變化
        const observer = new MutationObserver((mutations) => {
          let imageChanged = false
          
          mutations.forEach((mutation) => {
            // 監聽屬性變化（src 變化）
            if (mutation.type === 'attributes' && mutation.attributeName === 'src') {
              const img = mutation.target
              if (img.tagName === 'IMG' && 
                  (img.closest('#personalized-recommendations') || img.closest('#more-recommendations'))) {
                // console.log('🖼️ 監聽到圖片 src 變化:', img.src)
                imageChanged = true
              }
            }
            
            // 監聽子節點變化（新增圖片元素）
            if (mutation.type === 'childList') {
              const hasNewImages = Array.from(mutation.addedNodes).some(node => {
                if (node.nodeType === Node.ELEMENT_NODE) {
                  // 檢查新增的節點是否包含圖片
                  const imgs = node.querySelectorAll ? node.querySelectorAll('img') : []
                  return imgs.length > 0 || node.tagName === 'IMG'
                }
                return false
              })
              
              if (hasNewImages) {
                // console.log('🖼️ 監聽到新增圖片元素')
                imageChanged = true
              }
            }
          })
          
          // 如果有圖片變化，延遲 500ms 後更新 mail-section（避免頻繁觸發）
          if (imageChanged && typeof updateMailSectionImages === 'function') {
            // console.log('🔄 圖片有變化，將在 500ms 後更新 mail-section...')
            setTimeout(() => {
              updateMailSectionImages()
            }, 500)
          }
        })
        
        // 開始監聽兩個推薦容器
        const observerConfig = {
          childList: true,      // 監聽子節點變化
          subtree: true,        // 監聽所有後代節點
          attributes: true,     // 監聽屬性變化
          attributeFilter: ['src'] // 只監聽 src 屬性
        }
        
        if (personalizedContainer) {
          observer.observe(personalizedContainer, observerConfig)
          // console.log('✅ 開始監聽 personalized-recommendations 容器')
        }
        
        if (moreContainer) {
          observer.observe(moreContainer, observerConfig)
          // console.log('✅ 開始監聽 more-recommendations 容器')
        }
        
        // 初始更新一次（如果已有內容）
        setTimeout(() => {
          const hasImages = document.querySelectorAll('#personalized-recommendations .embeddedItem__imgBox img, #more-recommendations .embeddedItem__imgBox img').length > 0
          if (hasImages && typeof updateMailSectionImages === 'function') {
            // console.log('🖼️ 初始化更新 mail-section 圖片...')
            updateMailSectionImages()
          }
        }, 1000)
        
        // console.log('✅ 圖片監聽器設置完成！')
      }
      
      // 加到 window 對象供全域使用
      window.startImageObserver = startImageObserver

      // LIFF 初始化與優惠訊息發送功能
      let liffId = '2008576354-nwJ6w230' // 請替換為您的 LIFF App ID
      let liffInitialized = false

      // 初始化 LIFF
      async function initLiff() {
        if (liffInitialized) {
          console.log('ℹ️ LIFF 已經初始化過了')
          return true
        }
        
        try {
          // 如果沒有設定 LIFF ID，嘗試從 URL 參數或環境變數取得
          if (!liffId) {
            const params = new URLSearchParams(window.location.search)
            liffId = params.get('liffId') || null
          }

          if (!liffId) {
            console.error('❌ 未設定 LIFF ID')
            console.error('請在代碼中設定 liffId 變數，或在 URL 中加上 ?liffId=YOUR_LIFF_ID')
            return false
          }

          console.log('🔑 使用 LIFF ID:', liffId)
          
          await liff.init({ liffId: liffId })
          liffInitialized = true
          
          console.log('✅ LIFF 初始化成功')
          console.log('📱 LIFF SDK 版本:', liff.getVersion())
          console.log('🌐 執行環境:', liff.isInClient() ? 'LINE App' : '外部瀏覽器')
          console.log('🔐 登入狀態:', liff.isLoggedIn() ? '已登入' : '未登入')
          
          return true
        } catch (error) {
          console.error('❌ LIFF 初始化失敗:', error)
          console.error('錯誤詳情:', {
            name: error.name,
            message: error.message,
            code: error.code
          })
          
          if (error.message.includes('404')) {
            console.error('💡 提示：LIFF ID 可能不存在或未啟用')
          } else if (error.message.includes('401')) {
            console.error('💡 提示：LIFF ID 驗證失敗')
          }
          
          return false
        }
      }

      // 取得 LIFF 使用者 UID 並發送 Flex Message
      async function sendLiffPromoMessage() {
        const btn = document.getElementById('liffPromoBtn')
        
        // 防止重複點擊
        if (btn.disabled) return
        
        // 設置載入狀態
        btn.disabled = true
        btn.classList.add('liff-promo-btn--loading')

        try {
          console.log('🚀 開始發送優惠訊息...')
          
          // 初始化 LIFF
          console.log('1️⃣ 初始化 LIFF...')
          const initialized = await initLiff()
          if (!initialized) {
            throw new Error('LIFF 初始化失敗，請確認 LIFF ID 是否正確')
          }
          console.log('✅ LIFF 初始化成功')

          // 檢查是否在 LINE 環境中
          console.log('2️⃣ 檢查 LINE 環境...')
          if (!liff.isInClient()) {
            console.warn('⚠️ 不在 LINE 應用程式中，但允許測試')
            // 在開發環境下，允許繼續測試（移除 return）
            // alert('此功能僅在 LINE 應用程式中可用')
            // btn.disabled = false
            // btn.classList.remove('liff-promo-btn--loading')
            // return
          }
          console.log('✅ 環境檢查通過')

          // 取得使用者資訊
          console.log('3️⃣ 取得使用者資訊...')
          const profile = await liff.getProfile()
          const userId = profile.userId
          console.log('✅ 取得使用者 UID:', userId)

          // 取得優惠商品資料（從 sessionStorage 或 API）
          console.log('4️⃣ 取得優惠商品資料...')
          const promoProducts = getPromoProducts()
          console.log('✅ 商品資料:', promoProducts)

          // 發送 Flex Message
          console.log('5️⃣ 發送 Flex Message 到 Google Apps Script...')
          await sendFlexMessage(userId, promoProducts)

          // 顯示成功訊息
          console.log('✅ 全部完成！')
          showLiffSuccessAlert()

        } catch (error) {
          console.error('❌ 發送優惠訊息失敗:', error)
          console.error('❌ 錯誤詳情:', {
            message: error.message,
            stack: error.stack
          })
          
          // 顯示更詳細的錯誤訊息
          let errorMessage = '發送失敗：' + error.message
          if (error.message.includes('LIFF')) {
            errorMessage += '\n\n請確認 LIFF ID 是否正確'
          } else if (error.message.includes('API') || error.message.includes('fetch')) {
            errorMessage += '\n\n無法連接到伺服器，請檢查網路連線'
          } else if (error.message.includes('LINE API')) {
            errorMessage += '\n\n請確認 LINE Channel Access Token 是否有效'
          }
          
          alert(errorMessage)
        } finally {
          // 恢復按鈕狀態
          btn.disabled = false
          btn.classList.remove('liff-promo-btn--loading')
        }
      }

      // 取得優惠商品資料
      function getPromoProducts() {
        // 嘗試從 sessionStorage 取得商品資料
        const edmItems = JSON.parse(sessionStorage.getItem('inf-ai-edm-items') || '[]')
        
        // 如果沒有資料，使用預設商品
        if (edmItems.length === 0) {
          return [
            {
              name: '精選商品 1',
              price: 'NT$ 1,280',
              imageUrl: 'https://placehold.co/300x300',
              link: '#'
            },
            {
              name: '精選商品 2',
              price: 'NT$ 1,580',
              imageUrl: 'https://placehold.co/300x300',
              link: '#'
            }
          ]
        }

        // 轉換為 Flex Message 格式
        return edmItems.slice(0, 4).map(item => ({
          name: item.name || item.title || '精選商品',
          price: item.sale_price ? `NT$ ${item.sale_price}` : '價格請洽詢',
          imageUrl: item.image_link || item.image || 'https://placehold.co/300x300',
          link: item.link || item.url || '#'
        }))
      }

      // 發送 Flex Message 到後端 API
      async function sendFlexMessage(userId, products) {
        // 建立 Flex Message JSON
        const flexMessage = createFlexMessage(products)
        console.log('📤 準備發送的 Flex Message:', flexMessage)

        // 發送到 Google Apps Script Web App
        // API 文檔：https://script.google.com/macros/s/AKfycbyO2HmHaQu_vcRiemSbWlJ0ZvH2OnLizJoMu3lhTRyrcTasvuMAj1w5cd0ucL2RLyDSFw/exec
        const apiEndpoint = 'https://script.google.com/macros/s/AKfycbyO2HmHaQu_vcRiemSbWlJ0ZvH2OnLizJoMu3lhTRyrcTasvuMAj1w5cd0ucL2RLyDSFw/exec'
        
        console.log('📡 API 端點:', apiEndpoint)
        console.log('👤 User ID:', userId)
        
        try {
          const requestBody = {
            userId: userId,
            messages: [flexMessage]
          }
          console.log('📦 請求內容:', requestBody)
          
          const response = await fetch(apiEndpoint, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestBody)
          })

          console.log('📨 回應狀態:', response.status, response.statusText)
          
          // Google Apps Script 可能返回 text/plain，需要轉換
          const responseText = await response.text()
          console.log('📄 回應內容:', responseText)
          
          let result

          try {
            result = JSON.parse(responseText)
          } catch (e) {
            // 如果無法解析為 JSON，可能是錯誤訊息
            console.error('❌ JSON 解析失敗:', e)
            throw new Error('API 回應格式錯誤: ' + responseText.substring(0, 100))
          }

          // 檢查 Google Apps Script 返回的成功狀態
          if (!result.success) {
            console.error('❌ API 回應失敗:', result)
            throw new Error('LINE API 錯誤: ' + (result.error || '發送失敗'))
          }

          console.log('✅ Flex Message 發送成功:', result)
          return result
        } catch (error) {
          console.error('❌ 發送 Flex Message 時發生錯誤:', error)
          
          // 提供更具體的錯誤訊息
          if (error.message.includes('Failed to fetch')) {
            throw new Error('網路連線失敗，無法連接到 Google Apps Script API')
          } else if (error.message.includes('LINE API')) {
            throw new Error(error.message)
          } else {
            throw new Error('發送失敗: ' + error.message)
          }
        }
      }

      // 建立 Flex Message JSON
      function createFlexMessage(products) {
        const bubbles = products.map(product => ({
          type: 'bubble',
          hero: {
            type: 'image',
            url: product.imageUrl,
            size: 'full',
            aspectRatio: '1:1',
            aspectMode: 'cover'
          },
          body: {
            type: 'box',
            layout: 'vertical',
            contents: [
              {
                type: 'text',
                text: product.name,
                weight: 'bold',
                size: 'md',
                wrap: true
              },
              {
                type: 'text',
                text: product.price,
                size: 'xl',
                color: '#00C300',
                weight: 'bold',
                margin: 'md'
              }
            ]
          },
          footer: {
            type: 'box',
            layout: 'vertical',
            spacing: 'sm',
            contents: [
              {
                type: 'button',
                style: 'primary',
                height: 'sm',
                action: {
                  type: 'uri',
                  label: '查看商品',
                  uri: product.link
                },
                color: '#00C300'
              }
            ]
          }
        }))

        return {
          type: 'flex',
          altText: '最新優惠商品資訊',
          contents: {
            type: 'carousel',
            contents: bubbles
          }
        }
      }

      // 顯示成功提示
      function showLiffSuccessAlert() {
        // 使用現有的 showSendAlert 函數
        if (typeof showSendAlert === 'function') {
          // 暫時保存原始函數行為，但針對 LIFF 成功訊息不影響郵件按鈕
          const originalShowSendAlert = showSendAlert
          
          // 建立自訂的 alert 顯示邏輯（不影響郵件按鈕）
          const alert = document.getElementById('sendAlert')
          if (!alert) {
            alert('優惠資訊已發送！請查看您的 LINE 訊息')
            return
          }

          const alertConfig = {
            'liff-promo-success': {
              style: {
                background: 'rgba(0, 195, 0, 0.10)',
                border: '1px solid rgba(0, 195, 0, 0.40)',
                boxShadow:
                  '0px 71px 20px 0px rgba(0, 0, 0, 0.00), 0px 45px 18px 0px rgba(0, 0, 0, 0.01), 0px 25px 15px 0px rgba(0, 0, 0, 0.05), 0px 11px 11px 0px rgba(0, 0, 0, 0.09), 0px 3px 6px 0px rgba(0, 0, 0, 0.10)',
                backdropFilter: 'blur(12px)',
                color: '#00C300'
              },
              icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
                <path d="M5 12L10 17L20 7" stroke="#00C300" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>`,
              message: '優惠資訊已發送！請查看您的 LINE 訊息'
            }
          }

          const config = alertConfig['liff-promo-success']
          
          // 更新彈窗內容
          alert.innerHTML = `
            ${config.icon}
            <div>${config.message}</div>
            <span class="close-send-alert" onclick="closeLiffAlert()">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
                <g clip-path="url(#clip0_5970_16761)">
                  <path d="M12 24C15.1826 24 18.2348 22.7357 20.4853 20.4853C22.7357 18.2348 24 15.1826 24 12C24 8.8174 22.7357 5.76516 20.4853 3.51472C18.2348 1.26428 15.1826 0 12 0C8.8174 0 5.76516 1.26428 3.51472 3.51472C1.26428 5.76516 0 8.8174 0 12C0 15.1826 1.26428 18.2348 3.51472 20.4853C5.76516 22.7357 8.8174 24 12 24ZM8.20312 8.20312C8.64375 7.7625 9.35625 7.7625 9.79219 8.20312L11.9953 10.4062L14.1984 8.20312C14.6391 7.7625 15.3516 7.7625 15.7875 8.20312C16.2234 8.64375 16.2281 9.35625 15.7875 9.79219L13.5844 11.9953L15.7875 14.1984C16.2281 14.6391 16.2281 15.3516 15.7875 15.7875C15.3469 16.2234 14.6344 16.2281 14.1984 15.7875L11.9953 13.5844L9.79219 15.7875C9.35156 16.2281 8.63906 16.2281 8.20312 15.7875C7.76719 15.3469 7.7625 14.6344 8.20312 14.1984L10.4062 11.9953L8.20312 9.79219C7.7625 9.35156 7.7625 8.63906 8.20312 8.20312Z" fill="black" fill-opacity="0.16"/>
                </g>
                <defs>
                  <clipPath id="clip0_5970_16761">
                    <rect width="24" height="24" fill="white" />
                  </clipPath>
                </defs>
              </svg>
            </span>
          `

          // 套用樣式
          Object.assign(alert.style, config.style)

          // 顯示動畫
          alert.classList.remove('hiding')
          alert.style.display = 'flex'
          alert.classList.add('showing')
        } else {
          alert('優惠資訊已發送！請查看您的 LINE 訊息')
        }
      }

      // 關閉 LIFF 提示
      function closeLiffAlert() {
        const alert = document.getElementById('sendAlert')
        if (!alert) return
        
        alert.classList.remove('showing')
        alert.classList.add('hiding')
        alert.addEventListener(
          'animationend',
          () => {
            alert.style.display = 'none'
            alert.classList.remove('hiding')
          },
          { once: true }
        )
      }

      // 將函數加到 window 對象供全域使用
      window.sendLiffPromoMessage = sendLiffPromoMessage
      window.initLiff = initLiff
      window.closeLiffAlert = closeLiffAlert

      // 頁面載入時自動初始化 LIFF（可選）
      // window.addEventListener('DOMContentLoaded', () => {
      //   initLiff()
      // })
    </script>
  </body>
</html>
